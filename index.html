<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Engineer Attendance (Google Sign-In)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <style>
    .centered { margin: 50px auto; max-width: 430px; }
    #map { height: 300px; margin-top: 20px; }
    #camera-section, #job-details { display: none; }
    #photo-preview { max-width: 100%; margin-top: 10px; }
    #action-alert { min-height: 35px; }
  </style>
  <!-- Google Identity Services for Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-light">
<div class="container">
  <!-- Google Sign-In Box -->
  <div id="login-box" class="centered bg-white p-4 rounded shadow text-center">
    <h3 class="mb-4">Employee Google Sign-In</h3>
    <div id="g_id_onload"
         data-client_id="941118062803-ugsnlabullmfqaccncvj181j08rb73mb.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleGoogleLogin"
         data-auto_select="true"
         data-itp_support="true"></div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="pill"
         data-theme="outline"
         data-text="signin_with"
         data-size="large"
         data-logo_alignment="left">
    </div>
    <div id="login-alert" class="alert alert-danger d-none mt-3"></div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="centered bg-white p-4 rounded shadow d-none" aria-live="polite">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>Welcome, <span id="user-name"></span></h5>
      <button id="logout" class="btn btn-sm btn-danger">Logout</button>
    </div>
    <div>
      <b>Job History</b>
      <table class="table table-striped" id="jobs-table" aria-describedby="jobHistoryDesc">
        <caption id="jobHistoryDesc" class="visually-hidden">List of jobs with entry and exit timestamps</caption>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Job</th>
            <th scope="col">Entry</th>
            <th scope="col">Exit</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <hr />
    <div id="job-details" aria-live="assertive">
      <label for="pac-input"><b>Search Site Address or Place</b></label>
      <input class="form-control mb-2" type="text" id="pac-input" autocomplete="off" placeholder="Search site address or place" aria-label="Search site address or place"/>
      <div id="map" role="region" aria-label="Google Map showing selected location"></div>
      <button class="btn btn-success mt-3" id="checkin-btn">Mark Entry</button>
      <button class="btn btn-secondary mt-2" id="checkout-btn">Mark Exit</button>
      <div class="alert alert-info mt-3 d-none" id="action-alert" role="alert"></div>
    </div>
    <div id="camera-section" aria-live="assertive">
      <video id="video" width="100%" autoplay playsinline aria-label="Camera viewfinder"></video>
      <button id="snap-btn" class="btn btn-primary mt-2">Capture Photo</button>
      <canvas id="canvas" style="display: none;"></canvas>
      <img id="photo-preview" src="" alt="Captured photo preview" class="mt-2"/>
    </div>
  </div>
</div>

<!-- Google Maps + Places API -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&libraries=places"
  defer>
</script>

<script>
  // Attendance data kept in session only (lost on refresh)
  let jobs = [];

  let userProfile = null;      // name, email, picture, etc.
  let map, marker, selectedPlace = null;
  let entryPhoto = "", exitPhoto = "", entryTime = "", exitTime = "";

  // Google sign-in callback
  function handleGoogleLogin(response) {
    try {
      const jwt = response.credential;
      const payload = JSON.parse(atob(jwt.split('.')[1]));
      // Example: payload.name, payload.email, payload.picture...
      userProfile = {
        name: payload.name,
        email: payload.email,
        picture: payload.picture || ""
      };

      document.getElementById("login-box").style.display = "none";
      document.getElementById("dashboard").classList.remove("d-none");
      document.getElementById("user-name").innerText = payload.name;
      refreshJobs();
      $("#job-details").show();
      setTimeout(initMap, 300); // slight delay to ensure dom loaded
    } catch (e) {
      $("#login-alert").removeClass("d-none").text("Google sign-in failed. Please refresh & retry.");
    }
  }

  $("#logout").click(function () {
    userProfile = null;
    jobs = [];
    selectedPlace = null;
    entryPhoto = "";
    exitPhoto = "";
    entryTime = "";
    exitTime = "";
    $("#dashboard").addClass("d-none");
    $("#login-box").show();
    $("#login-alert").addClass("d-none").text("");
    $("#pac-input").val("");
    if (marker) { marker.setMap(null); marker = null; }
    if (map) { map = null; }
    $("#action-alert").addClass("d-none").text("");
    $("#camera-section").hide();
    $("#job-details").show();
  });

  // Populate jobs list in dashboard
  function refreshJobs() {
    let rows = "";
    if (jobs.length === 0) {
      rows = `<tr><td colspan="4" class="text-center text-muted">No job records found.</td></tr>`;
    } else {
      jobs.forEach((j, i) =>
        rows += `<tr>
            <td>${i + 1}</td>
            <td>${escapeHtml(j.place)}</td>
            <td>${j.entryTime || "--"}</td>
            <td>${j.exitTime || "--"}</td>
          </tr>`
      );
    }
    $("#jobs-table tbody").html(rows);
  }
  function escapeHtml(text) {
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
  }
  // Google Maps API and Places SearchBox
  function initMap() {
    const defaultCenter = { lat: 28.61, lng: 77.23 };
    const mapElement = document.getElementById("map");
    if (!mapElement) return;
    map = new google.maps.Map(mapElement, {
      center: defaultCenter,
      zoom: 12,
      streetViewControl: false,
      fullscreenControl: true,
    });
    const input = document.getElementById("pac-input");
    const searchBox = new google.maps.places.SearchBox(input);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
    map.addListener("bounds_changed", () => searchBox.setBounds(map.getBounds()));
    searchBox.addListener("places_changed", () => {
      const places = searchBox.getPlaces();
      if (!places || places.length === 0) {
        selectedPlace = null;
        if (marker) { marker.setMap(null); marker = null; }
        return;
      }
      selectedPlace = places[0];
      if (marker) { marker.setMap(null); marker = null; }
      marker = new google.maps.Marker({
        map: map,
        position: selectedPlace.geometry.location,
        title: selectedPlace.name,
      });
      map.panTo(selectedPlace.geometry.location);
      map.setZoom(16);
      $("#action-alert").addClass("d-none").text("");
    });
  }
  // Haversine formula for distance (in meters)
  function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // meters
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
      Math.cos((lat2 * Math.PI) / 180) *
      Math.sin(dLon / 2) *
      Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
  // Show alert info/error
  function showAlert(msg, isError = false) {
    $("#action-alert")
      .removeClass("d-none alert-info alert-danger")
      .addClass(isError ? "alert-danger" : "alert-info")
      .text(msg);
  }
  // Open Camera, take picture, save (entry/exit)
  function openCamera(type) {
    $("#job-details").hide();
    $("#camera-section").show();
    $("#photo-preview").attr("src", "");
    const video = document.getElementById("video");
    if (video.srcObject) {
      video.srcObject.getTracks().forEach((track) => track.stop());
      video.srcObject = null;
    }
    navigator.mediaDevices
      .getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        video.srcObject = stream;
        video.play();
        $("#snap-btn").off("click").on("click", function () {
          const canvas = document.getElementById("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imgData = canvas.toDataURL("image/png");
          $("#photo-preview").attr("src", imgData);
          stream.getTracks().forEach((t) => t.stop());
          if (type === "entry") entryPhoto = imgData;
          else if (type === "exit") exitPhoto = imgData;
          setTimeout(() => finishAttendance(type), 500);
        });
      })
      .catch(() => {
        showAlert("Camera access denied! Cannot capture photo.", true);
        $("#camera-section").hide();
        $("#job-details").show();
      });
  }
  // Finish attendance marking & save job record on exit
  function finishAttendance(type) {
    $("#camera-section").hide();
    $("#job-details").show();
    if (type === "entry") {
      showAlert("Entry marked and photo captured.");
    }
    if (type === "exit") {
      showAlert("Exit marked and photo captured.");
      jobs.push({
        place: selectedPlace.name || "Unknown Place",
        entryTime: entryTime,
        exitTime: exitTime,
        entryPhoto: entryPhoto,
        exitPhoto: exitPhoto
      });
      refreshJobs();
      entryTime = "";
      exitTime = "";
      entryPhoto = "";
      exitPhoto = "";
      selectedPlace = null;
      $("#pac-input").val("");
      if (marker) { marker.setMap(null); marker = null; }
    }
  }
  // Check-in button
  $("#checkin-btn").click(function () {
    if (!selectedPlace) {
      showAlert("Please select a place using the search bar first!", true);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const clat = pos.coords.latitude;
        const clng = pos.coords.longitude;
        const plat = selectedPlace.geometry.location.lat();
        const plng = selectedPlace.geometry.location.lng();
        const dist = getDistanceFromLatLonInMeters(clat, clng, plat, plng);
        if (dist <= 100) {
          entryTime = new Date().toLocaleString();
          $("#action-alert").addClass("d-none");
          openCamera("entry");
        } else {
          showAlert("You are NOT within 100 meters of the selected site.", true);
        }
      },
      () => showAlert("Location access denied!", true),
      { enableHighAccuracy: true }
    );
  });
  // Check-out button
  $("#checkout-btn").click(function () {
    if (!selectedPlace) {
      showAlert("Please select a place using the search bar first!", true);
      return;
    }
    if (!entryTime) {
      showAlert("You must mark entry before marking exit!", true);
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const clat = pos.coords.latitude;
        const clng = pos.coords.longitude;
        const plat = selectedPlace.geometry.location.lat();
        const plng = selectedPlace.geometry.location.lng();
        const dist = getDistanceFromLatLonInMeters(clat, clng, plat, plng);
        if (dist <= 100) {
          exitTime = new Date().toLocaleString();
          $("#action-alert").addClass("d-none");
          openCamera("exit");
        } else {
          showAlert("You are NOT within 100 meters of the selected site.", true);
        }
      },
      () => showAlert("Location access denied!", true),
      { enableHighAccuracy: true }
    );
  });
</script>
</body>
</html>
