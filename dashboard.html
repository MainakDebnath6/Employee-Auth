<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@500;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&libraries=places"></script>
<style>
  :root {
  --primary: #334bf9;
  --secondary: #43bfff;
  --accent: #6da9ff;
  --dark-bg1: #191d29;
  --dark-bg2: #273970;
  --card-bg: #222a4b;
  --card-bg-hover: #2c4478;
  --admin-user-hover: #2a4dab;
  --admin-bg: #1a2340;
  --text-light: #d1d4dc;
  --text-mid: #a8c5ff;
  --text-accent: #43bfff;
  --success: #69e07b;
  --warning: #f1da65;
  --error: #e46d78;
  --shadow: 0 8px 32px 0 #2848bb60;
  --soft-shadow: 0 1px 8px 0 #00193360;
  --section-gradient: linear-gradient(115deg, #191d29 30%, #273970 120%);
  --admin-gradient: linear-gradient(115deg, #1a2340, #28356c);
}

body {
  font-family: 'Urbanist', sans-serif;
  background: linear-gradient(120deg, #0e141f 0%, #1b2233 100%);
  color: var(--text-light);
  min-height: 100vh;
}

.navbar {
  background: linear-gradient(90deg, #1c1f32, #23355a 90%);
  box-shadow: var(--soft-shadow);
}

.nav-link {
  color: var(--text-light) !important;
  border-radius: 10px;
  padding: 0.6rem 1.1rem;
  margin-right: 6px;
  transition: background 0.2s, color 0.2s, box-shadow 0.3s;
  font-weight: 700;
  font-size: 1.05rem;
}
.nav-link.active, .nav-link:hover {
  color: var(--accent) !important;
  background: var(--card-bg-hover);
  box-shadow: 0 2px 12px var(--accent)38;
}

.navbar-toggler { border-color: var(--accent);}
.navbar-toggler-icon { filter: brightness(0.8) invert(1); }

.section {
  display: none;
  opacity: 0;
  transition: opacity 0.5s cubic-bezier(.23,1.16,.64,1);
}
.section.active {
  display: block;
  opacity: 1;
  animation: fadein-1 1s;
}
@keyframes fadein-1 { from { opacity: 0; } to { opacity: 1; } }

#container-main {
  max-width: 1100px;
  margin: 2rem auto;
  padding: 2rem;
  background: rgba(23,29,52,.98);
  border-radius: 28px;
  box-shadow: var(--shadow);
  backdrop-filter: blur(2px);
}

.section-card {
  background: var(--section-gradient);
  border-radius: 24px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--soft-shadow);
  animation: cardin 1.3s;
}
@keyframes cardin {
  from { opacity: .3; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1);}
}

.section-title {
  font-size: 1.55rem;
  font-weight: 800;
  color: var(--secondary);
  margin-bottom: 1.1rem;
  text-shadow: 0 2px 22px var(--accent)33;
  letter-spacing: 1px;
  display: flex; align-items: center; gap: 8px;
}

#map-wrapper {
  position: relative;
  height: 330px;
  border-radius: 18px;
  margin-bottom: 1.2rem;
  background: #1a2030;
  box-shadow: 0 2px 16px #232b5066;
  overflow: hidden;
}
#pac-input {
  position: absolute;
  top: 18px;
  left: 50%;
  transform: translateX(-50%);
  width: 92%;
  max-width: 520px;
  padding: 0.7rem 1.4rem;
  border-radius: 14px;
  border: 1.7px solid var(--accent);
  background: #28376f;
  color: #d9e2ff;
  font-size: 1.1rem;
  z-index: 10;
  box-shadow: 0 4px 18px #1178ffd5;
}

#map {
  width: 100%;
  height: 100%;
  border-radius: 18px;
}

/* FIXED: Cards are visible (opacity:1) and no unwanted fade-out */
.attendance-card {
  background: linear-gradient(110deg, #23294b 86%, #202038 98%);
  border-radius: 16px;
  margin-bottom: 0.7rem;
  padding: 0.7rem 1.1rem;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  opacity: 1; /* was 0 – set to 1 so always visible */
  box-shadow: 0 2px 12px #3840c022;
  transition: transform .2s, box-shadow .2s;
}

.attendance-card:hover {
  transform: scale(1.03);
  background: linear-gradient(120deg, var(--primary) 8%, var(--accent) 90%);
  color: #fff;
  box-shadow: 0 6px 32px #334bf9cc;
}

.status-dot {
  width: 16px; height: 16px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 4px;
  box-shadow: 0 0 4px #fff3;
}
.completed { background: var(--success); }
.pending { background: var(--warning); }

.card-summary {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  cursor:pointer;
  min-height:38px;
}

.card-place {
  font-weight: 700;
  font-size: 1.09rem;
  color: var(--accent);
  flex-grow: 1;
  word-break: break-word;
  text-shadow: 0 2px 9px #367af626;
}

.card-date {
  font-size: .96rem;
  opacity: .8;
  font-weight: 600;
  letter-spacing: .5px;
  white-space: nowrap;
}

.photo-label {
  font-size: .84rem;
  font-weight: 700;
  color: #c0dcfa;
  text-align: center;
  margin-top: 0.2rem;
  letter-spacing: .03em;
}

.time-label {
  font-weight: 600;
  font-size: .95rem;
  color: #bbe3fa;
  margin-top: 0.36rem;
  margin-bottom: .1rem;
  text-shadow: 0 1px 9px #68a8e233;
}

.expand-icon {
  color: var(--accent);
  font-size: 1.3rem;
  align-self: center;
  transition: transform .2s;
}

.record-details {
  display: none;
  margin-top: .6rem;
  border-top: 1px solid #334bf966;
  padding-top: .6rem;
  background: #23294b44;
  border-radius: 0 0 11px 11px;
  animation: fadein-1 .4s;
}

.delete-record-btn {
  margin-left: 10px;
  font-size:.96rem;
}

#action-alert {
  font-weight: 600;
  min-height: 35px;
  border-radius: 13px;
  background: #2434aa26;
  border: 2px solid #5e73d2bb;
  color: #bedeff;
  margin-top: 1rem;
  padding: 0.45rem 1.1rem;
  text-align: center;
  opacity: 0;
  font-size: 1.09rem;
  transition: opacity 0.32s cubic-bezier(.23,1.16,.64,1);
  box-shadow: 0 2px 12px #334bf966;
}

#camera-overlay {
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: #000c;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  animation: fade-bg .5s;
}
@keyframes fade-bg{ from{ opacity: 0;} to{ opacity: 1;}}

#camera-controls {
  margin-top: 1rem;
  display: flex; gap: 1rem; justify-content: center;
}

#camera-controls .btn {
  font-size: 1.1rem;
  border-radius: 11px;
  padding: 0.45rem 1.2rem;
  box-shadow: 0 1px 8px #485cc666;
  border: none;
}

/* Admin list styling ... (unchanged from original) */
.admin-user-row {
  cursor: pointer;
  font-weight: 700;
  text-shadow: 0 1px 6px #2848bb55;
  transition: background 0.22s, color 0.22s, box-shadow 0.22s;
  word-break: break-word;
  background: linear-gradient(90deg, #29387c 0%, #232d4d 90%);
  border-radius: 13px;
  border: none;
  color: var(--text-mid);
  margin-bottom: 6px;
  padding: 13px 18px;
  box-shadow: 0 2px 12px #23355a22;
  position: relative;
  outline: none;
}
.admin-user-row:hover, .admin-user-row:focus {
  background: var(--admin-user-hover);
  color: #fff;
  outline: none;
  box-shadow: 0 0 18px #658fe333;
}
.admin-user-row:active::after {
  content:'';
  position: absolute; left:0; right:0; bottom:0; top:0;
  border-radius: 13px;
  background: #5d87e680;
  opacity: .17;
  pointer-events: none;
}
.list-group-item {
  padding: 10px 15px;
  background: none;
  border: none;
}

#admin-users-list {
  max-height: 330px;
  overflow-y: auto;
  background: var(--admin-gradient);
  border-radius: 18px;
  padding: 0.5rem;
  margin-bottom: 1rem;
  box-shadow: 0 1px 8px #2341a166;
}

#admin-export {
  width: 100%;
  max-width: 240px;
  font-weight: 700;
  border-radius: 13px;
  background: var(--accent);
  color: #21274a;
  box-shadow: 0 2px 18px var(--accent)33;
  transition: box-shadow .2s;
  margin-bottom: 1.3rem;
  margin-top: 0.7rem;
  font-size: 1.1rem;
}
#admin-export:hover, #admin-export:focus {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 6px 28px #334bf999;
}
#admin-user-details {
  background: linear-gradient(115deg, #19203a, #2a3f71);
  border-radius: 16px;
  padding: 1.1rem;
  color: #c2d6ff;
  box-shadow: 0 0 10px #284da866 inset;
  overflow-x: auto;
  font-size: 1.05rem;
  margin-bottom: 1.5rem;
  animation: fadein-card .8s;
}

.admin-record-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 7px;
  margin-top: 0.9rem;
  margin-bottom: 0.5rem;
}
.admin-record-table th, .admin-record-table td {
  background: #2a3f71;
  border: none;
  padding: 11px 13px;
  text-align: center;
  border-radius: 8px;
  color: #b7c9ff;
  font-size: .99rem;
}
.admin-record-table th {
  background: #334bf9;
  color: #efe8ff;
  font-weight: 800;
  box-shadow: 0 2px 12px #334bf966;
}
.admin-record-table tr:hover td {
  background: var(--accent);
  color: var(--dark-bg1);
  transition: background 0.22s, color 0.22s;
}

#admin-issues-holder {
  background: linear-gradient(90deg,#273970 80%,#191d29 100%);
  border-radius: 14px;
  margin-top: 8px;
  margin-bottom: 18px;
  padding: .7rem 0.3rem;
  font-size: .96rem;
  box-shadow: 0 1px 10px #334bf933;
  overflow-x: auto
}
#admin-issues-holder table {
  margin-bottom: 0;
}

.profile-label {
  font-weight: 700;
  color: var(--accent);
}
.form-control {
  background: #212e56;
  color: #c9e6ff;
  border-radius: 14px;
  border: 1.5px solid #28376f;
  font-size: 1.08rem;
  box-shadow: 0 1px 6px #334bf931;
  margin-bottom: 6px;
}
.form-control:focus {
  background: #1c2759;
  color: #fff;
  border-color: var(--accent);
  box-shadow: 0 5px 18px var(--accent)38;
  outline: none;
}
#prof-email {
  background: linear-gradient(90deg, #1d2f5d, #2c3f78);
  color: #ffffff;
  font-weight: 700;
  text-shadow: 0 1px 4px #000a;
}

textarea#help-message {
  min-height: 74px;
}

#filter-select {
  background: #28376f;
  color: #d9e2ff;
  border: 1.7px solid var(--accent);
  font-weight: 700;
  border-radius: 14px;
  box-shadow: 0 1px 8px #334bf933;
  transition: background-color 0.3s, color 0.3s;
  min-width: 130px;
}
#filter-select option {
  background: #28376f;
  color: #d9e2ff;
  font-weight: 600;
}
#filter-select:focus {
  outline: none;
  border-color: var(--accent);
  background: #3657ed;
  color: #ffffff;
}

.d-flex.justify-content-center.gap-3.my-3 {
  flex-direction: column;
  gap: 11px;
}
.d-flex.justify-content-center.gap-3.my-3 button {
  width: 100%;
  max-width: 330px;
}

/* Custom Scrollbars */
#admin-users-list,
#admin-issues-holder,
#admin-user-details,
#attendance-cards {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) #1c2340;
}
#admin-users-list::-webkit-scrollbar,
#admin-issues-holder::-webkit-scrollbar,
#admin-user-details::-webkit-scrollbar,
#attendance-cards::-webkit-scrollbar {
  width: 10px;
}
#admin-users-list::-webkit-scrollbar-track,
#admin-issues-holder::-webkit-scrollbar-track,
#admin-user-details::-webkit-scrollbar-track,
#attendance-cards::-webkit-scrollbar-track {
  background: #1c2340;
}
#admin-users-list::-webkit-scrollbar-thumb,
#admin-issues-holder::-webkit-scrollbar-thumb,
#admin-user-details::-webkit-scrollbar-thumb,
#attendance-cards::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 8px;
}
#admin-users-list::-webkit-scrollbar-thumb:hover,
#admin-issues-holder::-webkit-scrollbar-thumb:hover,
#admin-user-details::-webkit-scrollbar-thumb:hover,
#attendance-cards::-webkit-scrollbar-thumb:hover {
  background: var(--secondary);
}

@media (max-width: 680px) {
  #container-main {padding: 0.7rem;margin: 0.7rem;border-radius: 17px;}
  .section-title { font-size: 1.24rem; }
  .section-card { padding: .65rem; border-radius: 16px;}
  #admin-users-list { max-height: none; padding: .3rem; margin-bottom: .6rem;}
  #admin-user-details { font-size: 1rem; padding: .7rem;}
  .admin-user-row { font-size: 1rem; padding: 16px 10px; margin-bottom: 9px; }
  #admin-export { font-size: 1.07rem; margin-bottom: 1rem; margin-top: .5rem;}
  .admin-record-table th, .admin-record-table td { padding: 9px 6px; font-size: .91rem;}
  #pac-input { max-width: 96%; font-size: .95rem; }
  #camera-overlay video { max-width: 97vw; }
  .d-flex.justify-content-center.gap-3.my-3 button { max-width: 100%; }
  .admin-record-table { font-size: .95rem;}
}

@media (max-width:480px){
  #container-main {padding: .4rem;}
  #admin-export { font-size: .98rem; }
  #pac-input { font-size: .91rem;}
  .admin-user-row {font-size: .98rem;}
  .card-date, .photo-label, .card-place { font-size: .92rem; }
}

</style>
</head>
<body>
<nav class="navbar navbar-expand-lg mb-3 shadow">
  <div class="container-fluid">
    <a class="navbar-brand text-light d-flex align-items-center gap-2" style="font-weight: 700;">
     <i class="bi bi-clock-history"></i> Attendance  
    </a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navMain" aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto mt-2 mt-lg-0">
        <li><a class="nav-link active" data-sec="dashboard"><i class="bi bi-map"></i> Dashboard</a></li>
        <li><a class="nav-link" data-sec="statistics"><i class="bi bi-bar-chart-line"></i> Statistics</a></li>
        <li><a class="nav-link" data-sec="profile"><i class="bi bi-person-circle"></i> Profile</a></li>
        <li class="admin-only"><a class="nav-link" data-sec="admin"><i class="bi bi-people"></i> Admin</a></li>
        <li><a class="nav-link" data-sec="help"><i class="bi bi-question-circle"></i> Help</a></li>
      </ul>
      <span id="user-name" class="text-light me-3"></span>
      <button id="logout" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div id="container-main">
<!-- Dashboard -->
<div class="section active" id="dashboard">
  <div class="section-card">
    <div class="section-title"><i class="bi bi-map"></i> Dashboard</div>
    <div id="map-wrapper">
      <input id="pac-input" placeholder="Search site or address"/>
      <div id="map"></div>
    </div>
    <div class="d-flex justify-content-center gap-3 my-3">
      <button id="checkin-btn" class="btn btn-success glow-on-hover"><i class="bi bi-box-arrow-in-right"></i> Mark Entry</button>
      <button id="checkout-btn" class="btn btn-warning glow-on-hover"><i class="bi bi-box-arrow-right"></i> Mark Exit</button>
    </div>
    <div id="action-alert"></div>
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <label class="profile-label mb-0">Show:</label>
      <select id="filter-select" class="form-select form-select-sm" style="max-width:150px;">
        <option value="all">All</option><option value="yesterday">Yesterday</option>
        <option value="last7">Last Week</option><option value="last30">Last Month</option>
        <option value="custom">Custom Range</option>
      </select>
      <input type="date" id="start-date" style="display:none;">
      <input type="date" id="end-date" style="display:none;">
    </div>
    <div id="attendance-cards"></div>
  </div>
</div>

<!-- Statistics -->
<div class="section" id="statistics">
  <div class="section-card">
    <div class="section-title"><i class="bi bi-bar-chart-line"></i> Statistics</div>
    <div id="statistics-holder"></div>
  </div>
</div>

<!-- Profile -->
<div class="section" id="profile">
  <div class="section-card">
    <div class="section-title"><i class="bi bi-person-circle"></i> Profile</div>
    <form id="profile-form">
      <div class="mb-2"><label class="profile-label">Email</label><input id="prof-email" class="form-control" disabled></div>
      <div class="mb-2"><label class="profile-label">Username</label><input id="prof-username" class="form-control"></div>
      <div class="mb-2"><label class="profile-label">Full Name</label><input id="prof-fullname" class="form-control"></div>
      <div class="mb-2"><label class="profile-label">Contact</label><input id="prof-contact" class="form-control"></div>
      <button class="btn btn-primary mt-2 glow-on-hover" type="submit">Save</button>
    </form>
    <div id="profile-save-result" class="mt-2"></div>
  </div>
</div>

<!-- Admin -->
<div class="section" id="admin">
  <div class="section-card">
    <div class="section-title"><i class="bi bi-people"></i> Admin Dashboard</div>
    <div id="admin-users-list" class="mb-3"></div>
    <div id="admin-user-details"></div>
    <button id="admin-export" class="btn btn-success btn-sm mb-3 glow-on-hover">Export Attendance Excel</button>
    <h5 class="text-info">Reported Issues</h5>
    <div id="admin-issues-holder"></div>
  </div>
</div>

<!-- Help -->
<div class="section" id="help">
  <div class="section-card">
    <div class="section-title"><i class="bi bi-question-circle"></i> Help</div>
    <form id="help-form">
      <label class="profile-label">Describe your issue</label>
      <textarea id="help-message" rows="4" maxlength="700" class="form-control mb-2"></textarea>
      <button type="submit" class="btn btn-primary glow-on-hover">Send Message</button>
      <div id="help-response" class="mt-2 text-warning"></div>
    </form>
    <div class="mt-3">
      <label class="profile-label">Contact Us:</label><br>
      <a href="https://wa.me/9007947130" target="_blank" class="btn btn-success me-2"><i class="bi bi-whatsapp"></i> WhatsApp</a>
      <a href="tel:+919007947130" class="btn btn-info"><i class="bi bi-telephone"></i> Call</a>
    </div>
  </div>
</div>
</div>

<!-- Camera overlay -->
<div id="camera-overlay">
  <video id="video" autoplay playsinline style="max-width:90%;border-radius:14px;"></video>
  <div id="camera-controls">
    <button id="snap-btn" class="btn btn-primary"><i class="bi bi-camera"></i> Capture</button>
    <button id="flip-btn" class="btn btn-secondary"><i class="bi bi-arrow-repeat"></i> Flip</button>
    <button id="cancel-btn" class="btn btn-danger"><i class="bi bi-x-circle"></i> Cancel</button>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
<!-- === NAVBAR & PAGE SECTIONS from your code as posted above === -->
<!-- I haven’t changed the HTML layout; it’s identical to your provided structure -->

<!-- Paste your full HTML structure here unchanged, same as you provided -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const allowedAdminEmail="mainakdebnath13@gmail.com";
const userEmail=sessionStorage.getItem("googleEmail");
const userName=sessionStorage.getItem("googleName")||"User";
if(!userEmail) location.href="login.html";
$("#user-name").text(userName);
if(userEmail!==allowedAdminEmail) $('.admin-only').hide();

// Utility functions
function getJobs(u=userEmail){return JSON.parse(localStorage.getItem("attendance_jobs__"+u)||"[]");}
function setJobs(data,u=userEmail){localStorage.setItem("attendance_jobs__"+u,JSON.stringify(data));}
function getProfile(u=userEmail){return JSON.parse(localStorage.getItem("prof__"+u)||"{}");}
function setProfile(data,u=userEmail){localStorage.setItem("prof__"+u,JSON.stringify(data));}
function escape(t){return t?t.replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])):"";}

// Navigation
$('.nav-link').click(function(){
  $('.nav-link').removeClass('active');$(this).addClass('active');
  let sec=$(this).data('sec');
  $('.section').removeClass('active').css({opacity:0});
  $('#'+sec).addClass('active');gsap.to('#'+sec,{opacity:1,duration:0.5});
});

// Attendance render
function sameDay(d1,d2){return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth()&&d1.getDate()===d2.getDate();}
function filterArray(){
  let arr=[...getJobs()],f=$("#filter-select").val(),td=new Date();td.setHours(0,0,0,0);
  if(f==="yesterday"){let yd=new Date(td);yd.setDate(td.getDate()-1);return arr.filter(r=>sameDay(new Date(r.entryTime),yd));}
  if(f==="last7"){let wk=new Date(td);wk.setDate(td.getDate()-6);return arr.filter(r=>{let d=new Date(r.entryTime);d.setHours(0,0,0,0);return d>=wk&&d<=td;});}
  if(f==="last30"){let mk=new Date(td);mk.setDate(td.getDate()-29);return arr.filter(r=>{let d=new Date(r.entryTime);d.setHours(0,0,0,0);return d>=mk&&d<=td;});}
  if(f==="custom"){
    let sd=$("#start-date").val(),ed=$("#end-date").val();if(!sd||!ed) return [];
    let sdt=new Date(sd),edt=new Date(ed);sdt.setHours(0,0,0,0);edt.setHours(0,0,0,0);
    return arr.filter(r=>{let d=new Date(r.entryTime);d.setHours(0,0,0,0);return d>=sdt&&d<=edt;});
  }
  return arr;
}
function renderAttendanceCards(){
  let arr=filterArray(),c=$("#attendance-cards").empty();
  if(!arr.length) return c.html(`<p class='text-center text-muted'>No records.</p>`);
  arr.forEach((job)=>{
    let zipStr=job.zipcode?`, ${escape(job.zipcode)}`:"";
    let details = `<div class="record-details">
        <div class="d-flex gap-3 py-2 flex-wrap">
          <div><img src="${job.entryPhoto}" style="max-width:72px;border-radius:10px;"><div class="photo-label">Entry</div></div>
          ${job.exitPhoto?`<div><img src="${job.exitPhoto}" style="max-width:72px;border-radius:10px;"><div class="photo-label">Exit</div></div>`:""}
          <div>
            <div class="time-label">Entry:</div>${escape(job.entryTime)}
            ${job.exitPhoto?`<div class="time-label">Exit:</div>${escape(job.exitTime)}`:""}
          </div>
        </div>
        <button class="btn btn-danger btn-sm delete-record-btn mt-2">Delete</button>
      </div>`;
    let card=$(`<div class="attendance-card">
      <div class="card-summary">
        <span class="status-dot ${job.exitPhoto?"completed":"pending"}"></span>
        <span class="card-place">(${escape(job.place)}${zipStr})</span>
        <span class="card-date">${escape(job.entryTime.split(",")[0])}</span>
        <i class="bi bi-chevron-down expand-icon ms-auto"></i>
      </div>
      ${details}
    </div>`);
    card.find('.card-summary').click(function(){
      let det = $(this).siblings(".record-details");
      $(this).find(".expand-icon").toggleClass("bi-chevron-down bi-chevron-up");
      det.slideToggle(200);
    });
    card.find(".delete-record-btn").click(function(e){
      e.stopPropagation();
      let jobs=getJobs();
      jobs.splice(jobs.indexOf(job),1);setJobs(jobs);
      renderAttendanceCards();renderStatisticsTable();
    });
    c.append(card);
  });
}

// Map
let selectedPlace=null,userLat=null,userLng=null,map,marker,userLiveMarker;
function initMap(){
  map=new google.maps.Map(document.getElementById('map'),{center:{lat:28.61,lng:77.23},zoom:12});
  const searchBox=new google.maps.places.SearchBox(document.getElementById('pac-input'),{componentRestrictions:{country:["in"]}});
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(function(position){
      userLat=position.coords.latitude;userLng=position.coords.longitude;
      if(!userLiveMarker){
        let pos={lat:userLat,lng:userLng};
        userLiveMarker=new google.maps.Marker({position:pos,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#2977FF",fillOpacity:.8,strokeColor:"#fff",strokeWeight:2}});
        map.setCenter(pos);map.setZoom(16);
      }else userLiveMarker.setPosition({lat:userLat,lng:userLng});
    });
  }
  searchBox.addListener('places_changed',()=>{
    const places=searchBox.getPlaces();
    if(!places.length)return;
    selectedPlace=places[0];
    if(marker)marker.setMap(null);
    marker=new google.maps.Marker({map,position:selectedPlace.geometry.location});
    map.panTo(selectedPlace.geometry.location);map.setZoom(16);
  });
}

// Camera
let usingFront=false,globalStream,entryPhoto="",exitPhoto="";
function openCamera(type){
  $("#camera-overlay").css("display","flex");
  function startCam(){if(globalStream)globalStream.getTracks().forEach(t=>t.stop());
    navigator.mediaDevices.getUserMedia({video:{facingMode:usingFront?'user':'environment'}}).then(stream=>{$("#video")[0].srcObject=stream;globalStream=stream;});
  }
  startCam();
  $("#snap-btn").off().click(()=>{
    const v=$("#video")[0],c=$("#canvas")[0];
    c.width=v.videoWidth;c.height=v.videoHeight;
    c.getContext('2d').drawImage(v,0,0);
    if(type==='entry') entryPhoto=c.toDataURL(); else exitPhoto=c.toDataURL();
    globalStream.getTracks().forEach(t=>t.stop());
    $("#camera-overlay").hide();
    finishAttendance(type);
  });
  $("#flip-btn").off().click(()=>{usingFront=!usingFront;startCam();});
  $("#cancel-btn").off().click(()=>{if(globalStream)globalStream.getTracks().forEach(t=>t.stop());$("#camera-overlay").hide();});
}
function finishAttendance(type){
  let jobs=getJobs();
  if(type==='entry'){jobs.unshift({place:selectedPlace?.name||"Unknown",zipcode:selectedPlace?.zipcode||"",entryTime:new Date().toLocaleString(),entryPhoto,status:"pending-exit"});}
  else{let j=jobs.find(x=>x.status==="pending-exit");if(j){j.exitTime=new Date().toLocaleString();j.exitPhoto=exitPhoto;j.status="completed";}}
  setJobs(jobs);renderAttendanceCards();renderStatisticsTable();showAlert(type==='entry'?"Entry marked!":"Exit marked!",false);
}
$('#checkin-btn').click(()=>{if(!selectedPlace)return showAlert("Select place",true);
  if(getDistance(userLat,userLng,selectedPlace.geometry.location.lat(),selectedPlace.geometry.location.lng())<=400) openCamera('entry');
  else showAlert("Too far from site",true);
});
$('#checkout-btn').click(()=>{if(!selectedPlace)return showAlert("Select place",true);
  if(!getJobs().some(j=>j.status==="pending-exit"))return showAlert("No active job",true);
  if(getDistance(userLat,userLng,selectedPlace.geometry.location.lat(),selectedPlace.geometry.location.lng())<=400) openCamera('exit');
  else showAlert("Too far from site",true);
});
function getDistance(lat1,lon1,lat2,lon2){const R=6371e3,toRad=d=>d*Math.PI/180;
  let dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  let a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// Profile
function loadProfile(){let p=getProfile();
  $("#prof-email").val(userEmail);
  $("#prof-username").val(p.username||userEmail.split('@')[0]);
  $("#prof-fullname").val(p.fullname||userName);
  $("#prof-contact").val(p.contact||"");
}
$("#profile-form").submit(e=>{
  e.preventDefault();
  setProfile({username:$("#prof-username").val(),fullname:$("#prof-fullname").val(),contact:$("#prof-contact").val()});
  $("#profile-save-result").text("Saved!");
});

// Stats
function renderStatisticsTable(){
  let arr=getJobs(),total=arr.length,todayCount=0,last7=0,last30=0;
  let today=new Date();today.setHours(0,0,0,0);
  let last7date=new Date(today);last7date.setDate(today.getDate()-6);
  let last30date=new Date(today);last30date.setDate(today.getDate()-29);
  arr.forEach(j=>{let d=new Date(j.entryTime);d.setHours(0,0,0,0);
    if(d.getTime()===today.getTime()) todayCount++;
    if(d>=last7date) last7++;
    if(d>=last30date) last30++;
  });
  $("#statistics-holder").html(`<table class="table table-bordered table-dark text-center"><tr><th>Today</th><th>Last 7 Days</th><th>Last 30 Days</th><th>Total</th></tr><tr><td>${todayCount}</td><td>${last7}</td><td>${last30}</td><td>${total}</td></tr></table>`);
}

// Help form
$("#help-form").submit(function(e){
  e.preventDefault();
  let msg=$("#help-message").val().trim(); if(!msg) return $("#help-response").text("Please enter your issue.");
  let prof=getProfile();
  let issue={username:prof.username||userEmail.split('@')[0],fullname:prof.fullname||userName,time:new Date().toLocaleString(),message:msg};
  let issues=JSON.parse(localStorage.getItem("issues__")||"[]");
  issues.unshift(issue);localStorage.setItem("issues__",JSON.stringify(issues));
  $("#help-response").html('<span class="text-success">Issue reported successfully!</span>');
  $("#help-message").val("");
});

// Admin
function getAllUserEmails(){
  return Object.keys(localStorage).filter(k=>k.startsWith('attendance_jobs__')).map(k=>k.replace('attendance_jobs__',''));
}
function getDurationStr(r){
  if(!r.entryTime||!r.exitTime) return "00:00";
  let et=new Date(r.entryTime),xt=new Date(r.exitTime);let ms=xt-et;
  if(isNaN(ms) || ms<60000) return "00:00";
  let mins=Math.floor(ms/60000),hrs=Math.floor(mins/60),m=mins%60;
  return String(hrs).padStart(2,"0")+":"+String(m).padStart(2,"0");
}
function renderAdminTable(){
  let users=getAllUserEmails();
  let list="<ul class='list-group'>";
  users.forEach(email=>{
    let p=getProfile(email)||{}, u=p.username||email.split('@')[0], f=p.fullname||"";
    list+=`<li class='list-group-item admin-user-row' data-email="${email}">${escape(f)} (${escape(u)})</li>`;
  });
  list+="</ul>";$("#admin-users-list").html(list);$("#admin-user-details").empty();
  $(".admin-user-row").off().click(function(){ showAdminUserDetails($(this).data("email"));});
  renderAdminIssues();
  $("#admin-export").off().click(function(){
    let rows=[];
    users.forEach(email=>{
      let p=getProfile(email)||{};
      getJobs(email).forEach(r=>{
        rows.push({Email: email, Username: p.username||"", FullName: p.fullname||"", Contact: p.contact||"",
          Place: `(${r.place}${r.zipcode ? ", "+r.zipcode : ""})`,
          Entry: r.entryTime, Exit: r.exitTime||"", Duration: getDurationStr(r), Status: r.status});
      });
    });
    let wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),"Attendance");
    XLSX.writeFile(wb,"attendance.xlsx");
  });
}
function showAdminUserDetails(email){
  let p=getProfile(email)||{}, u=p.username||email.split('@')[0], f=p.fullname||"";
  let recs=getJobs(email);
  let html=`<div class='mt-3 mb-2'><strong>${escape(f)} (${escape(u)})</strong></div>`;
  if(!recs.length){html+="<p class='text-muted'>No records.</p>"; return $("#admin-user-details").html(html);}
  html+="<table class='table table-bordered admin-record-table'><tr><th>Place (ZIP)</th><th>Entry</th><th>Exit</th><th>Duration</th><th>Status</th></tr>";
  recs.forEach(r=>{
    html+=`<tr><td>(${escape(r.place)}${r.zipcode?", "+escape(r.zipcode):""})</td>
      <td>${escape(r.entryTime)||""}</td>
      <td>${escape(r.exitTime)||""}</td>
      <td>${getDurationStr(r)}</td>
      <td>${escape(r.status)||""}</td></tr>`;
  });
  html+="</table>";
  $("#admin-user-details").html(html);
}
function renderAdminIssues(){
  let issues=JSON.parse(localStorage.getItem("issues__")||"[]");
  if(!issues.length) return $("#admin-issues-holder").html("<p class='text-muted'>No issues reported.</p>");
  let html="<table class='table table-bordered table-sm table-dark'><tr><th>Username</th><th>Full Name</th><th>Time</th><th>Message</th></tr>";
  issues.forEach(i=>{html+=`<tr><td>${escape(i.username)}</td><td>${escape(i.fullname)}</td><td>${escape(i.time)}</td><td>${escape(i.message)}</td></tr>`;});
  html+="</table>";$("#admin-issues-holder").html(html);
}

// Alert helper
function showAlert(msg,isError){
  $("#action-alert").text(msg).css({opacity:1,background:isError?'rgba(220,53,69,0.25)':'#2434aa26',borderColor:isError?'#dc3545':'#5e73d2bb'});
  setTimeout(()=>$("#action-alert").css('opacity',0),3000);
}

// INIT
$(document).ready(function(){
  initMap();
  renderAttendanceCards();
  renderStatisticsTable();
  loadProfile();
  if(userEmail===allowedAdminEmail) renderAdminTable();
  $("#filter-select").change(function(){
    $("#start-date,#end-date").toggle($(this).val()==='custom');
    renderAttendanceCards();
  });
  $("#start-date,#end-date").on('change',renderAttendanceCards);
});
</script>
</body>
</html>
