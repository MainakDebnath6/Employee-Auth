<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Engineer Attendance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="icon" href="./Bureau_Veritas.svg.png" type="image/png" />

<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>

<style>
  :root {
    --glow-color-1: #334bf9;
    --glow-color-2: #43bfff;
    --background-color: #0b0c10;
    --card-background: rgba(22, 25, 37, 0.75);
    --card-border: rgba(255, 255, 255, 0.1);
    --text-primary: #f0f2f5;
    --text-secondary: #a8b2c2;
    --text-accent: var(--glow-color-2);
    --success: #2ecc71;
    --warning: #f1c40f;
    --error: #e74c3c;
    --primary-gradient: linear-gradient(90deg, var(--glow-color-1), var(--glow-color-2));
  }
  :root {
    --fc-border-color: var(--card-border);
    --fc-daygrid-event-dot-width: 8px;
    --fc-today-bg-color: rgba(67, 191, 255, 0.1);
  }
  .fc { color: var(--text-primary); }
  .fc .fc-button-primary { background-color: var(--glow-color-1); border-color: var(--glow-color-1); font-weight: 600; }
  .fc .fc-button-primary:hover { background-color: var(--glow-color-2); border-color: var(--glow-color-2); }
  * { box-sizing: border-box; }
  body { font-family: 'Poppins', sans-serif; background: var(--background-color); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--background-color); }
  ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
  #app-loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--background-color); z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
  .spinner { width: 56px; height: 56px; border-radius: 50%; background: radial-gradient(farthest-side,var(--glow-color-1) 94%,#0000) top/9px 9px no-repeat, conic-gradient(#0000 30%,var(--glow-color-1)); -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 9px),#000 0); animation: spinner-c7wet2 1s infinite linear; }
  @keyframes spinner-c7wet2 { to { transform: rotate(1turn) } }
  #particle-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(circle at 20% 20%, var(--glow-color-1), transparent 30%), radial-gradient(circle at 80% 70%, var(--glow-color-2), transparent 30%); opacity: 0.1; animation: backgroundGlow 20s infinite alternate; }
  @keyframes backgroundGlow { 0% { transform: scale(1) rotate(0deg); } 100% { transform: scale(1.2) rotate(5deg); } }
  .navbar { background: rgba(15, 17, 26, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid var(--card-border); }
  .nav-link { color: var(--text-secondary) !important; font-weight: 600; border-radius: 8px; padding: 0.5rem 1rem; margin: 0 0.25rem; transition: all 0.2s ease; }
  .nav-link.active, .nav-link:hover { color: var(--text-primary) !important; background: rgba(255, 255, 255, 0.1); }
  .navbar-toggler { border-color: rgba(255, 255, 255, 0.2); }
  .navbar-toggler-icon { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28240, 242, 245, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e"); }
  #container-main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; background: transparent; box-shadow: none; }
  .section { display: none; } .section.active { display: block; }
  .section-card { background: var(--card-background); border: 1px solid var(--card-border); backdrop-filter: blur(20px) saturate(150%); border-radius: 20px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.3); height: 100%; display: flex; flex-direction: column; margin-bottom: 2rem; transition: transform 0.3s ease, box-shadow 0.3s ease; }
  .dashboard-top-row .col-lg-7, .dashboard-top-row .col-lg-5 { margin-bottom: 2rem; }
  .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--card-border); padding-bottom: 1rem; flex-shrink: 0; }
  .section-title i { color: var(--text-accent); }
  #map-wrapper, #stats-map-wrapper, #admin-live-map-wrapper { position: relative; height: 500px; border-radius: 16px; background: #0e1118; overflow: hidden; border: 1px solid var(--card-border); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); transition: all 0.3s ease; }
  #map-wrapper:hover, #stats-map-wrapper:hover, #admin-live-map-wrapper:hover { border-color: var(--glow-color-2); box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 15px rgba(67, 191, 255, 0.2); }
  #map, #stats-map, #admin-live-map { height: 100%; width: 100%; }
  .form-control, .pac-target-input { background: rgba(0,0,0,0.3) !important; color: var(--text-primary) !important; border-radius: 10px !important; border: 1px solid var(--card-border) !important; transition: all 0.2s ease !important; }
  .form-control:focus, .pac-target-input:focus { background: rgba(0,0,0,0.4) !important; color: var(--text-primary) !important; border-color: var(--glow-color-2) !important; box-shadow: 0 0 15px rgba(67, 191, 255, 0.3), 0 0 5px rgba(67, 191, 255, 0.2) inset !important; }
  .form-control:disabled { background: rgba(0, 0, 0, 0.2) !important; color: var(--text-secondary) !important; opacity: 0.8; cursor: not-allowed; border-color: rgba(255, 255, 255, 0.05) !important; }
  .input-group-text { background: rgba(0,0,0,0.3); border: 1px solid var(--card-border); border-left: 0; }
  #gps-status { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); padding: 0.5rem 0; flex-shrink: 0; }
  #gps-status .spinner-border-sm { width: 1rem; height: 1rem; margin-right: 0.5rem; }
  .btn { border-radius: 10px; font-weight: 600; padding: 0.75rem 1.5rem; transition: all 0.2s ease-in-out; border: none; }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  .btn.btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
  .attendance-card, .travel-card, .issue-card { background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 0.75rem; padding: 1rem 1.25rem; transition: all 0.3s ease; border: 1px solid transparent; }
  .attendance-card:hover, .travel-card:hover, .issue-card:hover { transform: scale(1.02); background: rgba(255,255,255,0.1); border-color: var(--card-border); }
  .status-dot { width: 12px; height: 12px; border-radius: 50%; }
  .completed { background-color: var(--success); } .pending { background-color: var(--warning); }
  .card-place { color: var(--text-primary); font-weight: 600; font-size: 1.1rem; }
  .card-date { color: var(--text-secondary); }
  .record-details img { border: 1px solid var(--card-border); cursor: pointer; }
  #attendance-cards-container, #admin-users-list, #stats-travel-details { max-height: 450px; overflow-y: auto; padding-right: 10px; }
  .admin-user-row { background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 0.5rem; padding: 0.8rem 1.2rem; font-weight: 600; transition: all 0.2s ease; cursor: pointer; }
  .admin-user-row:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
  .admin-user-row.active { background: var(--primary-gradient); color: #fff; box-shadow: 0 0 20px rgba(51, 75, 249, 0.4); transform: translateX(0); }
  .admin-user-row.active .email { color: rgba(255, 255, 255, 0.8); }
  .admin-user-row .email { font-size: 0.8rem; font-weight: 400; color: var(--text-secondary); }
  .admin-user-row .form-check-input { display: none; }
  .select-mode-active .admin-user-row .form-check-input { display: inline-block; }
  .admin-record-details img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--card-border); transition: transform 0.2s ease; }
  .admin-record-details a:hover img { transform: scale(1.05); }
  .stat-box { background: var(--card-background); padding: 1.5rem; border-radius: 15px; text-align: center; border: 1px solid var(--card-border); transition: all 0.3s ease; height: 100%; }
  .stat-box:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); border-color: var(--glow-color-2); }
  .stat-box h4 { font-weight: 700; font-size: 2.25rem; color: var(--text-accent); }
  .stat-box p { font-weight: 600; color: var(--text-secondary); margin: 0; }
  #admin-summary-stats .stat-box h4, #stats-travel-summary .stat-box h4 { font-size: 1.75rem; }
  #image-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 10000; display: none; align-items: center; justify-content: center; cursor: pointer; }
  #image-viewer img { max-width: 90%; max-height: 90%; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
  .modal-content { background: var(--card-background); border: 1px solid var(--card-border); color: var(--text-primary); }
  .modal-header, .modal-footer { border-color: var(--card-border); }
  .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
  .calendar-legend { flex-shrink: 0; }
  .calendar-legend span { transition: all 0.2s ease; cursor: default; }
  .calendar-legend span:hover { color: var(--text-primary); }
  .admin-view-tabs .nav-link { background-color: transparent; border: 1px solid var(--card-border); }
  .admin-view-tabs .nav-link.active { background: var(--primary-gradient); border-color: transparent; color: #fff !important; }
  .tab-pane { padding-top: 1.5rem; }
  .fc { font-family: 'Poppins', sans-serif; color: var(--text-primary); background: transparent; }
  .fc .fc-toolbar.fc-header-toolbar { margin-bottom: 1.25rem !important; padding-bottom: 1rem; border-bottom: 1px solid var(--card-border); }
  .fc .fc-toolbar-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
  .fc .fc-button { background: transparent !important; border: none !important; color: var(--text-secondary) !important; box-shadow: none !important; transition: all 0.2s ease-in-out; }
  .fc .fc-button .fc-icon { font-size: 1.3em; }
  .fc .fc-button:hover { color: var(--glow-color-2) !important; }
  .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:not(:disabled):active { color: var(--glow-color-1) !important; }
  .fc .fc-today-button { font-size: 0.8rem !important; font-weight: 600; border-radius: 8px; background: rgba(255, 255, 255, 0.05) !important; border: 1px solid var(--card-border) !important; padding: 0.4rem 0.8rem; }
  .fc .fc-today-button:hover { background: rgba(255, 255, 255, 0.1) !important; }
  .fc th { border-color: transparent !important; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.7rem; padding-bottom: 0.8rem; }
  .fc .fc-daygrid-day-frame { padding: 4px; position: relative; } .fc-theme-standard .fc-scrollgrid { border: none !important; }
  .fc .fc-daygrid-day { border-color: var(--card-border); }
  .fc .fc-daygrid-day-number { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); padding: 6px; position: relative; z-index: 2; }
  .fc .fc-day-other .fc-daygrid-day-top { opacity: 0.3; }
  .fc .fc-daygrid-day.fc-day-today { background-color: var(--fc-today-bg-color); }
  .fc .fc-day-today .fc-daygrid-day-number { color: var(--glow-color-2); font-weight: 700; background-color: rgba(0,0,0,0.3); border-radius: 50%; padding: 4px; display: inline-block; min-width: 24px; text-align: center; }
  .fc .fc-bg-event { opacity: 0.5; mix-blend-mode: screen; }
  .fc-day-event-dots { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 4px; z-index: 1; }
  .fc-day-event-dot { width: 6px; height: 6px; border-radius: 50%; }

  /* --- CHAT UI STYLES --- */
  .chat-layout { display: flex; height: 70vh; flex-grow: 1; }
  .chat-sidebar { width: 350px; border-right: 1px solid var(--card-border); display: flex; flex-direction: column; transition: width 0.3s ease; }
  .chat-list { overflow-y: auto; flex-grow: 1; }
  .chat-list-item { display: flex; align-items: center; padding: 1rem; gap: 1rem; border-bottom: 1px solid var(--card-border); cursor: pointer; transition: background-color 0.2s ease; }
  .chat-list-item:hover { background-color: rgba(255,255,255,0.05); }
  .chat-list-item.active { background: var(--glow-color-1); background: linear-gradient(to right, var(--glow-color-1), #293a9e); }
  .chat-avatar { width: 48px; height: 48px; border-radius: 50%; background-color: var(--glow-color-2); color: #fff; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.2rem; flex-shrink: 0; }
  .chat-list-item .chat-info { overflow: hidden; }
  .chat-list-item .name { font-weight: 600; }
  .chat-list-item .last-message { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .chat-list-item.active .last-message { color: rgba(255,255,255,0.8); }
  .chat-window { flex-grow: 1; display: flex; flex-direction: column; }
  .chat-header { display:flex; align-items:center; gap:1rem; padding: 1rem 1.5rem; border-bottom: 1px solid var(--card-border); font-weight: 700; font-size: 1.2rem; flex-shrink: 0; }
  .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; }
  .messages-container-inner { display: flex; flex-direction: column; gap: 0.25rem; margin-top: auto; }
  .message-bubble { max-width: 70%; padding: 0.75rem 1.25rem; border-radius: 20px; margin-bottom: 0.25rem; font-size: 0.95rem; line-height: 1.4; }
  .message-bubble.sent { background: var(--primary-gradient); color: #fff; border-bottom-right-radius: 5px; align-self: flex-end; }
  .message-bubble.received { background-color: rgba(255,255,255,0.1); border-bottom-left-radius: 5px; align-self: flex-start; }
  .message-timestamp { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; padding: 0 5px; }
  .sent + .message-timestamp { text-align: right; }
  .chat-input { padding: 1rem 1.5rem; border-top: 1px solid var(--card-border); flex-shrink: 0; }
  #chat-message-input { border-right: 0 !important; border-radius: 10px 0 0 10px !important; }
  #send-chat-btn { border-radius: 0 10px 10px 0 !important; }

  @media (max-width: 991.98px) { .navbar-collapse { background: var(--card-background); backdrop-filter: blur(20px) saturate(150%); padding: 1.5rem; border-radius: 20px; margin-top: 0.75rem; border: 1px solid var(--card-border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); } .dashboard-top-row{ flex-direction: column; } }
  @media (max-width: 768px) {
    .section-card { padding: 1.25rem 1rem; } .section-title { font-size: 1.25rem; } .stat-box h4 { font-size: 1.75rem; }
    #map-wrapper, #stats-map-wrapper, #admin-live-map-wrapper { height: 350px; }
    .chat-layout { flex-direction: column; height: 75vh; }
    .chat-sidebar { width: 100%; height: auto; max-height: 35%; border-right: none; border-bottom: 1px solid var(--card-border); }
    .chat-window { flex-grow: 1; } .chat-header { padding: 0.75rem 1rem; font-size: 1rem; }
    .chat-messages { padding: 1rem; } .message-bubble { max-width: 85%; }
    .fc .fc-toolbar { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
    .fc .fc-toolbar-title { font-size: 1.2rem; }
  }
</style>
</head>
<body>

<div id="app-loader"><div class="spinner"></div></div>
<div id="particle-container"></div>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand text-light d-flex align-items: center gap-2" style="font-weight: 700; font-size: 1.2rem;"><i class="bi bi-shield-check"></i> Attendance</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link active" data-sec="dashboard"><i class="bi bi-layout-wtf"></i> Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-sec="statistics"><i class="bi bi-bar-chart-line"></i> Statistics</a></li>
        <li class="nav-item"><a class="nav-link" data-sec="chats"><i class="bi bi-chat-dots"></i> Chats</a></li>
        <li class="nav-item"><a class="nav-link" data-sec="profile"><i class="bi bi-person-circle"></i> Profile</a></li>
        <li class="nav-item admin-only"><a class="nav-link" data-sec="admin"><i class="bi bi-people"></i> Admin</a></li>
        <li class="nav-item"><a class="nav-link" data-sec="help"><i class="bi bi-question-circle"></i> Help</a></li>
      </ul>
      <span id="user-name" class="navbar-text text-light me-3" style="font-weight: 600;"></span>
      
      <button id="logout-btn" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div id="global-alert-container" style="position: fixed; top: 80px; right: 20px; z-index: 10000; width: 350px;"></div>
<div id="image-viewer"><img id="fullscreen-image" src=""></div>

<div class="modal fade" id="dayDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-date-display"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6>Activity on this day:</h6>
        <div id="modal-event-details"><p class="text-secondary">No activity recorded.</p></div>
        <hr>
        <h6>Mark your attendance:</h6>
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-info" id="modal-mark-office-btn"><i class="bi bi-building me-2"></i>Mark as Office Work</button>
            <button class="btn btn-danger" id="modal-mark-leave-btn"><i class="bi bi-calendar-x me-2"></i>Mark as Leave</button>
            <button class="btn btn-secondary" id="modal-mark-clear-btn"><i class="bi bi-x-circle me-2"></i>Clear Status</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="container-main">
  <div class="section active" id="dashboard">
    <div class="row dashboard-top-row">
      <div class="col-lg-7">
        <div class="section-card">
          <div class="section-title"><i class="bi bi-map"></i> Mark On-Site Visit</div>
          <div class="mb-3" style="flex-shrink: 0;"><input id="site-search-input" type="text" class="form-control pac-target-input" placeholder="Search for a site or address..."/></div>
          <div id="map-wrapper" style="flex-grow: 1;"><div id="map"></div></div>
          <div id="gps-status" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Acquiring GPS...</div>
          <div class="d-flex justify-content-center gap-3 my-3 flex-column flex-sm-row" style="flex-shrink: 0;">
            <button id="checkin-btn" class="btn btn-success"><i class="bi bi-box-arrow-in-right"></i> Mark Entry</button>
            <button id="checkout-btn" class="btn btn-warning"><i class="bi bi-box-arrow-right"></i> Mark Exit</button>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
          <div class="section-card">
              <div class="section-title"><i class="bi bi-calendar-check"></i> Attendance Calendar</div>
              <div id="dashboard-calendar" style="flex-grow: 1;"></div>
              <div class="d-flex justify-content-center gap-3 mt-3 small text-secondary calendar-legend">
                <span><i class="bi bi-circle-fill text-success"></i> Site Visit</span>
                <span><i class="bi bi-circle-fill" style="color: var(--glow-color-2);"></i> Office</span>
                <span><i class="bi bi-circle-fill text-danger"></i> Leave</span>
              </div>
          </div>
      </div>
    </div>
    <div class="section-card">
        <div class="section-title"><i class="bi bi-clock-history"></i> Your Recent Site Visits</div>
        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <label class="form-label mb-0 fw-bold">Filter by:</label>
            <select id="filter-select" class="form-select form-select-sm" style="max-width:180px;"><option value="all">All Time</option><option value="yesterday">Yesterday</option><option value="last7">Last 7 Days</option><option value="last30">Last 30 Days</option><option value="custom">Custom Range</option></select>
            <input type="date" id="start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;"><input type="date" id="end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
        </div>
        <div id="attendance-cards-container"><div id="attendance-cards"></div></div>
        <div id="load-more-container" class="text-center mt-3" style="display: none;"><button id="load-more-btn" class="btn btn-outline-primary">Load More</button></div>
    </div>
  </div>

  <div class="section" id="statistics">
      <div class="row">
          <div class="col-12"><div class="section-card"><div class="section-title"><i class="bi bi-bar-chart-line"></i> Summary Statistics</div><div id="statistics-holder"></div></div></div>
          <div class="col-12"><div class="section-card">
            <div class="section-title"><i class="bi bi-sign-turn-right"></i> Your Travel Details</div>
            <div id="stats-travel-container">
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <label class="form-label mb-0 fw-bold">Filter by:</label>
                    <select id="stats-travel-filter-select" class="form-select form-select-sm" style="max-width:180px;"><option value="all">All Time</option><option value="yesterday">Yesterday</option><option value="last7">Last 7 Days</option><option value="last30">Last 30 Days</option><option value="custom">Custom Range</option></select>
                    <input type="date" id="stats-travel-start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;"><input type="date" id="stats-travel-end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                </div>
                <div id="stats-travel-summary"></div><div id="stats-travel-details" class="mt-3"></div><div id="stats-map-wrapper" class="mt-4"><div id="stats-map"></div></div>
            </div>
          </div></div>
      </div>
  </div>
 
  <div class="section" id="chats"><div class="section-card" style="padding: 0;"><div id="chat-app-container"></div></div></div>

  <div class="section" id="profile">
      <div class="section-card">
        <div class="section-title"><i class="bi bi-person-badge"></i> Your Profile</div>
        <form id="profile-form">
          <div class="mb-3"><label class="form-label">Email</label><input id="prof-email" class="form-control" disabled></div>
          <div class="mb-3"><label class="form-label">Username</label><input id="prof-username" class="form-control"></div>
          <div class="mb-3"><label class="form-label">Full Name</label><input id="prof-fullname" class="form-control"></div>
          <div class="mb-3"><label class="form-label">Contact</label><input id="prof-contact" class="form-control"></div>
          <button class="btn btn-primary" type="submit">Save Changes</button>
        </form>
      </div>
      <div class="section-card">
        <div class="section-title"><i class="bi bi-house-gear"></i> Set Home Address</div>
        <form id="home-address-form">
            <div class="mb-3">
                <label class="form-label">Your current home address</label>
                 <div class="input-group"><input type="text" id="home-address-input" class="form-control pac-target-input" placeholder="Start typing your address..." /><span class="input-group-text" id="home-valid-icon" style="display: none;"><i class="bi bi-check-circle-fill text-success"></i></span></div>
                <div class="form-text">This is used to calculate travel distances.</div>
            </div>
            <button class="btn btn-success" type="submit">Save Home</button>
        </form>
      </div>
  </div>

  <div class="section" id="admin">
        <div class="section-card"><div class="section-title"><i class="bi bi-broadcast-pin"></i> Live Employee Map</div><div id="admin-live-map-wrapper"><div id="admin-live-map"></div></div><div class="text-end mt-2"><button id="refresh-live-map-btn" class="btn btn-sm btn-outline-info"><i class="bi bi-arrow-clockwise"></i> Refresh</button></div></div>
        <div class="section-card" id="admin-user-selection-card">
          <div class="d-flex justify-content-between align-items-center"><div class="section-title m-0 p-0 border-0"><i class="bi bi-people"></i> Select Users</div><button class="btn btn-primary btn-sm" id="admin-toggle-select-mode"><i class="bi bi-check2-square me-2"></i>Select Multiple</button></div>
          <hr style="border-color: var(--card-border);">
          <div class="form-check mb-3" id="admin-select-all-container" style="display: none;"><input class="form-check-input" type="checkbox" id="admin-select-all-users"><label class="form-check-label" for="admin-select-all-users">Select All</label></div>
          <div id="admin-users-list" class="mb-4"></div>
          <div id="admin-actions-bar" style="display: none;">
              <p class="fw-bold">Actions for selected users:</p>
              <div class="d-flex gap-2 flex-wrap"><button id="admin-export-selected" class="btn btn-info"><i class="bi bi-download"></i> Export</button><button id="admin-delete-selected" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button></div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-2 my-3">
                <label class="form-label mb-0 fw-bold">Filter records by:</label>
                <select id="admin-filter-select" class="form-select form-select-sm" style="max-width:180px;"><option value="all">All Time</option><option value="yesterday">Yesterday</option><option value="last7">Last 7 Days</option><option value="last30">Last 30 Days</option><option value="custom">Custom Range</option></select>
                <input type="date" id="admin-start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;"><input type="date" id="admin-end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
          </div>
          <div id="admin-user-details-wrapper" style="opacity: 0; display: none;">
            <hr style="border-color: var(--card-border);">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h5 id="admin-selected-user-name"></h5>
                <button class="btn btn-outline-info btn-sm" id="admin-refresh-user-data" title="Refresh User Data"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
            <p id="admin-selected-user-contact" class="text-secondary small mb-3"></p>
            <div id="admin-view-container"></div>
          </div>
        </div>
        <div class="section-card"><div class="section-title"><i class="bi bi-exclamation-triangle"></i> Reported Issues</div><div id="admin-issues-holder"></div></div>
  </div>

  <div class="section" id="help">
      <div class="section-card">
        <div class="section-title"><i class="bi bi-question-circle"></i> Get Help</div>
        <form id="help-form"><label class="form-label">Describe your issue</label><textarea id="help-message" rows="4" maxlength="700" class="form-control mb-3"></textarea><button type="submit" class="btn btn-primary">Send Message</button></form>
        <div class="mt-4"><label class="form-label">Contact Us Directly:</label><br><a href="https://wa.me/9007947130" target="_blank" class="btn btn-success me-2"><i class="bi bi-whatsapp"></i> WhatsApp</a><a href="tel:+919007947130" class="btn btn-info"><i class="bi bi-telephone"></i> Call</a></div>
      </div>
  </div>
</div>

<div id="camera-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); align-items: center; justify-content: center; z-index: 9999; flex-direction: column;">
    <video id="video" autoplay playsinline style="max-width:90%; border-radius:14px;"></video>
    <div id="camera-controls" class="mt-3 d-flex gap-3"><button id="snap-btn" class="btn btn-primary"><i class="bi bi-camera-fill"></i> Capture</button><button id="flip-btn" class="btn btn-secondary"><i class="bi bi-arrow-repeat"></i> Flip</button><button id="cancel-btn" class="btn btn-danger"><i class="bi bi-x"></i> Cancel</button></div>
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&loading=async&libraries=places,marker,geometry&callback=initMaps"></script>

<script>
// --- Global State & Config ---
const firebaseConfig = { apiKey: "AIzaSyCrDafJCJNas4c9JV_hOvl1vQB--DjLgXo", authDomain: "engineer-attendance-pro.firebaseapp.com", projectId: "engineer-attendance-pro", storageBucket: "engineer-attendance-pro.firebasestorage.app", messagingSenderId: "775643524384", appId: "1:775643524384:web:a11f05770c6f39ad283b45" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// IMPORTANT: Replace with YOUR admin's UID from Firebase Authentication
const ADMIN_UID = "mnMroO4TOOb0Ms9wEWMJqHaPV7n1";
const allowedAdminEmails = ["mainakdebnath13@gmail.com", "mainakdebnatha@gmail.com"];
const BUREAU_VERITAS_KOLKATA = { lat: 22.5726, lng: 88.3639 };
let userName, userEmail, userUid, isAdmin = false, unsubscribeChatListener, map, siteMarker, userLiveMarker, selectedPlace = null, homePlace = null, statsMap, statsMapMarkers = [], adminLiveMap, adminLiveMapMarkers = [], AdvancedMarkerElement, PinElement, currentSectionId = '#dashboard', usingFront = false, globalStream, userLat = null, userLng = null, dayDetailModal, isAdminSelectMode = false, fullCalendar, adminDetailCalendar, lastVisibleJob = null;
const JOBS_PER_PAGE = 10;
let isLoggingOut = false; // SOLVED: Flag to prevent login loop

// --- Authentication & Initialization ---
auth.onAuthStateChanged(async(user)=>{
    if (isLoggingOut) return; // SOLVED: If logging out, ignore the auth state change
    const appLoader=document.getElementById('app-loader');
    if(user){
        userName=user.displayName;userEmail=user.email;userUid=user.uid;isAdmin=allowedAdminEmails.includes(userEmail);const userProfileRef=db.collection("profiles").doc(user.uid);const doc=await userProfileRef.get();if(!doc.exists){await userProfileRef.set({email:user.email,fullname:user.displayName||user.email.split('@')[0]},{merge:true});}
        await initializeApp();
        gsap.to(appLoader,{opacity:0,duration:0.3,onComplete:()=>$(appLoader).hide()});
    } else {
        window.location.href="index.html";
    }
});

async function initializeApp(){
    $("#user-name").text(`Welcome, ${userName.split(' ')[0]}`);
    if(isAdmin){$('.admin-only').show();}else{$('.admin-only').hide();}
    const initialSection=$(currentSectionId);
    initialSection.addClass('active');
    gsap.fromTo(initialSection.find('.section-card, .dashboard-top-row > div'),{opacity:0,y:20},{opacity:1,y:0,duration:0.5,stagger:0.1,onComplete:()=>{
        if(currentSectionId==='#dashboard'){ initializeFullCalendar(); }
        if(map) google.maps.event.trigger(map,'resize');
    }});
    setupNavListeners();
    initDashboard();
    $('#image-viewer').on('click',function(){$(this).fadeOut(200);});
    dayDetailModal=new bootstrap.Modal(document.getElementById('dayDetailModal'));
}

function setupNavListeners(){$('.nav-link').click(function(){const targetSectionId='#'+$(this).data('sec');if(targetSectionId===currentSectionId)return;$('.nav-link').removeClass('active');$(this).addClass('active');const oldSection=$(currentSectionId);const newSection=$(targetSectionId);gsap.to(oldSection.find('.section-card, .dashboard-top-row > div'),{opacity:0,duration:0.2,stagger:0.05,onComplete:()=>{oldSection.removeClass('active').hide();newSection.addClass('active').show();if(targetSectionId==='#statistics'&&$('#statistics-holder').is(':empty'))renderStatistics();if(targetSectionId==='#admin'&&$('#admin-users-list').is(':empty'))initAdmin();if(targetSectionId==='#profile')initProfile();if(targetSectionId==='#help'&&!$('#help-form').attr('data-initialized'))initHelp();if(targetSectionId==='#chats'&&$('#chat-app-container').is(':empty'))initChats();gsap.fromTo(newSection.find('.section-card, .dashboard-top-row > div'),{opacity:0,y:20},{opacity:1,y:0,duration:0.5,stagger:0.1,onComplete:()=>{setTimeout(()=>{if(map&&targetSectionId==='#dashboard')google.maps.event.trigger(map,'resize');if(statsMap&&targetSectionId==='#statistics')google.maps.event.trigger(statsMap,'resize');if(adminLiveMap&&targetSectionId==='#admin')google.maps.event.trigger(adminLiveMap,'resize');},50);}});}});currentSectionId=targetSectionId;});
    $("#logout-btn").click(()=>{
        isLoggingOut = true; // SOLVED: Set flag before signing out
        auth.signOut().then(()=>{
            window.location.href="index.html";
        }).catch(error=>{
            isLoggingOut = false; // Reset flag on error
            console.error("Logout Error:",error);
            showAlert("Logout failed. Please try again.","error");
        });
    });
}

// --- Firestore Collection Abstraction ---
const Firestore={getProfile:(uid=userUid)=>db.collection("profiles").doc(uid).get().then(doc=>doc.exists?{uid:doc.id,...doc.data()}:{}),setProfile:(data,uid=userUid)=>db.collection("profiles").doc(uid).set(data,{merge:true}),getJobsPaginated:async(uid=userUid,startAfter=null)=>{let query=db.collection("attendance").doc(uid).collection("entries").orderBy("entryTime","desc");if(startAfter){query=query.startAfter(startAfter);}
const snapshot=await query.limit(JOBS_PER_PAGE).get();const jobs=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));const lastVisible=snapshot.docs[snapshot.docs.length-1];return{jobs,lastVisible};},getAllJobs:(uid=userUid)=>db.collection("attendance").doc(uid).collection("entries").orderBy("entryTime","desc").get().then(snap=>snap.docs.map(doc=>({id:doc.id,...doc.data()}))),addJob:(job,uid=userUid)=>db.collection("attendance").doc(uid).collection("entries").add(job),updateJob:(jobId,data,uid=userUid)=>db.collection("attendance").doc(uid).collection("entries").doc(jobId).update(data),deleteJob:(jobId,uid=userUid)=>db.collection("attendance").doc(uid).collection("entries").doc(jobId).delete(),addIssue:issue=>db.collection("issues").add(issue),getIssues:()=>db.collection("issues").orderBy("timestamp","desc").get().then(snap=>snap.docs.map(doc=>({id:doc.id,...doc.data()}))),
// ***FIX: Changed 'id' to 'uid' for consistency with getProfile function***
getAllUsers:()=>db.collection("profiles").get().then(snap=>snap.docs.map(doc=>({uid:doc.id,...doc.data()}))),
getDailyStatuses:(uid=userUid)=>db.collection("daily_status").doc(uid).collection("entries").get().then(snap=>snap.docs.map(doc=>({id:doc.id,...doc.data()}))),setDailyStatus:(dateString,status,uid=userUid)=>db.collection("daily_status").doc(uid).collection("entries").doc(dateString).set({status}),deleteDailyStatus:(dateString,uid=userUid)=>db.collection("daily_status").doc(uid).collection("entries").doc(dateString).delete(),getActiveCheckins:()=>db.collectionGroup("entries").where("status","==","pending-exit").get().then(snap=>snap.docs.map(doc=>({id:doc.id,uid:doc.ref.parent.parent.id,...doc.data()}))),getOrCreateChatThread:async(userUidToChatWith,userNameToChatWith)=>{const adminName="Support Team";const threadQuery=db.collection('chats').where('participants','array-contains',userUidToChatWith);const snapshot=await threadQuery.get();let threadDoc=snapshot.docs.find(doc=>doc.data().participants.includes(ADMIN_UID));if(threadDoc){return threadDoc.id;}else{const newThreadRef=await db.collection('chats').add({participants:[userUidToChatWith,ADMIN_UID],participantInfo:{[userUidToChatWith]:{name:userNameToChatWith},[ADMIN_UID]:{name:adminName}},lastMessage:"Conversation started.",timestamp:firebase.firestore.FieldValue.serverTimestamp()});return newThreadRef.id;}},sendMessage:(threadId,text,senderId)=>{const threadRef=db.collection('chats').doc(threadId);threadRef.collection('messages').add({text:text,senderId:senderId,timestamp:firebase.firestore.FieldValue.serverTimestamp()});return threadRef.update({lastMessage:text,timestamp:firebase.firestore.FieldValue.serverTimestamp()});},getAdminChats:()=>db.collection('chats').where('participants','array-contains',ADMIN_UID).orderBy('timestamp','desc').get(),getUserChat:()=>db.collection('chats').where('participants','array-contains',userUid).get()};

// --- CHAT UI FUNCTIONS ---
const getInitials = (name) => {if (!name) return '?';const names = name.split(' ');let initials = names[0].substring(0, 1).toUpperCase();if (names.length > 1) {initials += names[names.length - 1].substring(0, 1).toUpperCase();}return initials;};
async function initChats(){if(unsubscribeChatListener)unsubscribeChatListener();$('#chat-app-container').html(getSpinnerHTML());if(isAdmin){await renderAdminChatUI();}else{await renderUserChatUI();}}
async function renderAdminChatUI(){$('#chat-app-container').html(`<div class="chat-layout"><div class="chat-sidebar"><div class="section-title" style="margin:0; padding: 1.5rem 1.5rem 1rem 1.5rem;"><i class="bi bi-chat-dots"></i> Conversations</div><div class="chat-list" id="admin-chat-list"></div></div><div class="chat-window"><div id="admin-chat-window-content" class="d-flex flex-column h-100 justify-content-center align-items-center text-secondary"><i class="bi bi-chat-left-text-fill fs-1"></i><p class="mt-2 fw-bold">Support Team Chat</p><p>Select a conversation to begin.</p></div></div></div>`);try{const snapshot=await Firestore.getAdminChats();const chatList=$('#admin-chat-list').empty();if(snapshot.empty){chatList.html('<p class="p-3 text-secondary">No conversations.</p>');return;}
snapshot.forEach(doc=>{const data=doc.data();const userId=data.participants.find(p=>p!==ADMIN_UID);const name=userId?(data.participantInfo[userId]?.name||'Unknown User'):'Note to Self';const item=$(`<div class="chat-list-item" data-thread-id="${doc.id}" data-partner-name="${escape(name)}"><div class="chat-avatar">${getInitials(name)}</div><div class="chat-info flex-grow-1"><div class="name">${name}</div><div class="last-message">${escape(data.lastMessage)}</div></div></div>`);item.on('click',()=>{if(userId||name==='Note to Self'){const partnerName=$(item).data('partner-name');$('.chat-list-item').removeClass('active');item.addClass('active');loadChatThread(doc.id,partnerName,ADMIN_UID);}});chatList.append(item);});const pendingThreadId=sessionStorage.getItem('pendingChatThreadId');if(pendingThreadId){const partnerName=sessionStorage.getItem('pendingChatPartnerName');sessionStorage.removeItem('pendingChatThreadId');sessionStorage.removeItem('pendingChatPartnerName');$('.chat-list-item').removeClass('active');$(`.chat-list-item[data-thread-id="${pendingThreadId}"]`).addClass('active').trigger('click');}}catch(e){showAlert('Could not load chats. Please check your security rules.','error');}}
async function renderUserChatUI(){try{const snapshot=await Firestore.getUserChat();if(snapshot.empty){$('#chat-app-container').html(`<div class="text-center p-5 text-secondary"><i class="bi bi-chat-dots-fill fs-1"></i><p class="mt-2">No active chats. Report an issue in the Help section to start a conversation with the Support Team.</p></div>`);}else{const threadDoc=snapshot.docs[0];const adminName=threadDoc.data().participantInfo[ADMIN_UID]?.name||"Support Team";loadChatThread(threadDoc.id,adminName,userUid);}}catch(e){showAlert('Could not load your chat.','error');}}
function loadChatThread(threadId,otherPartyName,myId){if(unsubscribeChatListener){unsubscribeChatListener();}
const chatWindow=isAdmin?$('#admin-chat-window-content'):$('#chat-app-container');const html=`<div class="chat-header"><div class="chat-avatar">${getInitials(otherPartyName)}</div> ${otherPartyName}</div><div class="chat-messages"><div class="messages-container-inner"></div></div><div class="chat-input"><div class="input-group"><input type="text" id="chat-message-input" class="form-control" placeholder="Type a message..."><button id="send-chat-btn" class="btn btn-primary"><i class="bi bi-send-fill"></i></button></div></div>`;if(isAdmin){chatWindow.html(html);}else{chatWindow.html(`<div class="chat-layout"><div class="chat-window" style="width:100%; border-left:none;">${html}</div></div>`);}
const sendMessage=()=>{const input=$('#chat-message-input');const text=input.val().trim();if(text){Firestore.sendMessage(threadId,text,myId);input.val('').focus();}};$('#send-chat-btn').on('click',sendMessage);$('#chat-message-input').on('keypress',e=>{if(e.which===13)sendMessage();});const messagesContainer=chatWindow.find('.messages-container-inner');const chatMessagesDiv=chatWindow.find('.chat-messages');unsubscribeChatListener=db.collection('chats').doc(threadId).collection('messages').orderBy('timestamp','asc').onSnapshot(snapshot=>{messagesContainer.empty();snapshot.forEach(doc=>{const msg=doc.data();const sentOrReceived=msg.senderId===myId?'sent':'received';const timestamp=msg.timestamp?new Date(msg.timestamp.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';messagesContainer.append(`<div class="message-bubble ${sentOrReceived}"><div>${escape(msg.text)}</div></div><div class="message-timestamp ${sentOrReceived}">${timestamp}</div>`);});chatMessagesDiv.scrollTop(chatMessagesDiv[0].scrollHeight);},error=>{console.error("Chat listener error:",error);showAlert("Chat disconnected. Please refresh.","error");});}

// --- CORE APP FUNCTIONS ---
async function initDashboard(){$('#checkin-btn').click(handleCheckIn);$('#checkout-btn').click(handleCheckout);$("#filter-select, #start-date, #end-date").change(handleFilterChange);$('#load-more-btn').click(loadMoreJobs);handleFilterChange();}
async function renderStatistics(){$("#statistics-holder").html(getSpinnerHTML());try{const jobs=await Firestore.getAllJobs();const statsHolder=$("#statistics-holder").empty();const today=new Date();today.setHours(0,0,0,0);const last7=new Date();last7.setDate(today.getDate()-6);last7.setHours(0,0,0,0);const last30=new Date();last30.setDate(today.getDate()-29);last30.setHours(0,0,0,0);let todayCount=0,last7Count=0,last30Count=0;jobs.forEach(j=>{if(!j.entryTime)return;const d=new Date(j.entryTime);d.setHours(0,0,0,0);if(d.getTime()===today.getTime())todayCount++;if(d>=last7)last7Count++;if(d>=last30)last30Count++;});statsHolder.html(`<div class="row text-center g-3 g-md-4"><div class="col-6 col-md-3"><div class="stat-box"><h4>${todayCount}</h4><p>Today</p></div></div><div class="col-6 col-md-3"><div class="stat-box"><h4>${last7Count}</h4><p>Last 7 Days</p></div></div><div class="col-6 col-md-3"><div class="stat-box"><h4>${last30Count}</h4><p>Last 30 Days</p></div></div><div class="col-6 col-md-3"><div class="stat-box"><h4>${jobs.length}</h4><p>Total Records</p></div></div></div>`);initAndRenderStatsTravel();}catch(err){showAlert("Could not load statistics.","error");$("#statistics-holder").html('<p class="text-danger text-center">Failed to load data.</p>');}}
async function initAndRenderStatsTravel(){if(!statsMap){try{const{Map}=await google.maps.importLibrary("maps");statsMap=new Map(document.getElementById('stats-map'),{center:{lat:20.5937,lng:78.9629},zoom:5,mapId:'STATS_MAP'});}catch(e){$("#stats-map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');return;}}$("#stats-travel-filter-select, #stats-travel-start-date, #stats-travel-end-date").off('change').on('change',()=>renderTravelStats('stats'));await renderTravelStats('stats');}
async function initProfile(){try{const p=await Firestore.getProfile();$("#prof-email").val(userEmail);$("#prof-username").val(p.username||userEmail.split('@')[0]);$("#prof-fullname").val(p.fullname||userName);$("#prof-contact").val(p.contact||"");$("#profile-form").off('submit').submit(handleProfileSave);$("#home-address-input").val(p.homeLocation?p.homeLocation.address||p.homeLocation.name:'');$("#home-address-form").off('submit').submit(handleHomeAddressSave);}catch(err){showAlert("Could not load your profile data.","error");}}
async function initAdmin(){$('#admin-users-list').html(getSpinnerHTML());try{isAdminSelectMode=false;toggleAdminSelectMode(true);const users=await Firestore.getAllUsers();const userList=$("#admin-users-list").empty();users.forEach(user=>{const displayName=escape(user.fullname||user.email||'Unnamed User');const displayEmail=escape(user.email||'No Email');const userRow=$(`<div class="admin-user-row d-flex align-items-center" data-uid="${user.uid}" data-name="${displayName}"><input type="checkbox" class="form-check-input me-3 admin-user-checkbox"><div class="flex-grow-1"><div>${displayName}</div><div class="email">${displayEmail}</div></div></div>`);userList.append(userRow);});$('.admin-user-row').on('click',handleAdminUserRowClick);$('#admin-toggle-select-mode').off('click').on('click',toggleAdminSelectMode);$('#admin-select-all-users').off('change').on('change',function(){$('#admin-users-list .admin-user-checkbox').prop('checked',this.checked).trigger('change');});$('#admin-export-selected').off('click').on('click',handleMultiExport);$('#admin-delete-selected').off('click').on('click',handleMultiDelete);
$('#admin-filter-select').off('change.admindatepicker').on('change.admindatepicker', function() { $("#admin-start-date, #admin-end-date").toggle($(this).val() === 'custom'); });
await initAdminIssues();await initAdminLiveMap();}catch(err){$("#admin-users-list").html('<p class="text-danger">Failed to load users.</p>');}}
async function initAdminIssues(){const issuesHolder=$("#admin-issues-holder").html(getSpinnerHTML());try{const issues=await Firestore.getIssues();issuesHolder.empty();if(!issues.length){issuesHolder.html("<p class='text-secondary'>No issues reported.</p>");}else{issues.forEach(issue=>{const issueCard=$(`<div class="issue-card"><div class="d-flex justify-content-between align-items-start"><div><strong class="card-place"><i class="bi bi-person-circle me-2"></i> ${escape(issue.userName)}</strong><div class="card-date small mt-1">${new Date(issue.timestamp).toLocaleString()}</div></div><button class="btn btn-sm btn-outline-info chat-btn" data-user-uid="${issue.userUid}" data-user-name="${escape(issue.userName)}"><i class="bi bi-chat-dots-fill"></i> Chat</button></div><hr style="border-color: var(--card-border);"><p class="m-0" style="white-space: pre-wrap;">${escape(issue.message)}</p></div>`);issuesHolder.append(issueCard);});$('.chat-btn').on('click',async function(){const userUid=$(this).data('user-uid');const userName=$(this).data('user-name');const threadId=await Firestore.getOrCreateChatThread(userUid,userName);sessionStorage.setItem('pendingChatThreadId',threadId);sessionStorage.setItem('pendingChatPartnerName',userName);$('.nav-link[data-sec="chats"]').click();});}}catch(err){issuesHolder.html('<p class="text-danger">Failed to load reported issues.</p>');}}
async function initAdminLiveMap(){if(!adminLiveMap){try{const{Map}=await google.maps.importLibrary("maps");adminLiveMap=new Map(document.getElementById('admin-live-map'),{center:BUREAU_VERITAS_KOLKATA,zoom:12,mapId:'ADMIN_LIVE_MAP'});}catch(e){$("#admin-live-map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');return;}}$('#refresh-live-map-btn').off('click').on('click',renderAdminLiveMap);await renderAdminLiveMap();}
async function renderAdminLiveMap(){const btn=$('#refresh-live-map-btn').prop('disabled',true).html('<span class="spinner-border spinner-border-sm"></span>');try {if(!adminLiveMap) return;adminLiveMapMarkers.forEach(marker=>marker.map=null);adminLiveMapMarkers=[];const{AdvancedMarkerElement,PinElement}=await google.maps.importLibrary("marker");const officePin=new PinElement({background:'#ff8c00',borderColor:'#fff',glyphColor:'#fff',scale:1.5});const officeMarker=new AdvancedMarkerElement({position:BUREAU_VERITAS_KOLKATA,map:adminLiveMap,title:'Bureau Veritas (Kolkata)',content:officePin.element});adminLiveMapMarkers.push(officeMarker);const activeCheckins = await Firestore.getActiveCheckins();if(activeCheckins.length===0){ showAlert('No active employees on the map.','info'); }
const userProfiles=await Promise.all([...new Set(activeCheckins.map(c=>c.uid))].map(uid=>Firestore.getProfile(uid)));const profileMap=new Map(userProfiles.map(p=>[p.uid,p]));activeCheckins.forEach(checkin=>{const profile=profileMap.get(checkin.uid);if(profile&&checkin.coords){const userPin=new PinElement({background:'#334bf9',glyph:profile.fullname.charAt(0)});const userMarker=new AdvancedMarkerElement({position:checkin.coords,map:adminLiveMap,title:`${profile.fullname}\nSite: ${checkin.place}\nChecked in: ${new Date(checkin.entryTime).toLocaleString()}`,content:userPin.element});adminLiveMapMarkers.push(userMarker);}});showAlert('Live map updated.','success');} catch(err){console.error("Firebase Error! This is likely a permissions issue. Check your Firestore Security Rules.", err);showAlert("Live map failed. Please check the browser console (F12) for error details.", "error");} finally {btn.prop('disabled',false).html('<i class="bi bi-arrow-clockwise"></i> Refresh');}}
function initHelp(){$("#help-form").off('submit').submit(handleHelpRequest).attr('data-initialized','true');}
function getSpinnerHTML(){return`<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div></div>`;}
async function setupAdminView(uid,profile){const container=$('#admin-view-container').empty();container.html(`<ul class="nav nav-tabs admin-view-tabs nav-fill" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#records-pane-${uid}" type="button">Records</button></li><li class="nav-item" role="presentation"><button class="nav-link" id="calendar-tab-${uid}" data-bs-toggle="tab" data-bs-target="#calendar-pane-${uid}" type="button">Calendar</button></li></ul><div class="tab-content"><div class="tab-pane fade show active" id="records-pane-${uid}" role="tabpanel"><div id="admin-summary-stats" class="mt-3"></div><div id="admin-records-list" class="mt-3" style="max-height: 500px; overflow-y: auto;"></div></div><div class="tab-pane fade" id="calendar-pane-${uid}" role="tabpanel"><div id="admin-detail-calendar-${uid}" class="mt-3" style="min-height: 400px;"></div></div></div>`);
    $('#admin-refresh-user-data').off('click').on('click', () => loadAndRenderAdminUserData(uid, profile));
    $('#admin-filter-select, #admin-start-date, #admin-end-date').off('change.singleuserview').on('change.singleuserview', () => {
         if ($('#admin-user-details-wrapper').is(':visible') && $('.admin-user-row.active').data('uid') === uid) {
             loadAndRenderAdminUserData(uid, profile);
         }
    });
    await loadAndRenderAdminUserData(uid, profile);
    const calendarTab=document.querySelector(`#calendar-tab-${uid}`);let isCalendarInitialized=false;if(calendarTab){calendarTab.addEventListener('shown.bs.tab',()=>{if(!isCalendarInitialized){initializeFullCalendar(uid,`admin-detail-calendar-${uid}`,true);isCalendarInitialized=true;}},{once:true});}}
async function loadAndRenderAdminUserData(uid, profile) {
    const allJobs = await Firestore.getAllJobs(uid);
    const filteredJobs = filterJobs(allJobs, $('#admin-filter-select').val(), 'admin');
    renderAdminSummary(filteredJobs, profile);
    renderAdminDetails(filteredJobs, profile, uid);
    showAlert('User data refreshed.', 'success');
}
function renderAdminSummary(jobs,profile){const summaryContainer=$('#admin-summary-stats').empty();const homeCoords=profile.homeLocation?.coords;let totalDistance=0;const validJobs=jobs.filter(j=>j.coords&&j.entryTime);if(homeCoords){validJobs.forEach(job=>{totalDistance+=(getDistanceKm(homeCoords,job.coords)*2);});}summaryContainer.html(`<div class="row text-center g-3"><div class="col-6"><div class="stat-box"><h4>${jobs.length}</h4><p>Total Records</p></div></div><div class="col-6"><div class="stat-box"><h4>${homeCoords?totalDistance.toFixed(1):'N/A'} <small>km</small></h4><p>Total Distance</p></div></div></div>`);}
function renderAdminDetails(jobs,profile,uid){const container=$("#admin-records-list").empty();if(!jobs||jobs.length===0){container.html("<p class='text-secondary mt-3 text-center'>No records found for this user for the selected period.</p>");return;}
const homeCoords=profile.homeLocation?.coords;jobs.forEach(job=>{const duration=job.exitTime?calculateDuration(job.entryTime,job.exitTime):'Ongoing';let distanceText=`<span class="text-secondary fst-italic">No travel data</span>`;if(homeCoords&&job.coords){const roundTrip=getDistanceKm(homeCoords,job.coords)*2;distanceText=`<i class="bi bi-geo-alt"></i> ${roundTrip.toFixed(1)} km`;}else if(!homeCoords){distanceText=`<i class="bi bi-geo-alt"></i> <span class="text-secondary fst-italic" title="Set a home address in the user's profile to calculate distance.">No home set</span>`;}
const card=$(`<div class="attendance-card" id="admin-job-${job.id}"><div class="card-summary d-flex align-items-center" style="cursor: pointer;"><span class="status-dot ${job.status==='completed'?'completed':'pending'} me-3"></span><div class="flex-grow-1"><div class="card-place">${escape(job.place)}</div><div class="card-date small d-flex justify-content-between align-items-center"><span>${new Date(job.entryTime).toLocaleDateString()}</span><span class="text-info fw-bold">${distanceText}</span></div></div><i class="bi bi-chevron-down ms-3"></i></div><div class="record-details admin-record-details" style="display:none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--card-border);"><div class="row g-3"><div class="col-lg-7"><p class="mb-2"><strong><i class="bi bi-stopwatch text-info me-2"></i>Duration:</strong> ${duration}</p><p class="mb-2"><strong><i class="bi bi-box-arrow-in-right text-success me-2"></i>Entry:</strong> ${new Date(job.entryTime).toLocaleString()}</p>${job.exitTime?`<p class="mb-2"><strong><i class="bi bi-box-arrow-right text-warning me-2"></i>Exit:</strong> ${new Date(job.exitTime).toLocaleString()}</p>`:'<p class="text-secondary mb-2"><i class="bi bi-box-arrow-right me-2"></i>Exit not marked.</p>'}<p class="small text-secondary mb-0 mt-3"><strong><i class="bi bi-geo-alt me-2"></i>Address:</strong> ${escape(job.address)}</p></div><div class="col-lg-5 d-flex gap-2 justify-content-center align-items-start"><div class="text-center"><a class="view-photo-btn" data-img-src="${job.entryPhoto}"><img src="${job.entryPhoto}"></a><div class="small mt-1">Entry Photo</div></div>${job.exitPhoto?`<div class="text-center"><a class="view-photo-btn" data-img-src="${job.exitPhoto}"><img src="${job.exitPhoto}"></a><div class="small mt-1">Exit Photo</div></div>`:''}</div></div><div class="text-end mt-3"><button class="btn btn-outline-danger btn-sm admin-delete-btn" data-jobid="${job.id}"><i class="bi bi-trash"></i> Delete Record</button></div></div></div>`);card.find('.card-summary').click(function(){$(this).next('.record-details').slideToggle(300);$(this).find('i').toggleClass('bi-chevron-down bi-chevron-up');});card.find('.admin-delete-btn').click(async function(){const jobId=$(this).data('jobid');if(confirm("Are you sure you want to permanently delete this record? This action cannot be undone.")){try{await Firestore.deleteJob(jobId,uid);const cardElement=$(`#admin-job-${jobId}`);gsap.to(cardElement,{opacity:0,height:0,margin:0,padding:0,duration:0.5,onComplete:()=>cardElement.remove()});showAlert('Record deleted successfully.','success');}catch(err){showAlert('Failed to delete the record.','error');}}});container.append(card);});}
async function initMaps(){try{const{Map}=await google.maps.importLibrary("maps");const markerLib=await google.maps.importLibrary("marker");const placesLib=await google.maps.importLibrary("places");AdvancedMarkerElement=markerLib.AdvancedMarkerElement;PinElement=markerLib.PinElement;map=new Map(document.getElementById('map'),{center:{lat:20.5937,lng:78.9629},zoom:5,mapId:'DASHBOARD_MAP'});const siteSearchInput=document.getElementById('site-search-input');const siteAutocomplete=new placesLib.Autocomplete(siteSearchInput);siteAutocomplete.addListener('place_changed',()=>{const place=siteAutocomplete.getPlace();if(!place.geometry||!place.geometry.location)return;selectedPlace=place;if(siteMarker)siteMarker.position=null;siteMarker=new AdvancedMarkerElement({map,position:place.geometry.location.toJSON()});map.panTo(place.geometry.location);map.setZoom(16);});const homeAddressInput=document.getElementById('home-address-input');const homeAutocomplete=new placesLib.Autocomplete(homeAddressInput);homeAutocomplete.addListener('place_changed',()=>{homePlace=homeAutocomplete.getPlace();if(homePlace?.formatted_address){homeAddressInput.value=homePlace.formatted_address;$('#home-valid-icon').fadeIn();}});$(homeAddressInput).on('input',()=>{homePlace=null;$('#home-valid-icon').fadeOut();});setupGeolocationWatcher();}catch(e){$("#map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');$("#gps-status").html('<i class="bi bi-exclamation-triangle-fill text-danger"></i> Map services failed to load.');}}
function setupGeolocationWatcher(){const gpsStatus=$('#gps-status');if(navigator.geolocation){navigator.geolocation.watchPosition((pos)=>{userLat=pos.coords.latitude;userLng=pos.coords.longitude;const currentPos={lat:userLat,lng:userLng};gpsStatus.html(`<i class="bi bi-geo-alt-fill text-success"></i> GPS Lock Acquired`);if(!userLiveMarker){const pin=new PinElement({background:'#4285F4',borderColor:'#FFFFFF',glyphColor:'#FFFFFF'});userLiveMarker=new AdvancedMarkerElement({position:currentPos,map,content:pin.element});map.setCenter(currentPos);map.setZoom(15);}else{userLiveMarker.position=currentPos;}},(err)=>{let message="Could not get your location.";if(err.code===1)message="Location access denied. Please enable it in your browser settings.";gpsStatus.html(`<i class="bi bi-exclamation-triangle-fill text-danger"></i> ${message}`);},{enableHighAccuracy:true,timeout:10000,maximumAge:0});}else{gpsStatus.text("Geolocation is not supported by this browser.");}}
function handleFilterChange(){const filter=$("#filter-select").val();$("#start-date, #end-date").toggle(filter==='custom');$("#attendance-cards").empty();lastVisibleJob=null;$('#load-more-container').hide();loadMoreJobs();}
async function loadMoreJobs(){const loadMoreBtn=$('#load-more-btn').prop('disabled',true).html('<span class="spinner-border spinner-border-sm"></span> Loading...');try{const{jobs,lastVisible}=await Firestore.getJobsPaginated(userUid,lastVisibleJob);lastVisibleJob=lastVisible;if(jobs.length===0&&$("#attendance-cards").children().length===0){$("#attendance-cards").html(`<p class='text-center text-secondary'>No site visit records for this period.</p>`);$('#load-more-container').hide();return;}appendJobCards(jobs);if(jobs.length<JOBS_PER_PAGE){$('#load-more-container').hide();}else{$('#load-more-container').show();}}catch(err){showAlert("Failed to load attendance records.","error");}finally{loadMoreBtn.prop('disabled',false).html('Load More');}}
function appendJobCards(jobs){const filteredJobs=filterJobs(jobs,$("#filter-select").val(),'attendance');const container=$("#attendance-cards");filteredJobs.forEach(job=>{const duration=job.exitTime?calculateDuration(job.entryTime,job.exitTime):'Ongoing';const card=$(`<div class="attendance-card" data-id="${job.id}"><div class="card-summary d-flex align-items-center" style="cursor:pointer;"><span class="status-dot ${job.status==='completed'?'completed':'pending'} me-2"></span><span class="card-place flex-grow-1">${escape(job.place)}</span><span class="card-date">${new Date(job.entryTime).toLocaleDateString()}</span><i class="bi bi-chevron-down ms-3"></i></div><div class="record-details" style="display:none; margin-top: 1rem;"><p class="small mb-2"><strong>Duration:</strong> ${duration}</p><div class="d-flex gap-3 flex-wrap align-items-center"><div class="text-center"><a class="view-photo-btn" data-img-src="${job.entryPhoto}"><img src="${job.entryPhoto}" class="rounded" style="width:100px; height: 100px; object-fit: cover;"></a><div class="small mt-1">Entry</div></div>${job.exitPhoto?`<div class="text-center"><a class="view-photo-btn" data-img-src="${job.exitPhoto}"><img src="${job.exitPhoto}" class="rounded" style="width:100px; height: 100px; object-fit: cover;"></a><div class="small mt-1">Exit</div></div>`:''}<div class="small"><strong>Entry:</strong> ${new Date(job.entryTime).toLocaleString()}<br>${job.exitTime?`<strong>Exit:</strong> ${new Date(job.exitTime).toLocaleString()}`:''}</div></div><button class="btn btn-outline-danger btn-sm mt-3 delete-record-btn">Delete</button></div></div>`);card.find('.card-summary').click(function(){$(this).next('.record-details').slideToggle(300);$(this).find('i').toggleClass('bi-chevron-down bi-chevron-up');});card.find('.delete-record-btn').click(async function(){const cardElement=$(this).closest('.attendance-card');if(confirm("Delete this record?")){try{await Firestore.deleteJob(cardElement.data('id'));gsap.to(cardElement,{opacity:0,height:0,margin:0,padding:0,duration:0.5,onComplete:()=>{cardElement.remove();if($('#statistics').is(':visible'))renderStatistics();if(fullCalendar)fullCalendar.refetchEvents();}});}catch(err){showAlert("Failed to delete record.","error");}}});container.append(card);});}
async function handleCheckIn(){if(!userLat||!userLng)return showAlert("Waiting for GPS signal.","warning");if(!selectedPlace)return showAlert("Please select a site from the map first.","error");try{if((await Firestore.getAllJobs()).some(j=>j.status==="pending-exit"))return showAlert("You already have a pending check-in.","error");if(getDistance(userLat,userLng,selectedPlace.geometry.location.lat(),selectedPlace.geometry.location.lng())<=500){openCamera('entry');}else{showAlert(`You must be within 500m of the site to mark entry.`,'error');}}catch(err){showAlert("Could not verify check-in status.","error");}}
async function handleCheckout(){if(!userLat||!userLng)return showAlert("Waiting for GPS signal.","warning");if(!selectedPlace)return showAlert("Please select the site you are checking out from.","error");try{if(!(await Firestore.getAllJobs()).some(j=>j.status==="pending-exit"))return showAlert("No active check-in found.","error");if(getDistance(userLat,userLng,selectedPlace.geometry.location.lat(),selectedPlace.geometry.location.lng())<=1000){openCamera('exit');}else{showAlert(`You must be within 1km of the site to mark exit.`,'error');}}catch(err){showAlert("Could not verify check-out status.","error");}}
async function finishAttendance(type,photo){const location=selectedPlace.geometry.location;const jobData={place:selectedPlace.name||"Unknown",address:selectedPlace.formatted_address||"N/A",coords:{lat:location.lat(),lng:location.lng()}};try{if(type==='entry'){Object.assign(jobData,{entryTime:new Date().toISOString(),entryPhoto:photo,status:"pending-exit"});await Firestore.addJob(jobData);showAlert("Entry marked successfully!",'success');}else{const pendingJob=(await Firestore.getAllJobs()).find(j=>j.status==="pending-exit");if(pendingJob){await Firestore.updateJob(pendingJob.id,{exitTime:new Date().toISOString(),exitPhoto:photo,status:"completed"});showAlert("Exit marked successfully!",'success');}}handleFilterChange();if($('#statistics').is(':visible'))renderStatistics();if(fullCalendar)fullCalendar.refetchEvents();}catch(err){showAlert("Error saving attendance.","error");}}
async function handleProfileSave(e){e.preventDefault();try{await Firestore.setProfile({email:userEmail,username:$("#prof-username").val(),fullname:$("#prof-fullname").val(),contact:$("#prof-contact").val()});showAlert('Profile saved!','success');}catch(err){showAlert('Failed to save profile.','error');}}
async function handleHomeAddressSave(e){e.preventDefault();if(!homePlace){return showAlert('Please select an address from the list.','warning');}const homeData={homeLocation:{name:homePlace.name,address:homePlace.formatted_address,coords:{lat:homePlace.geometry.location.lat(),lng:homePlace.geometry.location.lng()}}};try{await Firestore.setProfile(homeData);$('#home-valid-icon').fadeOut();showAlert('Home address saved!','success');if($('#statistics-holder').children().length)await renderTravelStats('stats');}catch(err){showAlert('Failed to save home address.','error');}}
async function renderTravelStats(type='profile'){if(typeof google==='undefined'||!google.maps?.geometry){setTimeout(()=>renderTravelStats(type),250);return;}const detailsId=`#${type}-travel-details`;const summaryId=`#${type}-travel-summary`;$(detailsId).html(getSpinnerHTML());if($(summaryId))$(summaryId).empty();try{const[userProfile,allJobs]=await Promise.all([Firestore.getProfile(),Firestore.getAllJobs()]);$(detailsId).empty();if(!userProfile.homeLocation?.coords){$(detailsId).html(`<p class='text-secondary text-center mt-3'><i class='bi bi-info-circle-fill me-2'></i>Set home address in Profile to view travel stats.</p>`);if(type==='stats')updateStatsMap([],null);return;}const homeCoords=userProfile.homeLocation.coords;const filter=$(`#${type}-travel-filter-select`).val();$(`#${type}-travel-start-date, #${type}-travel-end-date`).toggle(filter==='custom');const filteredJobs=filterJobs(allJobs,filter,`${type}-travel`);let totalDistance=0;const validJobs=filteredJobs.filter(j=>j&&j.coords&&j.entryTime);if(type==='stats'){updateStatsMap(validJobs,userProfile);}if(validJobs.length===0){$(detailsId).html("<p class='text-center text-secondary mt-3'>No travel data for this period.</p>");if($(summaryId))$(summaryId).empty();return;}validJobs.forEach(job=>{const roundTripDistance=getDistanceKm(homeCoords,job.coords)*2;totalDistance+=roundTripDistance;$(detailsId).append(`<div class="travel-card"><div class="d-flex justify-content-between align-items-center"><div><div class="card-place">${escape(job.place)}</div><div class="card-date small">${new Date(job.entryTime).toLocaleDateString()}</div></div><div class="text-end"><h5 class="mb-0 text-accent">${roundTripDistance.toFixed(1)} km</h5><small class="text-secondary">Round Trip</small></div></div></div>`);});if($(summaryId)){$(summaryId).html(`<div class="row g-3 g-md-4 text-center"><div class="col-6"><div class="stat-box"><h4>${totalDistance.toFixed(1)} <small>km</small></h4><p>Total Distance</p></div></div><div class="col-6"><div class="stat-box"><h4>${validJobs.length}</h4><p>Total Trips</p></div></div></div>`);}}catch(err){showAlert("Could not load travel statistics.","error");$(detailsId).html("<p class='text-center text-danger'>Failed to load travel data.</p>");}}
async function updateStatsMap(jobs,profile){if(!statsMap)return;statsMapMarkers.forEach(marker=>marker.map=null);statsMapMarkers=[];const bounds=new google.maps.LatLngBounds();const{AdvancedMarkerElement,PinElement}=await google.maps.importLibrary("marker");if(profile&&profile.homeLocation?.coords){const homePos=profile.homeLocation.coords;const homePin=new PinElement({background:'#10B981',borderColor:'#fff',glyphColor:'#fff'});const homeMarker=new AdvancedMarkerElement({position:homePos,map:statsMap,title:'Home',content:homePin.element});statsMapMarkers.push(homeMarker);bounds.extend(homePos);}jobs.forEach(job=>{if(job.coords){const jobPos=job.coords;const jobMarker=new AdvancedMarkerElement({position:jobPos,map:statsMap,title:job.place});statsMapMarkers.push(jobMarker);bounds.extend(jobPos);}});if(statsMapMarkers.length>0){statsMap.fitBounds(bounds);if(statsMap.getZoom()>15){statsMap.setZoom(15);}if(statsMapMarkers.length===1&&bounds.getNorthEast().equals(bounds.getSouthWest())){statsMap.setCenter(bounds.getCenter());statsMap.setZoom(12);}}else{statsMap.setCenter({lat:20.5937,lng:78.9629});statsMap.setZoom(5);}}
async function handleHelpRequest(e){e.preventDefault();const message=$("#help-message").val();if(!message.trim())return;try{await Firestore.addIssue({userUid,userEmail,userName,message,timestamp:new Date().toISOString()});showAlert('Your message has been sent.','success');$("#help-message").val('');}catch(err){showAlert('Could not send your message.','error');}}
function openCamera(type){$("#camera-overlay").css("display","flex");const video=$("#video")[0];const constraints={video:{facingMode:usingFront?'user':'environment',width:{ideal:1280},height:{ideal:720}}};const startCam=()=>{if(globalStream){globalStream.getTracks().forEach(track=>track.stop());}navigator.mediaDevices.getUserMedia(constraints).then(stream=>{video.srcObject=stream;globalStream=stream;}).catch(err=>{let message="Could not access camera.";if(err.name==="NotAllowedError"){message="Camera access was denied.";}else if(err.name==="NotFoundError"){message="No camera was found.";}showAlert(message,'error');$("#camera-overlay").hide();});};startCam();$("#snap-btn").off().click(()=>{const canvas=$("#canvas")[0];canvas.width=video.videoWidth;canvas.height=video.videoHeight;const context=canvas.getContext('2d');if(usingFront){context.translate(canvas.width,0);context.scale(-1,1);}context.drawImage(video,0,0,canvas.width,canvas.height);const photo=canvas.toDataURL('image/jpeg',0.8);if(globalStream)globalStream.getTracks().forEach(track=>track.stop());$("#camera-overlay").hide();finishAttendance(type,photo);});$("#flip-btn").off().click(()=>{usingFront=!usingFront;constraints.video.facingMode=usingFront?'user':'environment';startCam();});$("#cancel-btn").off().click(()=>{if(globalStream)globalStream.getTracks().forEach(track=>track.stop());$("#camera-overlay").hide();});}
$(document).on('click','.view-photo-btn',function(e){e.preventDefault();const imgSrc=$(this).data('img-src');$('#fullscreen-image').attr('src',imgSrc);$('#image-viewer').css('display','flex').hide().fadeIn(200);});
function getDistance(lat1,lon1,lat2,lon2){if(lat1===null||lon1===null||!google?.maps?.geometry)return Infinity;const from=new google.maps.LatLng(lat1,lon1);const to=new google.maps.LatLng(lat2,lon2);return google.maps.geometry.spherical.computeDistanceBetween(from,to);}
function getDistanceKm(coords1,coords2){if(!coords1||!coords2||!google?.maps?.geometry)return 0;const from=new google.maps.LatLng(coords1.lat,coords1.lng);const to=new google.maps.LatLng(coords2.lat,coords2.lng);return google.maps.geometry.spherical.computeDistanceBetween(from,to)/1000;}
function escape(t){return t?String(t).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])):"";}
function filterJobs(jobs,filter,type){const now=new Date();const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());const startDateInput=`#${type}-start-date`;const endDateInput=`#${type}-end-date`;switch(filter){case'yesterday':const yesterday=new Date(today);yesterday.setDate(today.getDate()-1);return jobs.filter(j=>{if(!j||!j.entryTime)return false;try{const entryDate=new Date(j.entryTime);return entryDate>=yesterday&&entryDate<today;}catch(e){return false;}});case'last7':const last7=new Date(today);last7.setDate(today.getDate()-6);return jobs.filter(j=>j&&j.entryTime&&new Date(j.entryTime)>=last7);case'last30':const last30=new Date(today);last30.setDate(today.getDate()-29);return jobs.filter(j=>j&&j.entryTime&&new Date(j.entryTime)>=last30);case'custom':const startStr=$(startDateInput).val();const endStr=$(endDateInput).val();if(!startStr||!endStr)return[];const sDate=new Date(startStr);sDate.setHours(0,0,0,0);const eDate=new Date(endStr);eDate.setHours(23,59,59,999);return jobs.filter(j=>{if(!j||!j.entryTime)return false;try{const entryDate=new Date(j.entryTime);return entryDate>=sDate&&entryDate<=eDate;}catch(e){return false;}});default:return jobs;}}
function calculateDuration(startTime,endTime){if(!startTime||!endTime)return'N/A';const start=new Date(startTime);const end=new Date(endTime);let diff=Math.abs(end.getTime()-start.getTime())/1000;const hours=Math.floor(diff/3600);diff%=3600;const minutes=Math.floor(diff/60);return`${hours}h ${minutes}m`;}
function showAlert(message,type='info'){const alertBox=$('#global-alert-container');let alertClass='alert-info';if(type==='success')alertClass='alert-success';if(type==='error')alertClass='alert-danger';if(type==='warning')alertClass='alert-warning';const alertId='alert-'+Date.now();const newAlert=$(`<div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert" style="box-shadow: 0 5px 15px rgba(0,0,0,0.3);">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);alertBox.append(newAlert);setTimeout(()=>{ $(`#${alertId}`).fadeOut(500,function(){$(this).remove();});},5000);}
function toggleAdminSelectMode(forceOff=false){isAdminSelectMode=forceOff?false:!isAdminSelectMode;const btn=$('#admin-toggle-select-mode');const userCard=$('#admin-user-selection-card');userCard.toggleClass('select-mode-active',isAdminSelectMode);if(isAdminSelectMode){btn.html('<i class="bi bi-x-lg me-2"></i>Cancel').removeClass('btn-primary').addClass('btn-secondary');$('#admin-user-details-wrapper').slideUp(200);$('#admin-users-list .admin-user-row').removeClass('active');$('#admin-select-all-container').slideDown(200);}else{btn.html('<i class="bi bi-check2-square me-2"></i>Select Multiple').removeClass('btn-secondary').addClass('btn-primary');$('#admin-users-list .admin-user-checkbox').prop('checked',false);$('#admin-select-all-users').prop('checked',false);$('#admin-actions-bar').slideUp(200);$('#admin-select-all-container').slideUp(200);}}
function handleAdminUserRowClick(){if(isAdminSelectMode){const checkbox=$(this).find('.admin-user-checkbox');checkbox.prop('checked',!checkbox.prop('checked')).trigger('change');}else{$('#admin-users-list .admin-user-row').removeClass('active');$(this).addClass('active');handleAdminSingleUserView($(this).data('uid'));}}
$('#admin-users-list').on('change','.admin-user-checkbox',toggleAdminActionsBar);
async function handleAdminSingleUserView(uid){const detailsWrapper=$("#admin-user-details-wrapper");gsap.to(detailsWrapper,{opacity:0,duration:0.2,onComplete:async()=>{try{const profile=await Firestore.getProfile(uid);$("#admin-selected-user-name").text(`${profile.fullname||profile.email}'s Records`);$("#admin-selected-user-contact").html(`<i class="bi bi-envelope-fill"></i> ${profile.email} | <i class="bi bi-telephone-fill"></i> ${profile.contact||'Not Provided'}`);detailsWrapper.css('display','block');$('#admin-view-container').html(getSpinnerHTML());await setupAdminView(uid,profile);gsap.to(detailsWrapper,{opacity:1,duration:0.3});}catch(err){showAlert("Could not load user details.","error");detailsWrapper.hide();}}});}
function toggleAdminActionsBar(){const selectedCount=$('#admin-users-list .admin-user-checkbox:checked').length;if(selectedCount>0){$('#admin-actions-bar').slideDown(200);}else{$('#admin-actions-bar').slideUp(200);}const allCheckboxes=$('#admin-users-list .admin-user-checkbox');$('#admin-select-all-users').prop('checked',allCheckboxes.length>0&&selectedCount===allCheckboxes.length);}
async function handleMultiExport(){const selectedCheckboxes=$('#admin-users-list .admin-user-checkbox:checked');if(selectedCheckboxes.length===0)return showAlert('Please select at least one user.','warning');showAlert('Preparing export...','info');const wb=XLSX.utils.book_new();for(const checkbox of selectedCheckboxes){const row=$(checkbox).closest('.admin-user-row');const uid=row.data('uid');const name=(row.data('name')||'user').replace(/[\\/*?:"<>|]/g,'');const[profile,allJobs]=await Promise.all([Firestore.getProfile(uid),Firestore.getAllJobs(uid)]);const jobs=filterJobs(allJobs,$('#admin-filter-select').val(),'admin');if(jobs.length>0){const dataToExport=jobs.map(job=>{let oneWayDist='N/A';if(profile.homeLocation?.coords&&job.coords){oneWayDist=`${getDistanceKm(profile.homeLocation.coords,job.coords).toFixed(2)} km`;}return{"Site Name":job.place,"Address":job.address,"Entry Time":job.entryTime?new Date(job.entryTime).toLocaleString():'',"Exit Time":job.exitTime?new Date(job.exitTime).toLocaleString():'',"Status":job.status,"Duration":job.exitTime?calculateDuration(job.entryTime,job.exitTime):'',"One-Way Distance":oneWayDist};});const ws=XLSX.utils.json_to_sheet(dataToExport);XLSX.utils.book_append_sheet(wb,ws,name.substring(0,31));}}if(wb.SheetNames.length>0){XLSX.writeFile(wb,`Multi-User_Attendance_Export.xlsx`);}else{showAlert('No data found for the selected users.','info');}}
async function handleMultiDelete(){const selectedCheckboxes=$('#admin-users-list .admin-user-checkbox:checked');if(selectedCheckboxes.length===0)return showAlert('Please select at least one user.','warning');const filter=$('#admin-filter-select').val();if(!confirm(`Are you sure you want to delete records in the selected time frame for ${selectedCheckboxes.length} user(s)? This cannot be undone.`))return;showAlert('Deletion in progress...','info');let deleteCount=0;for(const checkbox of selectedCheckboxes){const uid=$(checkbox).closest('.admin-user-row').data('uid');const jobsToDelete=filterJobs(await Firestore.getAllJobs(uid),filter,'admin');const deletePromises=jobsToDelete.map(job=>Firestore.deleteJob(job.id,uid));await Promise.all(deletePromises);deleteCount+=jobsToDelete.length;}showAlert(`${deleteCount} record(s) deleted successfully.`,'success');toggleAdminSelectMode(true);}
function yyyymmdd(date){const y=date.getFullYear();const m=String(date.getMonth()+1).padStart(2,'0');const d=String(date.getDate()).padStart(2,'0');return`${y}-${m}-${d}`;}

async function showDayDetailModal(dateStr, uid = userUid) {
    const date = new Date(dateStr + 'T00:00:00');
    $('#modal-date-display').text(date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
    const [jobsSnapshot, dailyStatusSnapshot] = await Promise.all([
        db.collection("attendance").doc(uid).collection("entries").get(),
        db.collection("daily_status").doc(uid).collection("entries").get()
    ]);
    const eventsOnDay = [];
    jobsSnapshot.forEach(doc => {const job = doc.data(); if (job.entryTime && yyyymmdd(new Date(job.entryTime)) === dateStr) { eventsOnDay.push({ title: 'On-Site Visit' }); }});
    const dailyStatusDoc = dailyStatusSnapshot.docs.find(doc => doc.id === dateStr);
    if (dailyStatusDoc) { const status = dailyStatusDoc.data().status; if (status === 'office') eventsOnDay.push({ title: 'Office Work' }); else if (status === 'leave') eventsOnDay.push({ title: 'On Leave' }); }
    const detailsHtml = eventsOnDay.length > 0 ? eventsOnDay.map(event => `<p class="mb-1">${event.title}</p>`).join('') : `<p class="text-secondary">No activity recorded.</p>`;
    $('#modal-event-details').html(detailsHtml);
    $('#modal-mark-office-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, 'office'));
    $('#modal-mark-leave-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, 'leave'));
    $('#modal-mark-clear-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, null));
    dayDetailModal.show();
}

async function handleDailyStatusUpdate(dateString, status) {
    try {
        if (status) { await Firestore.setDailyStatus(dateString, status); }
        else { await Firestore.deleteDailyStatus(dateString); }
        showAlert('Attendance updated successfully.', 'success');
        if (fullCalendar) { fullCalendar.refetchEvents(); }
        if (adminDetailCalendar) { adminDetailCalendar.refetchEvents(); }
    } catch (err) {
        showAlert('Failed to update attendance status.', 'error');
    } finally {
        dayDetailModal.hide();
    }
}

function initializeFullCalendar(uid=userUid,targetElId='dashboard-calendar',isReadOnly=false){
    const calendarEl=document.getElementById(targetElId);
    if(!calendarEl) return;
    let calendarInstance = isReadOnly ? adminDetailCalendar : fullCalendar;
    if(calendarInstance) { calendarInstance.destroy(); }
    
    const isMobile = window.innerWidth < 768;

    calendarInstance=new FullCalendar.Calendar(calendarEl,{
        height: isMobile ? 'auto' : '100%',
        initialView: 'dayGridMonth',
        headerToolbar: {left:'prev,next today',center:'title',right: isMobile ? '' : 'dayGridMonth,listWeek'},
        dayHeaderFormat: isMobile ? { weekday: 'narrow' } : { weekday: 'short' },
        events: async function(fetchInfo,successCallback,failureCallback){
            try{
                const[jobsSnapshot,dailyStatusSnapshot]=await Promise.all([
                    db.collection("attendance").doc(uid).collection("entries").get(),
                    db.collection("daily_status").doc(uid).collection("entries").get()
                ]);
                const eventMap=new Map();
                jobsSnapshot.forEach(doc=>{const job=doc.data();if(job.entryTime){const dateStr=yyyymmdd(new Date(job.entryTime));if(!eventMap.has(dateStr))eventMap.set(dateStr,new Set());eventMap.get(dateStr).add('site-visit');}});
                dailyStatusSnapshot.forEach(doc=>{const status=doc.data().status;const dateStr=doc.id;if(!eventMap.has(dateStr))eventMap.set(dateStr,new Set());eventMap.get(dateStr).add(status);});
                
                const events = [];
                eventMap.forEach((types, date) => {
                    let eventData = { start: date, allDay: true };
                    // Use a priority for coloring: Leave > Site Visit > Office
                    if (types.has('leave')) {
                        eventData.display = 'background';
                        eventData.color = 'rgba(231, 76, 60, 0.5)';
                    } else if (types.has('site-visit')) {
                        eventData.display = 'background';
                        eventData.color = 'rgba(46, 204, 113, 0.4)';
                    } else if (types.has('office')) {
                        eventData.display = 'background';
                        eventData.color = 'rgba(67, 191, 255, 0.4)';
                    }
                    events.push(eventData);
                });
                successCallback(events);
            } catch(error){ failureCallback(error); }
        },
        dateClick:function(info){
            if(isReadOnly) return;
            showDayDetailModal(info.dateStr, uid);
        }
    });
    
    if(isReadOnly){adminDetailCalendar=calendarInstance;}
    else{fullCalendar=calendarInstance;}
    
    calendarInstance.render();
}
</script>

</body>
</html>
