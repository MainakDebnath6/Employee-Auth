<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard â€“ Engineer Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  
  <!-- Vanilla Calendar CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.css"/>
  
  <!-- jQuery and GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <!-- Vanilla Calendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.js"></script>
  
  <style>
    body, html {
      background: #f6f7fa;
      min-height: 100vh;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      max-width: 1160px;
      margin: 2.2rem auto;
      background: #fff;
      border-radius: 18px;
      padding: 2.5rem 2.2rem 2.4rem;
      box-shadow: 0 7px 36px #e2e2e842, 0 2px 7px #b8b8b81f;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-wrap: wrap;
      margin-bottom: 1.9rem;
      justify-content: space-between;
    }
    .logo-small {
      width: 92px;
      filter: grayscale(15%);
    }
    #user-name {
      font-weight: 800;
      color: #26312a;
      font-size: 1.32rem;
      flex-grow: 1;
    }
    #logout {
      background: #e0e1e2;
      color: #444;
      font-weight: 700;
      border-radius: 20px;
      min-width: 105px;
      height: 45px;
      border: none;
      font-size: 1rem;
      transition: background 0.2s;
      cursor: pointer;
    }
    #logout:hover {
      background: #bbb;
      color: #111;
    }

    /* Calendar popup toggle button */
    .calendar-popup-toggle {
      text-align: center;
      margin-bottom: 1.8rem;
    }
    #open-calendar-btn {
      font-weight: 600;
      font-size: 1.14rem;
      cursor: pointer;
    }

    /* Calendar modal overlay */
    #calendar-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(60,70,95,0.12);
      z-index: 9999;
    }
    /* Calendar modal window */
    #calendar-modal-window {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 1.2em 1.2em 0.8em 1.2em;
      border-radius: 18px;
      box-shadow: 0 12px 44px #0003;
      min-width: 260px;
      min-height: 140px;
      max-width: 98vw;
      max-height: 98vh;
      z-index: 20000;
      overflow: auto;
    }
    /* Close button */
    #close-calendar-btn {
      border: none;
      background: transparent;
      font-size: 1.4rem;
      color: #888;
      cursor: pointer;
      font-weight: 700;
      float: right;
      line-height: 1;
      margin-bottom: 4px;
    }
    /* Calendar container */
    #my-calendar {
      width: 100%;
      max-width: 360px;
      min-width: 220px;
      border-radius: 18px;
      margin: auto;
    }
    /* Highlight calendar days with entries */
    .vanilla-calendar-day__btn.has-entry {
      background: #96b6ff !important;
      color: #fff !important;
      border-radius: 50% !important;
    }

    #attendance-cards {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 2.1rem;
    }
    .attendance-card {
      background: linear-gradient(135deg,#f4f5fa 85%,#e3e8ef 100%);
      border-radius: 17px;
      box-shadow: 0 3px 24px #dde2f555;
      padding: 1.25rem 2.2rem;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 2.1rem;
      align-items: center;
      font-size: 1.14rem;
      border: 2px solid #f0f3fa;
      position: relative;
      min-height: 185px;
      transition: box-shadow .18s;
    }
    .attendance-card.selected {
      border-color: #96b6ff;
      background: linear-gradient(135deg,#e7f2ff 80%,#ffffff 100%);
    }
    .attendance-card.pending-exit {
      border-color: #ffd987;
      box-shadow: 0 0 0 3px #ffecc5b9;
    }
    .attendance-card.completed {
      border-color: #9ad9aa;
      box-shadow: 0 0 0 3px #e7f5e9c5;
    }
    .attendance-card:after {
      position: absolute;
      top: 12px;
      right: 32px;
      font-size: 1.01rem;
      padding: 2px 12px;
      border-radius: 13px;
      background: #f4f7fb;
      color: #5d5e60;
      font-weight: 700;
      opacity: 0.62;
    }
    .attendance-card.pending-exit:after {
      content: "Entry Open";
      background: #ffe7b2;
      color: #8a7333;
      opacity: 0.98;
    }
    .attendance-card.completed:after {
      content: "Completed";
      background: #d8ffe1;
      color: #347055;
      opacity: 0.95;
    }
    .photo-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 175px;
    }
    .photo-row img {
      border-radius: 15px;
      width: 170px;
      height: 170px;
      object-fit: cover;
      margin-bottom: 0.66rem;
      border: 2px solid #ececec;
      box-shadow: 0 4px 15px #dadddfb3;
      background: #fbfbfb;
    }
    .job-place {
      flex-grow: 1;
      font-size: 1.22rem;
      font-weight: 800;
      color: #356;
      text-align: center;
      letter-spacing: 0.5px;
    }
    #map-wrapper {
      position: relative;
      width: 100%;
      height: 440px;
      margin-bottom: 2.2rem;
      border-radius: 17px;
      background: #f7fafe;
      box-shadow: 0 2px 18px #e5effb48;
    }
    #pac-input {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 520px;
      background: #f8f8fa;
      border-radius: 10px;
      border: 1.8px solid #c2c4cc;
      padding: 0.7rem 1.5rem;
      font-size: 1.15rem;
      z-index: 99;
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 17px;
      user-select: none;
    }
    .btn, #checkin-btn, #checkout-btn {
      border-radius: 25px;
      font-weight: 700;
      min-width: 140px;
      height: 48px;
      color: #fff;
      font-size: 1.1rem;
      margin: 0.22rem 0.35rem;
    }
    #checkin-btn {
      background: #57606f;
    }
    #checkin-btn:hover {
      background: #434952;
    }
    #checkout-btn {
      background: #8ca3df;
    }
    #checkout-btn:hover {
      background: #4a6dab;
    }
    #action-alert {
      margin-top: 1rem;
      font-weight: 600;
      min-height: 38px;
      border-radius: 13px;
      opacity: 0;
      transition: opacity 0.45s;
      color: #344354;
      background: #e3e5eb;
      border: none;
      max-width: 98vw;
    }
    #action-alert.show {
      opacity: 1;
    }
    #camera-section {
      display: none;
      text-align: center;
      margin-top: 18px;
    }
    #video, #photo-preview {
      width: 99vw;
      max-width: 435px;
      max-height: 265px;
      border-radius: 19px;
      box-shadow: 0 3px 16px #a3bce4;
      margin-top: 14px;
      object-fit: cover;
    }
    #snap-btn {
      margin-top: 18px;
      border-radius: 24px;
      font-size: 1.07rem;
      font-weight: 700;
      background: #8ca3df;
      color: white;
      border: none;
      padding: 0.55rem 2.2rem;
      cursor: pointer;
    }
    #snap-btn:hover {
      background-color: #5672a1;
    }
    @media (max-width: 700px) {
      .logo-small {
        width: 77px;
      }
      .photo-row img,
      #video,
      #photo-preview {
        width: 97vw;
        max-width: 99vw;
      }
      .attendance-card {
        flex-direction: column;
        gap: 1.1rem;
        padding: 1.2rem 1vw;
      }
    }
    @media (max-width: 430px) {
      #pac-input {
        font-size: 0.98rem;
        padding: 0.5rem 0.8rem;
        width: 98%;
      }
    }
  </style>
  
  <!-- Google Maps + Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&libraries=places"></script>
</head>
<body>
  <div class="container" role="main" aria-label="Engineer Attendance Dashboard">
    <header>
      <img src="./Bureau_Veritas.svg.png" alt="Bureau Veritas logo" class="logo-small" draggable="false" />
      <span id="user-name" aria-live="polite" aria-atomic="true">Welcome, User</span>
      <button id="logout" aria-label="Logout button">Logout</button>
    </header>

    <!-- Calendar Button & Pop-up Modal -->
    <div class="calendar-popup-toggle">
      <button id="open-calendar-btn" class="btn btn-outline-primary" type="button" aria-haspopup="dialog" aria-controls="calendar-modal-window" aria-expanded="false" style="font-weight:600; font-size:1.14rem;">
        &#128197; Show Calendar
      </button>
    </div>
    <div id="calendar-modal-overlay" tabindex="-1" aria-modal="true" role="dialog" aria-label="Attendance calendar" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(60,70,95,0.12); z-index:9999;">
      <div id="calendar-modal-window" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; padding:1.2em 1.2em 0.8em 1.2em; border-radius:18px; box-shadow:0 12px 44px #0003; min-width:260px; min-height:140px; max-width:98vw; max-height:98vh; z-index:20000;">
        <div style="text-align:right; margin-bottom:8px;">
          <button id="close-calendar-btn" aria-label="Close calendar" style="border:none; background:transparent; font-size:1.6rem; color:#888;cursor:pointer; font-weight:700; line-height:1;">&times;</button>
        </div>
        <div id="my-calendar"></div>
      </div>
    </div>

    <div id="attendance-cards" aria-live="polite" aria-atomic="true"></div>

    <hr />

    <div id="job-details" aria-label="Attendance site selection">
      <label for="pac-input" class="form-label fw-bold" style="color:#26312a; font-weight:800;">Search Site Address or Place</label>
      <div id="map-wrapper">
        <input id="pac-input" type="text" autocomplete="off" placeholder="Search site address or place" aria-label="Search map site address or place" />
        <div id="map" role="region" aria-label="Google Map showing selected site"></div>
      </div>

      <div class="d-flex gap-3 flex-wrap justify-content-center mt-3 mb-3">
        <button class="btn" id="checkin-btn" aria-label="Mark entry">Mark Entry</button>
        <button class="btn" id="checkout-btn" aria-label="Mark exit">Mark Exit</button>
      </div>

      <div id="action-alert" class="alert d-none" role="alert"></div>
    </div>

    <div id="camera-section" aria-live="polite" style="margin-top: 18px;">
      <video id="video" autoplay playsinline aria-label="Camera preview"></video>
      <button id="snap-btn" aria-label="Capture Photo">Capture Photo</button>
      <canvas id="canvas" style="display: none;"></canvas>
      <img id="photo-preview" alt="Captured photo preview" />
    </div>
  </div>

  <script>
    // Redirect to login if not authenticated
    if (!sessionStorage.getItem("googleEmail")) window.location.href = "login.html";

    const userEmail = sessionStorage.getItem("googleEmail") || '';
    document.getElementById("user-name").textContent = `Welcome, ${sessionStorage.getItem("googleName") || "User"}`;
    document.getElementById("logout").addEventListener("click", () => {
      sessionStorage.clear();
      localStorage.removeItem("attendance_jobs__" + userEmail);
      window.location.href = "login.html";
    });

    // Persistent storage of attendance jobs per user
    function getJobs() {
      try {
        let val = localStorage.getItem("attendance_jobs__" + userEmail);
        if (!val) return [];
        return JSON.parse(val);
      } catch { return []; }
    }
    function setJobs(jobs) {
      localStorage.setItem("attendance_jobs__" + userEmail, JSON.stringify(jobs));
    }

    let jobs = getJobs();
    let selectedPlace = null, map, marker;
    let entryPhoto = "", exitPhoto = "", entryTime = "", exitTime = "";
    let userLat = null, userLng = null, userLiveMarker = null, userAccuracyCircle = null, hasCenteredToUser = false;
    let selectedDateISO = null;

    // GSAP animations
    gsap.from("header", { duration: 1, y: -30, opacity: 0, ease: "power3.out" });
    gsap.from("#job-details", { duration: 1, delay: 0.4, y: 22, opacity: 0, ease: "power3.out" });

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Alerts
    function showAlert(msg, isError = false) {
      const alertBox = document.getElementById("action-alert");
      alertBox.classList.remove("d-none", "alert-info", "alert-danger");
      alertBox.classList.add(isError ? "alert-danger" : "alert-info");
      alertBox.textContent = msg;
      gsap.to(alertBox, { opacity: 1, duration: 0.45 });
      alertBox.classList.add("show");
      clearTimeout(showAlert.timeout);
      showAlert.timeout = setTimeout(() => {
        gsap.to(alertBox, { opacity: 0, duration: 0.6, onComplete: () => alertBox.classList.add("d-none") });
      }, msg ? 3800 : 1100);
    }

    // Fetch unique dates for entries
    function jobDates() {
      return [...new Set(jobs.map(j => new Date(j.entryTime).toISOString().slice(0,10)))];
    }

    // Render entries filtered by selected date
    function renderAttendanceCards() {
      let filteredJobs = jobs;
      if (selectedDateISO) {
        filteredJobs = jobs.filter(j => new Date(j.entryTime).toISOString().slice(0,10) === selectedDateISO);
      }
      const container = document.getElementById("attendance-cards");
      if (filteredJobs.length === 0) {
        container.innerHTML = `<p style="color:#445577; text-align:center; font-weight:600; margin-top:1rem;">No job records found.</p>`;
        return;
      }
      container.innerHTML = filteredJobs.map((job) => {
        const statusClass = job.exitPhoto ? "completed" : "pending-exit";
        return `
          <div class="attendance-card ${statusClass}" data-status="">
            <div class="photo-row">
              <img src="${job.entryPhoto}" alt="Entry photo for ${escapeHtml(job.place)}" />
              <div>Entry<br>${job.entryTime || "--"}</div>
            </div>
            ${job.exitPhoto
            ? `<div class="photo-row">
                 <img src="${job.exitPhoto}" alt="Exit photo for ${escapeHtml(job.place)}" />
                 <div>Exit<br>${job.exitTime || "--"}</div>
               </div>` : ""}
            <div class="job-place">${escapeHtml(job.place)}</div>
          </div>
        `;
      }).join("");
      gsap.from(".attendance-card", { opacity: 0, y: 36, duration: 0.7, stagger: 0.09, ease: "power3.out" });
    }

    // Calendar popup open/close
    document.getElementById("open-calendar-btn").onclick = function() {
      document.getElementById("calendar-modal-overlay").style.display = "block";
      gsap.fromTo("#calendar-modal-window", {scale: 0.85, opacity: 0}, {scale: 1, opacity: 1, duration: 0.28, ease: "power2.out"});
      this.setAttribute("aria-expanded", "true");
    };
    document.getElementById("close-calendar-btn").onclick = function() {
      closeCalModal();
    };
    document.getElementById("calendar-modal-overlay").onclick = function(e) {
      if (e.target === this) closeCalModal();
    };
    window.addEventListener("keydown", function(e) {
      if (e.key === "Escape") closeCalModal();
    });
    function closeCalModal() {
      const btn = document.getElementById("open-calendar-btn");
      gsap.to("#calendar-modal-window", {scale: 0.88, opacity: 0, duration: 0.15, onComplete: () => {
        document.getElementById("calendar-modal-overlay").style.display = "none";
        btn.setAttribute("aria-expanded", "false");
        btn.focus();
      }});
    }

    // Initialize and configure calendar
    function updateCalendarHighlights() {
      if (!window.myCalendar) return;
      window.myCalendar.setOptions({
        datesFilter: jobDates().map(date => ({ date, selectable: true, class: 'has-entry' })),
      });
    }
    function initCalendar() {
      window.myCalendar = new VanillaCalendar('#my-calendar', {
        settings: { lang: 'en', iso8601: true },
        selected: { dates: [] },
        datesFilter: jobDates().map(date => ({ date, selectable: true, class: 'has-entry' })),
        onSelect: (dates) => {
          selectedDateISO = dates[0];
          renderAttendanceCards();
          closeCalModal();
        },
        onReset: () => {
          selectedDateISO = null;
          renderAttendanceCards();
          closeCalModal();
        },
      });
      window.myCalendar.init();

      // Add highlight style
      const styleNode = document.createElement("style");
      styleNode.textContent = `.vanilla-calendar-day__btn.has-entry { background: #96b6ff !important; color: #fff !important; border-radius: 50% !important;}`;
      document.body.appendChild(styleNode);
    }

    // Live location marker and circle on map
    function showLiveUserOnMap(lat, lng, accuracy) {
      userLat = lat; userLng = lng;
      if (!map) return;
      if (!userLiveMarker) {
        userLiveMarker = new google.maps.Marker({
          map: map,
          position: { lat, lng },
          title: "Your Location",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#2196F3",
            fillOpacity: 0.97,
            strokeWeight: 2.7,
            strokeColor: "#fff"
          }
        });
      } else userLiveMarker.setPosition({ lat, lng });
      if (!userAccuracyCircle) {
        userAccuracyCircle = new google.maps.Circle({
          map: map,
          strokeColor: "#2196F3",
          strokeOpacity: 0.11,
          strokeWeight: 2,
          fillColor: "#2196F3",
          fillOpacity: 0.12,
          center: { lat, lng },
          radius: accuracy || 30
        });
      } else {
        userAccuracyCircle.setCenter({ lat, lng });
        userAccuracyCircle.setRadius(accuracy || 30);
      }
      if (!hasCenteredToUser) {
        map.setCenter({ lat, lng });
        map.setZoom(Math.max(map.getZoom(), 16));
        hasCenteredToUser = true;
      }
    }

    // Initialize map and Places SearchBox
    function initMap() {
      const defaultCenter = { lat: 28.61, lng: 77.23 };
      const mapElement = document.getElementById("map");
      if (!mapElement) return;
      map = new google.maps.Map(mapElement, {
        center: defaultCenter,
        zoom: 12,
        streetViewControl: false,
        fullscreenControl: true,
      });
      const input = document.getElementById("pac-input");
      const searchBox = new google.maps.places.SearchBox(input);
      map.addListener("bounds_changed", () => searchBox.setBounds(map.getBounds()));
      searchBox.addListener("places_changed", () => {
        const places = searchBox.getPlaces();
        if (!places || places.length === 0) {
          selectedPlace = null;
          if (marker) marker.setMap(null);
          marker = null;
          return;
        }
        selectedPlace = places[0];
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({
          map: map,
          position: selectedPlace.geometry.location,
          title: selectedPlace.name,
          animation: google.maps.Animation.BOUNCE
        });
        map.panTo(selectedPlace.geometry.location);
        map.setZoom(Math.max(16, map.getZoom()));
        setTimeout(() => marker.setAnimation(null), 1200);
        showAlert("", false);
      });
      if (navigator.geolocation)
        navigator.geolocation.watchPosition(
          pos => showLiveUserOnMap(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
          err => showAlert("Enable location access for live map features.", true),
          { enableHighAccuracy: true }
        );
      setTimeout(() => { input.blur(); input.focus(); }, 500);
    }

    // Calculate distance between lat/lng points in meters
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = deg => (deg * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
        + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Photo capture & camera logic
    function openCamera(type) {
      $("#job-details").hide();
      $("#camera-section").show();
      $("#photo-preview").attr("src", "");
      const video = document.getElementById("video");
      if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
      video.srcObject = null;
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          gsap.fromTo("#video", { scale: 1.03, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.8, ease: "expo.out" });
          $("#snap-btn").off("click").on("click", () => {
            const canvas = document.getElementById("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
            const imgData = canvas.toDataURL("image/png");
            $("#photo-preview").attr("src", imgData);
            stream.getTracks().forEach(t => t.stop());
            gsap.fromTo("#photo-preview", { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 1, ease: "elastic.out(1,0.77)" });
            if (type === "entry") entryPhoto = imgData; else exitPhoto = imgData;
            setTimeout(() => finishAttendance(type), 700);
          });
        }).catch(() => {
          showAlert("Camera access denied! Cannot capture photo.", true);
          $("#camera-section").hide();
          $("#job-details").show();
        });
    }

    // Finish attendance (instant entry card update & completion on exit)
    function finishAttendance(type) {
      $("#camera-section").hide();
      $("#job-details").show();
      if (type === "entry") {
        entryTime = new Date().toLocaleString();
        jobs.unshift({
          place: selectedPlace?.name || "Unknown Place",
          entryTime,
          entryPhoto,
          exitTime: "",
          exitPhoto: "",
          status: "pending-exit"
        });
        setJobs(jobs);
        renderAttendanceCards();
        showAlert("Entry marked and photo captured.");
        updateCalendarHighlights();
        gsap.fromTo(".attendance-card", { scale: 0.97 }, { scale: 1, duration: 0.7, ease: "elastic.out(1,0.75)" });
        entryPhoto = "";
        entryTime = "";
        selectedPlace = null; $("#pac-input").val("");
        if (marker) marker.setMap(null);
        marker = null;
      } else if (type === "exit") {
        exitTime = new Date().toLocaleString();
        for (let job of jobs) {
          if (job.status === "pending-exit") {
            job.exitTime = exitTime;
            job.exitPhoto = exitPhoto;
            job.status = "completed";
            break;
          }
        }
        setJobs(jobs);
        renderAttendanceCards();
        showAlert("Exit marked and photo captured.");
        updateCalendarHighlights();
        gsap.fromTo(".attendance-card.completed", { scale: 1.01 }, { scale: 1, duration: 0.6, ease: "power3.out" });
        exitPhoto = "";
        exitTime = "";
        selectedPlace = null;
        $("#pac-input").val("");
        if (marker) marker.setMap(null);
        marker = null;
      }
    }

    // Button click handlers and geofencing at 400m
    $("#checkin-btn").click(() => {
      if (!selectedPlace) {
        showAlert("Please select a place from the map.", true);
        return;
      }
      if (userLat == null || userLng == null) {
        showAlert("Obtaining your location... Please wait.", true);
        return;
      }
      const plat = selectedPlace.geometry.location.lat();
      const plng = selectedPlace.geometry.location.lng();
      const dist = getDistanceFromLatLonInMeters(userLat, userLng, plat, plng);
      if (dist <= 400) {
        openCamera("entry");
      } else {
        showAlert(`You are NOT within 400 meters of "${selectedPlace.name}". Detected: ${Math.round(dist)}m away. Move closer to check in.`, true);
      }
    });

    $("#checkout-btn").click(() => {
      if (!selectedPlace) {
        showAlert("Please select a place from the map.", true);
        return;
      }
      if (!jobs.find(j => j.status === "pending-exit")) {
        showAlert("You must mark entry (check-in) before marking exit!", true);
        return;
      }
      if (userLat == null || userLng == null) {
        showAlert("Obtaining your location... Please wait.", true);
        return;
      }
      const plat = selectedPlace.geometry.location.lat();
      const plng = selectedPlace.geometry.location.lng();
      const dist = getDistanceFromLatLonInMeters(userLat, userLng, plat, plng);
      if (dist <= 400) {
        openCamera("exit");
      } else {
        showAlert(`Not within 400 meters of "${selectedPlace.name}". You are ${Math.round(dist)}m away. Move closer to check out.`, true);
      }
    });

    // Initialize calendar on load
    function updateCalendarHighlights() {
      if (!window.myCalendar) return;
      window.myCalendar.setOptions({
        datesFilter: jobDates().map(date => ({ date, selectable: true, class: 'has-entry' })),
      });
    }

    function initCalendar() {
      window.myCalendar = new VanillaCalendar('#my-calendar', {
        settings: { lang: 'en', iso8601: true },
        selected: { dates: [] },
        datesFilter: jobDates().map(date => ({ date, selectable: true, class: 'has-entry' })),
        onSelect: (dates) => {
          selectedDateISO = dates[0];
          renderAttendanceCards();
          closeCalModal();
        },
        onReset: () => {
          selectedDateISO = null;
          renderAttendanceCards();
          closeCalModal();
        },
      });
      window.myCalendar.init();

      // Add highlight style
      const styleNode = document.createElement("style");
      styleNode.textContent = `.vanilla-calendar-day__btn.has-entry { background: #96b6ff !important; color: #fff !important; border-radius: 50% !important;}`;
      document.body.appendChild(styleNode);
    }

    // Calendar modal toggle handlers
    document.getElementById("open-calendar-btn").onclick = function () {
      document.getElementById("calendar-modal-overlay").style.display = "block";
      gsap.fromTo("#calendar-modal-window", { scale: 0.85, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.28, ease: "power2.out" });
      this.setAttribute("aria-expanded", "true");
    };

    document.getElementById("close-calendar-btn").onclick = closeCalModal;
    document.getElementById("calendar-modal-overlay").onclick = function (e) {
      if (e.target === this) closeCalModal();
    };

    window.addEventListener("keydown", function (e) {
      if (e.key === "Escape") closeCalModal();
    });

    function closeCalModal() {
      const btn = document.getElementById("open-calendar-btn");
      gsap.to("#calendar-modal-window", {
        scale: 0.88,
        opacity: 0,
        duration: 0.15,
        onComplete: () => {
          document.getElementById("calendar-modal-overlay").style.display = "none";
          btn.setAttribute("aria-expanded", "false");
          btn.focus();
        },
      });
    }

    window.onload = () => {
      initMap();
      renderAttendanceCards();
      initCalendar();
      updateCalendarHighlights();
    };
  </script>
</body>
</html>
