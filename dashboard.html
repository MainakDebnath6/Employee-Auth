    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Bureau Veritas Employee Dashboard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
        <link rel="icon" href="./Bureau_Veritas.svg.png" type="image/png" />
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" as="script">
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" as="script">
        <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" as="script">
        <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
        <link rel="preconnect" href="https://maps.googleapis.com" crossorigin>
        <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
        <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
        <style>
    :root{--glow-color-1:#4c68ff;--glow-color-2:#43bfff;--background-color:#0c0e14;--card-background:rgba(18, 22, 30, 0.75);--card-border:rgba(255, 255, 255, 0.15);--text-primary:#e6eaf0;--text-secondary:#a8b2c2;--text-accent:var(--glow-color-2);--success:#27ae60;--warning:#f39c12;--error:#e74c3c;--primary-gradient:linear-gradient(90deg, var(--glow-color-1), var(--glow-color-2));--shadow:0 4px 15px rgba(0, 0, 0, 0.2);--border-radius:16px;--empty-state-color:rgba(255, 255, 255, 0.05);--empty-state-icon:rgba(255, 255, 255, 0.2);--fc-border-color:transparent;--fc-daygrid-event-dot-width:8px;--fc-today-bg-color:rgba(67, 191, 255, 0.1);}
    *{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    html{scroll-behavior:smooth;}
    body{font-family:'Poppins', sans-serif;background:var(--background-color);color:var(--text-primary);min-height:100vh;overflow-x:hidden;font-size:0.95rem;position:relative;z-index:1;}
    body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle at 20% 20%, var(--glow-color-1), transparent 30%), radial-gradient(circle at 80% 70%, var(--glow-color-2), transparent 30%);opacity:0.15;z-index:-1;animation:backgroundGlow 20s infinite alternate;}
    @keyframes backgroundGlow{0%{transform:scale(1) rotate(0deg);}100%{transform:scale(1.2) rotate(5deg);}}
    ::-webkit-scrollbar{width:8px;height:8px;}
    ::-webkit-scrollbar-track{background:rgba(255, 255, 255, 0.05);border-radius:10px;}
    ::-webkit-scrollbar-thumb{background:rgba(255, 255, 255, 0.2);border-radius:10px;border:2px solid rgba(255, 255, 255, 0);}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255, 255, 255, 0.3);}
    #app-loader{position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:var(--background-color);z-index:99999;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:opacity 0.3s ease;text-align:center;}
    #loader-text{color:var(--text-secondary);margin-top:1rem;font-size:1rem;}
    .spinner{width:56px;height:56px;border-radius:50%;background:radial-gradient(farthest-side, var(--glow-color-1) 94%, #0000) top/9px 9px no-repeat, conic-gradient(#0000 30%, var(--glow-color-1));-webkit-mask:radial-gradient(farthest-side, #0000 calc(100% - 9px), #000 0);animation:spinner-c7wet2 1s infinite linear;}
    @keyframes spinner-c7wet2{to{transform:rotate(1turn);}}
    .navbar{background:rgba(15, 17, 26, 0.7);backdrop-filter:blur(20px) saturate(150%);border-bottom:1px solid var(--card-border);position:sticky;top:0;z-index:1000;padding:0.75rem 0;}
    .nav-link{color:var(--text-secondary) !important;font-weight:600;border-radius:8px;padding:0.5rem 1rem;margin:0 0.25rem;transition:all 0.2s ease;position:relative;overflow:hidden;}
    .nav-link::before{content:'';position:absolute;top:0;left:0;width:0;height:100%;background:rgba(255, 255, 255, 0.1);transition:width 0.3s ease;z-index:-1;}
    .nav-link.active, .nav-link:hover{color:var(--text-primary) !important;}
    .nav-link.active::before, .nav-link:hover::before{width:100%;}
    .navbar-toggler{border-color:rgba(255, 255, 255, 0.2);}
    .navbar-toggler-icon{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28240, 242, 245, 0.8%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");}
    .nav-tabs .nav-link{color:var(--text-secondary);border:1px solid transparent;background:rgba(255, 255, 255, 0.05);margin-bottom:-1px;border-radius:10px 10px 0 0;transition:all 0.2s ease;}
    .nav-tabs .nav-link:hover{border-color:var(--card-border);color:var(--text-primary);}
    .nav-tabs .nav-link.active{color:var(--text-primary);background:var(--card-background);border-color:var(--card-border);border-bottom-color:transparent;font-weight:600;border-top:2px solid var(--glow-color-2);}
    .notification-bell{position:relative;cursor:pointer;margin-left:1rem;}
    .notification-badge{position:absolute;top:-8px;right:-8px;background:var(--error);color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:bold;animation:pulse 2s infinite;}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(231, 76, 60, 0.7);}70%{box-shadow:0 0 0 10px rgba(231, 76, 60, 0);}100%{box-shadow:0 0 0 0 rgba(231, 76, 60, 0);}}
    .notification-dropdown {
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 0.5rem;
    width: 300px;
    background: rgb(22, 25, 37); /* <--- THIS IS THE FIX */
    border: 1px solid var(--card-border);
    border-radius: var(--border-radius);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    z-index: 1000;
    display: none;
    overflow: hidden;
    }
    .notification-dropdown.show{display:block;}
    .notification-header{padding:0.75rem 1rem;border-bottom:1px solid var(--card-border);font-weight:600;display:flex;justify-content:space-between;align-items:center;}
    .notification-item{padding:0.75rem 1rem;border-bottom:1px solid var(--card-border);transition:background 0.2s ease;}
    .notification-item:hover{background:rgba(255, 255, 255, 0.05);}
    .notification-item:last-child{border-bottom:none;}
    .notification-title{font-weight:600;margin-bottom:0.25rem;}
    .notification-text{font-size:0.85rem;color:var(--text-secondary);}
    .notification-time{font-size:0.75rem;color:var(--text-secondary);margin-top:0.25rem;}
    #container-main{max-width:1400px;margin:2rem auto;padding:0 1rem;}
    .section{display:none;}
    .section.active{display:block;}
    .section-card{background:var(--card-background);border:1px solid var(--card-border);backdrop-filter:blur(20px) saturate(150%);border-radius:var(--border-radius);padding:2rem;box-shadow:0 8px 30px rgba(0, 0, 0, 0.4);height:100%;display:flex;flex-direction:column;margin-bottom:2rem;transition:transform 0.3s ease, box-shadow 0.3s ease;position:relative;overflow:hidden;}
    .section-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--primary-gradient);opacity:0;transition:opacity 0.3s ease;}
    .section-card:hover::before{opacity:1;}
    .section-card:hover{transform:translateY(-5px);box-shadow:0 12px 40px rgba(0, 0, 0, 0.6);}
    .section-title{font-size:1.5rem;font-weight:800;margin-bottom:1.5rem;display:flex;align-items:center;gap:1rem;border-bottom:1px solid var(--card-border);padding-bottom:1rem;flex-shrink:0;background:linear-gradient(90deg, var(--glow-color-1), var(--glow-color-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .section-title i{font-size:1.5em;background:var(--primary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    #map-wrapper, #stats-map-wrapper, #admin-live-map-wrapper, #admin-route-map-wrapper{position:relative;height:500px;border-radius:16px;background:#0e1118;overflow:hidden;border:1px solid var(--card-border);box-shadow:inset 0 0 20px rgba(0, 0, 0, 0.5);transition:all 0.3s ease;}
    #map-wrapper:hover, #stats-map-wrapper:hover, #admin-live-map-wrapper:hover, #admin-route-map-wrapper:hover{border-color:var(--glow-color-2);box-shadow:inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(67, 191, 255, 0.2);}
    #map, #stats-map, #admin-live-map, #admin-route-map{height:100%;width:100%;}
    .map-marker{display:grid;place-items:center;position:relative;}
    .map-marker .pulse{border-radius:50%;border:4px solid var(--glow-color-1);box-shadow:0 0 15px var(--glow-color-1);position:absolute;animation:pulse-animation 1.5s infinite;}
    @keyframes pulse-animation{0%{transform:scale(0.8);opacity:1;}100%{transform:scale(2);opacity:0;}}
    .form-control, .pac-target-input, .form-select, .form-control:disabled{background:rgba(255, 255, 255, 0.05) !important;color:var(--text-primary) !important;border-radius:10px !important;border:1px solid rgba(255, 255, 255, 0.1) !important;transition:all 0.2s ease !important;}
    .form-control::placeholder{color:var(--text-secondary) !important;opacity:0.6 !important;}
    .form-control:focus, .pac-target-input:focus, .form-select:focus{background:rgba(255, 255, 255, 0.1) !important;border-color:var(--glow-color-2) !important;box-shadow:0 0 15px rgba(67, 191, 255, 0.3), 0 0 5px rgba(67, 191, 255, 0.2) inset !important;}
    .form-control:disabled{opacity:0.8;cursor:not-allowed;border-color:rgba(255, 255, 255, 0.05) !important;}
    .input-group-text{background:rgba(255, 255, 255, 0.05);border:1px solid rgba(255, 255, 255, 0.1);}
    #gps-status{font-size:0.9rem;font-weight:600;color:var(--text-secondary);padding:0.5rem 0;}
    .btn{border-radius:10px;font-weight:600;padding:0.75rem 1.5rem;transition:all 0.2s ease-in-out;border:none;box-shadow:var(--shadow);color:#fff !important;position:relative;overflow:hidden;cursor:pointer;}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:rgba(255, 255, 255, 0.2);transition:left 0.3s ease;z-index:0;}
    .btn:hover::before{left:100%;}
    .btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);}
    .btn-success{background:var(--success);}
    .btn-warning{background:var(--warning);}
    .btn-primary{background:var(--glow-color-1);}
    .btn-info{background:var(--glow-color-2);}
    .btn-danger{background:var(--error);}
    .btn-outline-primary{border:1px solid var(--glow-color-1);color:var(--glow-color-1) !important;background:transparent;}
    .btn-outline-primary:hover{background:var(--glow-color-1);color:#fff !important;}
    .attendance-card, .travel-card, .issue-card{background:rgba(255, 255, 255, 0.05);border-radius:12px;margin-bottom:0.75rem;padding:1rem 1.25rem;transition:all 0.2s ease;border:1px solid transparent;position:relative;overflow:hidden;}
    .attendance-card::before, .travel-card::before, .issue-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--glow-color-2);transform:scaleY(0);transition:transform 0.2s ease;}
    .attendance-card:hover, .travel-card:hover, .issue-card:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.1);box-shadow:0 4px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .attendance-card:hover::before, .travel-card:hover::before, .issue-card:hover::before{transform:scaleY(1);}
    .status-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;box-shadow:0 0 8px rgba(0, 0, 0, 0.5);}
    .completed{background-color:var(--success);}
    .pending{background-color:var(--warning);}
    .card-place{font-weight:600;font-size:1.1rem;}
    .card-date{color:var(--text-secondary);}
    #attendance-cards-container, #admin-users-list, #stats-travel-details, .issue-list-container{max-height:450px;overflow-y:auto;padding-right:10px;}
    .admin-user-row{background:rgba(255, 255, 255, 0.05);border-radius:10px;margin-bottom:0.5rem;padding:0.8rem 1.2rem;font-weight:600;transition:all 0.2s ease;cursor:pointer;display:flex;align-items:center;position:relative;overflow:hidden;}
    .admin-user-row::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--glow-color-2);transform:scaleY(0);transition:transform 0.2s ease;}
    .admin-user-row .admin-user-checkbox{margin-right:1rem;flex-shrink:0;}
    .admin-user-row:hover{background:rgba(255, 255, 255, 0.1);transform:translateX(5px);}
    .admin-user-row:hover::before{transform:scaleY(1);}
    .admin-user-row.active{background:var(--primary-gradient);color:#fff;box-shadow:0 0 20px rgba(51, 75, 249, 0.4);transform:translateX(0);}
    .admin-user-row .email, .admin-user-row.active .email{font-size:0.8rem;font-weight:400;color:var(--text-secondary);}
    .admin-user-row.active .email{color:rgba(255, 255, 255, 0.8);}
    .admin-record-details img, .record-details img{max-width:100%;height:auto;max-height:250px;object-fit:contain;border-radius:8px;border:1px solid var(--card-border);transition:transform 0.2s ease;cursor:pointer;}
    @media (min-width: 768px){.record-details img, .admin-record-details img{max-width:250px;}}
    .admin-record-details a:hover img, .record-details a:hover img{transform:scale(1.05);}
    .stat-box{background:rgba(255, 255, 255, 0.15);border-radius:12px;padding:1.25rem;border:1px solid var(--card-border);transition:all 0.2s ease;color:#fff;box-shadow:0 4px 15px rgba(0, 0, 0, 0.2);position:relative;overflow:hidden;}
    .stat-box::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--primary-gradient);opacity:0;transition:opacity 0.3s ease;}
    .stat-box:hover::before{opacity:1;}
    .stat-box:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.2);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .stat-box h4{font-weight:800;font-size:2.5rem;color:var(--text-accent);}
    .stat-box p{font-weight:600;color:var(--text-secondary);margin:0;}
    #image-viewer{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0, 0, 0, 0.85);backdrop-filter:blur(10px);z-index:10000;display:none;align-items:center;justify-content:center;cursor:pointer;}
    #image-viewer img{max-width:90%;max-height:90%;border-radius:10px;box-shadow:0 10px 40px rgba(0, 0, 0, 0.5);transition:transform 0.3s ease;}
    #image-viewer img:hover{transform:scale(1.02);}
    .modal-content{background:var(--card-background);border:1px solid var(--card-border);color:var(--text-primary);}
    .modal-header, .modal-footer{border-color:var(--card-border);}
    .modal-header .btn-close{filter:invert(1) grayscale(100%) brightness(200%);}
    .fc{font-family:'Poppins', sans-serif;color:var(--text-primary);background:transparent;}
    .fc .fc-toolbar.fc-header-toolbar{margin-bottom:1.5rem !important;padding-bottom:1rem;border-bottom:1px solid var(--card-border);}
    .fc .fc-toolbar-title{font-size:1.25rem;font-weight:700;}
    .fc .fc-button{background:transparent !important;border:none !important;color:var(--text-secondary) !important;box-shadow:none !important;transition:all 0.2s ease-in-out;}
    .fc .fc-button:hover{color:var(--glow-color-2) !important;}
    .fc .fc-button-primary:not(:disabled).fc-button-active, .fc .fc-button-primary:not(:disabled):active{color:var(--glow-color-1) !important;}
    .fc .fc-today-button{font-size:0.8rem !important;font-weight:600;border-radius:8px;background:rgba(255, 255, 255, 0.05) !important;border:1px solid var(--card-border) !important;padding:0.4rem 0.8rem;}
    .fc .fc-today-button:hover{background:rgba(255, 255, 255, 0.1) !important;}
    .fc th{border-color:transparent !important;padding-bottom:0.8rem;text-align:center;}
    .fc .fc-col-header-cell-cushion{display:inline-block;padding:0.4rem 0.6rem;background:rgba(255, 255, 255, 0.08);border:1px solid var(--card-border);border-radius:8px;color:var(--text-accent);font-size:0.75rem;font-weight:600;text-decoration:none;text-transform:uppercase;}
    .fc-theme-standard .fc-scrollgrid, .fc-theme-standard th, .fc-theme-standard td{border:none !important;}
    .fc-daygrid-day-frame{border:none;border-radius:8px;position:relative;background-color:rgba(255, 255, 255, 0.02);transition:background-color 0.2s ease, box-shadow 0.2s ease;margin:2px;height:100%;}
    .fc-daygrid-day-frame:hover{background-color:rgba(255, 255, 255, 0.08);box-shadow:0 0 10px rgba(67, 191, 255, 0.2);}
    .fc .fc-daygrid-day{border:none;position:relative;}
    .fc .fc-daygrid-day::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;box-shadow:inset 0 0 0 1px rgba(255, 255, 255, 0.05);border-radius:8px;}
    .fc-day-today .fc-daygrid-day-frame{background-color:rgba(67, 191, 255, 0.1);}
    .fc-day-today .fc-daygrid-day-number{font-weight:700;color:var(--glow-color-2);}
    .fc .fc-daygrid-day-number{font-size:0.75rem;font-weight:600;color:var(--text-secondary);padding:8px;}
    .fc .fc-day-other .fc-daygrid-day-top{opacity:0.3;}
    .fc .fc-daygrid-event{border-radius:6px !important;padding:2px 6px !important;font-weight:600;font-size:0.7rem;margin:1px 4px !important;border:none !important;color:#fff !important;transition:all 0.2s ease;}
    .fc .fc-daygrid-event:hover{transform:scale(1.05);box-shadow:0 2px 10px rgba(0, 0, 0, 0.3);}
    .calendar-legend{display:flex;justify-content:center;gap:1.5rem;padding:0.75rem;background:rgba(255, 255, 255, 0.05);border-radius:10px;margin-top:1rem;}
    .legend-item{display:flex;align-items:center;gap:0.5rem;font-size:0.8rem;font-weight:500;color:var(--text-secondary);}
    .legend-dot{width:10px;height:10px;border-radius:50%;}
    .event-site-visit, .legend-dot.site-visit{background:linear-gradient(45deg, var(--success), #2ecc71) !important;}
    .event-office, .legend-dot.office{background:linear-gradient(45deg, #3498db, var(--glow-color-2)) !important;}
    .event-leave, .legend-dot.leave{background:linear-gradient(45deg, var(--error), #c0392b) !important;}
    .issue-card:hover{transform:translateY(-3px);background:rgba(255, 255, 255, 0.1);box-shadow:0 4px 15px rgba(0, 0, 0, 0.2);border-color:var(--glow-color-2);}
    .issue-card-header{display:flex;justify-content:space-between;align-items:flex-start;}
    .pac-container{background-color:rgba(22, 25, 37, 0.95) !important;border:1px solid var(--card-border) !important;border-radius:8px !important;backdrop-filter:blur(5px);}
    .pac-item{color:var(--text-primary) !important;border-bottom:1px solid var(--card-border) !important;padding:10px !important;transition:all 0.2s ease;}
    .pac-item:hover{background-color:rgba(255, 255, 255, 0.1) !important;}
    .pac-item-query{color:var(--text-accent) !important;font-weight:600;}
    .admin-user-row .form-check-input{display:none;}
    .select-mode-active .admin-user-row .form-check-input{display:block;}
    #camera-modal{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0, 0, 0, 0.85);backdrop-filter:blur(5px);align-items:center;justify-content:center;z-index:9999;}
    .camera-modal-content{background:var(--card-background);padding:1rem;border-radius:16px;border:1px solid var(--card-border);display:flex;flex-direction:column;align-items:center;}
    #video-container{width:100%;max-width:640px;max-height:480px;overflow:hidden;border-radius:12px;margin-bottom:1rem;background:#000;}
    #video{width:100%;height:100%;object-fit:cover;}
    #credits-section{border-top:1px solid var(--card-border);padding-top:2rem;margin-top:2rem;text-align:center;color:var(--text-secondary);}
    @media (max-width: 768px){.fc .fc-toolbar.fc-header-toolbar{flex-direction:column;align-items:flex-start;gap:1rem;}
    .fc .fc-toolbar-title{font-size:1.1rem;}
    .fc .fc-daygrid-day-frame{border:none;}
    .fc .fc-col-header-cell-cushion{font-size:0.65rem;padding:0.25rem 0.4rem;}
    .fc .fc-daygrid-day-number{font-size:0.65rem;}
    .fc .fc-daygrid-day-events{margin-top:0.25rem;}
    .fc .fc-daygrid-event{font-size:0.6rem;}
    #map-wrapper, #stats-map-wrapper, #admin-live-map-wrapper, #admin-route-map-wrapper{height:300px;}
    .record-details .record-photo-container{margin-bottom:0.5rem;}
    .record-details .record-info-container{font-size:0.85rem;}
    .btn{padding:0.5rem 1rem;}
    .btn-lg-responsive{font-size:0.85rem;padding:0.7rem 1.2rem;}
    .section-card{padding:1.5rem;}
    .stat-box{padding:1rem;}
    .stat-box h4{font-size:2rem;}}
    .record-details{display:none;margin-top:1rem;border-top:1px solid var(--card-border);padding-top:1rem;animation:fadeIn 0.3s ease-in-out;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    .record-details .row{align-items:flex-start;justify-content:space-between;}
    .record-details .record-photo-container{display:flex;flex-direction:column;align-items:center;text-align:center;margin-bottom:1rem;}
    .record-details .record-photo-container img{max-width:100%;height:auto;max-height:250px;object-fit:cover;border-radius:8px;border:1px solid var(--card-border);transition:transform 0.2s ease, box-shadow 0.2s ease;cursor:pointer;}
    .record-details .record-photo-container img:hover{transform:scale(1.05);box-shadow:0 0 10px rgba(67, 191, 255, 0.4);}
    .record-details .record-info-container{font-size:0.95rem;}
    .record-details .record-info-container p{margin-bottom:0.25rem;padding:0.25rem 0;}
    .record-details .record-info-container strong{color:var(--text-primary);font-weight:600;}
    .record-details .record-info-container .info-label{color:var(--text-secondary);font-weight:400;}
    .admin-modal-user-info p{margin-bottom:0.25rem;font-size:0.95rem;padding:0.5rem;background:rgba(255, 255, 255, 0.05);border-radius:8px;}
    .admin-modal-user-info p strong{color:var(--text-primary);font-weight:600;}
    .admin-modal-user-info p i{color:var(--text-accent);}
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;height:100%;min-height:300px;padding:2rem;border:1px dashed var(--card-border);border-radius:12px;background:var(--empty-state-color);transition:all 0.3s ease;}
    .empty-state:hover{background:rgba(255, 255, 255, 0.08);border-color:var(--glow-color-2);transform:translateY(-5px);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);}
    .empty-state-icon{font-size:4rem;color:var(--empty-state-icon);margin-bottom:1rem;transition:color 0.3s ease;}
    .empty-state:hover .empty-state-icon{color:var(--glow-color-2);}
    .empty-state h5{font-size:1.25rem;font-weight:600;color:var(--text-primary);}
    .empty-state p{font-size:0.9rem;color:var(--text-secondary);margin:0.5rem 0 0;}
    .animated-card{animation:fadeInScale 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;}
    @keyframes fadeInScale{0%{transform:scale(0.95);opacity:0;}100%{transform:scale(1);opacity:1;}}
    .map-controls{position:absolute;top:10px;right:10px;z-index:100;display:flex;flex-direction:column;gap:5px;}
    .map-control-btn{width:36px;height:36px;border-radius:50%;background:var(--card-background);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;}
    .map-control-btn:hover{background:var(--glow-color-2);transform:scale(1.1);}
    .map-control-btn i{color:var(--text-primary);font-size:1rem;}
    .chart-container{position:relative;height:300px;width:100%;}
    .chart-controls{display:flex;justify-content:center;gap:10px;margin-top:15px;}
    .chart-control-btn{padding:5px 15px;border-radius:20px;background:rgba(255, 255, 255, 0.1);border:1px solid var(--card-border);color:var(--text-primary);font-size:0.85rem;cursor:pointer;transition:all 0.2s ease;}
    .chart-control-btn:hover{background:var(--glow-color-2);border-color:var(--glow-color-2);}
    .chart-control-btn.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .fab{position:fixed;bottom:80px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--primary-gradient);border:none;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 10px rgba(0, 0, 0, 0.3);z-index:1000;transition:all 0.3s ease;}
    .fab:hover{transform:scale(1.1);box-shadow:0 6px 15px rgba(0, 0, 0, 0.4);}
    .fab i{font-size:1.5rem;}
    .skeleton{background:linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;}
    @keyframes skeleton-loading{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    .skeleton-text{height:16px;border-radius:4px;margin-bottom:8px;}
    .skeleton-title{height:24px;border-radius:4px;width:60%;margin-bottom:16px;}
    .skeleton-card{height:120px;border-radius:8px;margin-bottom:16px;}
    .custom-tooltip{position:absolute;background:var(--card-background);color:var(--text-primary);padding:8px 12px;border-radius:6px;font-size:0.85rem;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);z-index:1000;pointer-events:none;opacity:0;transition:opacity 0.2s ease;}
    .custom-tooltip.show{opacity:1;}
    .custom-tooltip::before{content:'';position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:var(--card-background) transparent transparent transparent;}
    .search-container{position:relative;margin-bottom:1rem;}
    .search-input{width:100%;padding:12px 20px 12px 45px;border-radius:30px;background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);color:var(--text-primary);transition:all 0.2s ease;}
    .search-input:focus{background:rgba(255, 255, 255, 0.1);border-color:var(--glow-color-2);box-shadow:0 0 15px rgba(67, 191, 255, 0.3);}
    .search-icon{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--text-secondary);}
    .search-clear{position:absolute;right:15px;top:50%;transform:translateY(-50%);color:var(--text-secondary);cursor:pointer;display:none;}
    .search-input:not(:placeholder-shown) ~ .search-clear{display:block;}
    .custom-info-window{background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;padding:12px;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);min-width:200px;}
    .custom-info-window h3{margin-top:0;margin-bottom:8px;color:var(--text-primary);font-size:1rem;}
    .custom-info-window p{margin:0 0 8px;color:var(--text-secondary);font-size:0.85rem;}
    .custom-info-window .info-window-actions{display:flex;gap:8px;margin-top:12px;}
    .info-window-btn{padding:4px 10px;border-radius:4px;background:var(--glow-color-2);border:none;color:white;font-size:0.75rem;cursor:pointer;transition:all 0.2s ease;}
    .info-window-btn:hover{background:var(--glow-color-1);}
    .timeline{position:relative;padding:20px 0;}
    .timeline::before{content:'';position:absolute;top:0;left:20px;height:100%;width:2px;background:var(--card-border);}
    .timeline-item{position:relative;margin-bottom:20px;padding-left:50px;}
    .timeline-item::before{content:'';position:absolute;top:5px;left:14px;width:14px;height:14px;border-radius:50%;background:var(--glow-color-2);border:2px solid var(--card-background);}
    .timeline-content{background:rgba(255, 255, 255, 0.05);border-radius:8px;padding:12px;border:1px solid var(--card-border);}
    .timeline-title{font-weight:600;margin-bottom:5px;}
    .timeline-time{font-size:0.75rem;color:var(--text-secondary);}
    .weather-widget{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:15px;border:1px solid var(--card-border);display:flex;align-items:center;gap:15px;}
    .weather-icon{font-size:2rem;color:var(--glow-color-2);}
    .weather-info{flex-grow:1;}
    .weather-temp{font-size:1.5rem;font-weight:700;margin-bottom:5px;}
    .weather-desc{font-size:0.85rem;color:var(--text-secondary);}
    .weather-location{font-size:0.75rem;color:var(--text-secondary);}
    .progress-container{margin-bottom:1rem;}
    .progress-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.85rem;}
    .progress-bar-custom{height:8px;border-radius:4px;background:rgba(255, 255, 255, 0.1);overflow:hidden;position:relative;}
    .progress-fill{height:100%;border-radius:4px;background:var(--primary-gradient);position:relative;overflow:hidden;}
    .progress-fill::after{content:'';position:absolute;top:0;left:0;bottom:0;right:0;background:linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.3) 50%, rgba(255, 255, 255, 0) 100%);animation:progress-animation 2s infinite;}
    @keyframes progress-animation{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
    .tag{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.75rem;font-weight:600;margin-right:5px;margin-bottom:5px;}
    .tag-success{background:rgba(39, 174, 96, 0.2);color:var(--success);}
    .tag-warning{background:rgba(243, 156, 18, 0.2);color:var(--warning);}
    .tag-danger{background:rgba(231, 76, 60, 0.2);color:var(--error);}
    .tag-info{background:rgba(67, 191, 255, 0.2);color:var(--glow-color-2);}
    .avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1rem;overflow:hidden;}
    .avatar img{width:100%;height:100%;object-fit:cover;}
    .badge-custom{padding:4px 8px;border-radius:4px;font-size:0.7rem;font-weight:600;display:inline-block;}
    .badge-success{background:rgba(39, 174, 96, 0.2);color:var(--success);}
    .badge-warning{background:rgba(243, 156, 18, 0.2);color:var(--warning);}
    .badge-danger{background:rgba(231, 76, 60, 0.2);color:var(--error);}
    .badge-info{background:rgba(67, 191, 255, 0.2);color:var(--glow-color-2);}
    .dropdown-custom{position:relative;display:inline-block;}
    .dropdown-toggle-custom{background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);color:var(--text-primary);padding:8px 15px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.2s ease;}
    .dropdown-toggle-custom:hover{background:rgba(255, 255, 255, 0.1);}
    .dropdown-menu-custom{position:absolute;top:100%;left:0;background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);z-index:1000;min-width:200px;display:none;overflow:hidden;}
    .dropdown-menu-custom.show{display:block;}
    .dropdown-item-custom{padding:10px 15px;color:var(--text-primary);transition:background 0.2s ease;cursor:pointer;}
    .dropdown-item-custom:hover{background:rgba(255, 255, 255, 0.05);}
    .dropdown-divider-custom{height:1px;background:var(--card-border);margin:5px 0;}
    .tabs-custom{display:flex;border-bottom:1px solid var(--card-border);margin-bottom:1rem;}
    .tab-custom{padding:10px 20px;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s ease;position:relative;}
    .tab-custom:hover{color:var(--text-primary);}
    .tab-custom.active{color:var(--text-primary);border-bottom-color:var(--glow-color-2);}
    .tab-custom.active::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:2px;background:var(--glow-color-2);}
    .accordion-custom{border:1px solid var(--card-border);border-radius:8px;overflow:hidden;}
    .accordion-item-custom{border-bottom:1px solid var(--card-border);}
    .accordion-item-custom:last-child{border-bottom:none;}
    .accordion-header-custom{padding:15px;background:rgba(255, 255, 255, 0.05);cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s ease;}
    .accordion-header-custom:hover{background:rgba(255, 255, 255, 0.1);}
    .accordion-icon-custom{transition:transform 0.3s ease;}
    .accordion-item-custom.active .accordion-icon-custom{transform:rotate(180deg);}
    .accordion-body-custom{padding:15px;display:none;}
    .accordion-item-custom.active .accordion-body-custom{display:block;}
    .card-enhanced{background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);border-radius:12px;overflow:hidden;transition:all 0.3s ease;}
    .card-enhanced:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);}
    .card-header-enhanced{padding:15px;border-bottom:1px solid var(--card-border);background:rgba(255, 255, 255, 0.02);}
    .card-body-enhanced{padding:15px;}
    .card-footer-enhanced{padding:15px;border-top:1px solid var(--card-border);background:rgba(255, 255, 255, 0.02);}
    .list-custom{list-style:none;padding:0;margin:0;}
    .list-item-custom{padding:12px 15px;border-bottom:1px solid var(--card-border);transition:background 0.2s ease;}
    .list-item-custom:last-child{border-bottom:none;}
    .list-item-custom:hover{background:rgba(255, 255, 255, 0.05);}
    .list-item-custom.active{background:rgba(67, 191, 255, 0.1);border-left:3px solid var(--glow-color-2);padding-left:12px;}
    .top-performing-users-container{margin-top:20px;}
    .top-performing-users-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:15px;}
    .top-performing-user-card{background:var(--card-background);border-radius:12px;padding:20px 15px;box-shadow:0 4px 15px rgba(0, 0, 0, 0.2);transition:all 0.3s ease;position:relative;overflow:hidden;text-align:center;border:1px solid var(--card-border);display:flex;flex-direction:column;}
    .top-performing-user-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .top-performing-user-avatar{width:70px;height:70px;border-radius:50%;margin:0 auto 12px auto;position:relative;border:3px solid var(--card-border);box-shadow:0 4px 10px rgba(0, 0, 0, 0.4), inset 0 0 4px rgba(0, 0, 0, 0.5);flex-shrink:0;background:var(--card-background);}
    .top-performing-user-avatar img, .top-performing-user-avatar .profile-avatar-initials{width:100%;height:100%;object-fit:cover;border-radius:50%;transition:transform 0.3s ease;}
    .top-performing-user-card:hover .top-performing-user-avatar img, .top-performing-user-card:hover .top-performing-user-avatar .profile-avatar-initials{transform:scale(1.1);}
    .top-performing-user-rank{position:absolute;top:-2px;right:-2px;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.8rem;box-shadow:0 2px 5px rgba(0, 0, 0, 0.3);z-index:1;border:2px solid var(--card-background);}
    .rank-1{background:linear-gradient(135deg, #FFD700, #FFA500);}
    .rank-2{background:linear-gradient(135deg, #C0C0C0, #808080);}
    .rank-3{background:linear-gradient(135deg, #CD7F32, #8B4513);}
    .rank-other{background:var(--primary-gradient);}
    .top-performing-user-name{font-size:1rem;font-weight:600;margin-bottom:2px;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
    .top-performing-user-email{font-size:0.75rem;color:var(--text-secondary);margin-bottom:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%;}
    .top-performing-user-stats{width:100%;margin-bottom:12px;font-size:0.8rem;}
    .top-performing-user-stat-row{display:flex;justify-content:space-between;width:100%;margin-bottom:5px;}
    .top-performing-user-stat-label{color:var(--text-secondary);}
    .top-performing-user-stat-value{font-weight:600;color:var(--text-accent);}
    .top-performing-user-progress{width:100%;margin-bottom:15px;}
    .top-performing-user-actions{margin-top:auto;}
    .profile-avatar-initials{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;color:white;background:var(--primary-gradient);border-radius:50%;}
    .monthly-attendance-container{margin-top:20px;}
    .monthly-attendance-chart{height:300px;width:100%;}
    .map-heatmap-toggle{position:absolute;bottom:10px;right:10px;z-index:100;}
    .map-heatmap-btn{padding:8px 15px;border-radius:20px;background:var(--card-background);border:1px solid var(--card-border);color:var(--text-primary);font-size:0.85rem;cursor:pointer;transition:all 0.2s ease;}
    .map-heatmap-btn:hover{background:var(--glow-color-2);border-color:var(--glow-color-2);}
    .map-heatmap-btn.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .map-distance-tool{position:absolute;bottom:10px;left:10px;z-index:100;display:flex;gap:5px;}
    .map-distance-btn{padding:8px 15px;border-radius:20px;background:var(--card-background);border:1px solid var(--card-border);color:var(--text-primary);font-size:0.85rem;cursor:pointer;transition:all 0.2s ease;}
    .map-distance-btn:hover{background:var(--glow-color-2);border-color:var(--glow-color-2);}
    .map-distance-btn.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .map-distance-info{position:absolute;bottom:50px;left:10px;background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;padding:8px 12px;font-size:0.85rem;color:var(--text-primary);display:none;z-index:100;}
    .map-distance-info.show{display:block;}
    .map-weather-widget{position:absolute;top:10px;left:10px;z-index:100;background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;padding:10px;display:flex;align-items:center;gap:10px;}
    .map-weather-icon{font-size:1.5rem;color:var(--glow-color-2);}
    .map-weather-info{font-size:0.85rem;color:var(--text-primary);}
    .map-weather-temp{font-weight:600;}
    .map-weather-desc{color:var(--text-secondary);}
    .map-traffic-toggle{position:absolute;bottom:60px;right:10px;z-index:100;}
    .map-traffic-btn{padding:8px 15px;border-radius:20px;background:var(--card-background);border:1px solid var(--card-border);color:var(--text-primary);font-size:0.85rem;cursor:pointer;transition:all 0.2s ease;}
    .map-traffic-btn:hover{background:var(--glow-color-2);border-color:var(--glow-color-2);}
    .map-traffic-btn.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .fade-in-up{animation:fadeInUp 0.5s ease-out forwards;opacity:0;}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    .fade-in-down{animation:fadeInDown 0.5s ease-out forwards;opacity:0;}
    @keyframes fadeInDown{from{opacity:0;transform:translateY(-20px);}to{opacity:1;transform:translateY(0);}}
    .fade-in-left{animation:fadeInLeft 0.5s ease-out forwards;opacity:0;}
    @keyframes fadeInLeft{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
    .fade-in-right{animation:fadeInRight 0.5s ease-out forwards;opacity:0;}
    @keyframes fadeInRight{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
    .scale-in{animation:scaleIn 0.5s ease-out forwards;opacity:0;}
    @keyframes scaleIn{from{opacity:0;transform:scale(0.8);}to{opacity:1;transform:scale(1);}}
    .rotate-in{animation:rotateIn 0.5s ease-out forwards;opacity:0;}
    @keyframes rotateIn{from{opacity:0;transform:rotate(-10deg);}to{opacity:1;transform:rotate(0);}}
    .loading-dots{display:inline-block;position:relative;width:80px;height:20px;}
    .loading-dots div{position:absolute;top:8px;width:8px;height:8px;border-radius:50%;background:var(--glow-color-2);animation:loading-dots 1.2s linear infinite;}
    .loading-dots div:nth-child(1){left:8px;animation-delay:0s;}
    .loading-dots div:nth-child(2){left:32px;animation-delay:-0.4s;}
    .loading-dots div:nth-child(3){left:56px;animation-delay:-0.8s;}
    @keyframes loading-dots{0%, 80%, 100%{transform:scale(0);opacity:0.5;}40%{transform:scale(1);opacity:1;}}
    .pulse-animation{animation:pulse 2s infinite;}
    .bounce-animation{animation:bounce 2s infinite;}
    @keyframes bounce{0%, 20%, 50%, 80%, 100%{transform:translateY(0);}40%{transform:translateY(-10px);}60%{transform:translateY(-5px);}}
    .shake-animation{animation:shake 0.5s;}
    @keyframes shake{0%, 100%{transform:translateX(0);}10%, 30%, 50%, 70%, 90%{transform:translateX(-5px);}20%, 40%, 60%, 80%{transform:translateX(5px);}}
    .glow-animation{animation:glow 2s infinite alternate;}
    @keyframes glow{from{box-shadow:0 0 5px var(--glow-color-2);}to{box-shadow:0 0 20px var(--glow-color-2), 0 0 30px var(--glow-color-2);}}
    .profile-photo-container{position:relative;width:150px;height:150px;margin:0 auto 20px;}
    .profile-photo{width:100%;height:100%;border-radius:50%;object-fit:cover;border:4px solid var(--card-border);background:var(--card-background);}
    .profile-photo-upload{position:absolute;bottom:0;right:0;width:40px;height:40px;border-radius:50%;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--card-background);box-shadow:0 2px 5px rgba(0, 0, 0, 0.2);transition:all 0.2s ease;}
    .profile-photo-upload:hover{transform:scale(1.1);box-shadow:0 3px 8px rgba(0, 0, 0, 0.3);}
    .profile-photo-upload i{color:white;font-size:1.2rem;}
    #profile-photo-input{display:none;}
    .admin-dashboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .admin-dashboard-title{font-size:1.8rem;font-weight:800;background:var(--primary-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .admin-dashboard-actions{display:flex;gap:10px;}
    .admin-stats-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:20px;margin-bottom:30px;}
    .admin-stat-card{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:1rem;border:1px solid var(--card-border);transition:all 0.3s ease;position:relative;overflow:hidden;}
    .admin-stat-card:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.1);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .admin-stat-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--primary-gradient);opacity:0;transition:opacity 0.3s ease;}
    .admin-stat-card:hover::before{opacity:1;}
    .admin-stat-icon{font-size:2rem;margin-bottom:10px;color:var(--glow-color-2);}
    .admin-stat-value{font-size:1.8rem;font-weight:800;margin-bottom:5px;color:var(--text-primary);}
    .admin-stat-label{font-size:0.9rem;color:var(--text-secondary);}
    .admin-map-container{position:relative;height:500px;border-radius:16px;overflow:hidden;border:1px solid var(--card-border);box-shadow:inset 0 0 20px rgba(0, 0, 0, 0.5);}
    .admin-map-controls{position:absolute;top:15px;right:15px;z-index:100;display:flex;flex-direction:column;gap:10px;}
    .admin-map-control-btn{width:40px;height:40px;border-radius:50%;background:var(--card-background);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;}
    .admin-map-control-btn:hover{background:var(--glow-color-2);transform:scale(1.1);}
    .admin-map-control-btn i{color:var(--text-primary);font-size:1.2rem;}
    .admin-map-legend{position:absolute;bottom:15px;left:15px;background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;padding:10px;z-index:100;}
    .admin-map-legend-title{font-weight:600;margin-bottom:8px;font-size:0.9rem;}
    .admin-map-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:0.85rem;}
    .admin-map-legend-color{width:12px;height:12px;border-radius:50%;}
    .admin-user-table{width:100%;border-collapse:collapse;}
    .admin-user-table th, .admin-user-table td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--card-border);}
    .admin-user-table th{background:rgba(255, 255, 255, 0.05);font-weight:600;color:var(--text-primary);position:sticky;top:0;z-index:10;}
    .admin-user-table tr:hover{background:rgba(255, 255, 255, 0.05);}
    .admin-user-table tr:last-child td{border-bottom:none;}
    .admin-user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:10px;vertical-align:middle;}
    .admin-user-actions{display:flex;gap:5px;}
    .admin-user-action-btn{width:32px;height:32px;border-radius:50%;background:rgba(255, 255, 255, 0.1);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;}
    .admin-user-action-btn:hover{background:var(--glow-color-2);transform:scale(1.1);}
    .admin-user-action-btn i{color:var(--text-primary);font-size:1rem;}
    .admin-activity-timeline{max-height:400px;overflow-y:auto;}
    .admin-activity-item{display:flex;align-items:flex-start;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid var(--card-border);}
    .admin-activity-item:last-child{border-bottom:none;}
    .admin-activity-icon{width:36px;height:36px;border-radius:50%;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;margin-right:15px;flex-shrink:0;}
    .admin-activity-icon i{color:white;font-size:1.2rem;}
    .admin-activity-content{flex-grow:1;}
    .admin-activity-title{font-weight:600;margin-bottom:5px;}
    .admin-activity-time{font-size:0.8rem;color:var(--text-secondary);}
    .admin-activity-description{font-size:0.9rem;color:var(--text-secondary);margin-top:5px;}
    .admin-reports-container{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:20px;}
    .admin-report-card{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);transition:all 0.3s ease;}
    .admin-report-card:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.1);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .admin-report-icon{font-size:2.5rem;margin-bottom:15px;color:var(--glow-color-2);}
    .admin-report-title{font-size:1.2rem;font-weight:700;margin-bottom:10px;}
    .admin-report-description{font-size:0.9rem;color:var(--text-secondary);margin-bottom:15px;}
    .admin-report-actions{display:flex;gap:10px;}
    .admin-settings-panel{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);margin-bottom:20px;}
    .admin-settings-title{font-size:1.3rem;font-weight:700;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--card-border);}
    .admin-settings-group{margin-bottom:20px;}
    .admin-settings-group-title{font-size:1rem;font-weight:600;margin-bottom:10px;}
    .admin-settings-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255, 255, 255, 0.05);}
    .admin-settings-item:last-child{border-bottom:none;}
    .admin-settings-label{font-size:0.9rem;color:var(--text-primary);}
    .admin-settings-description{font-size:0.8rem;color:var(--text-secondary);margin-top:3px;}
    .admin-settings-control{flex-shrink:0;}
    .admin-notifications-container{max-height:400px;overflow-y:auto;}
    .admin-notification-item{display:flex;align-items:flex-start;padding:15px;border-radius:8px;margin-bottom:10px;background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);transition:all 0.2s ease;}
    .admin-notification-item:hover{background:rgba(255, 255, 255, 0.1);border-color:var(--glow-color-2);}
    .admin-notification-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-right:15px;flex-shrink:0;}
    .admin-notification-icon.info{background:rgba(67, 191, 255, 0.2);color:var(--glow-color-2);}
    .admin-notification-icon.success{background:rgba(39, 174, 96, 0.2);color:var(--success);}
    .admin-notification-icon.warning{background:rgba(243, 156, 18, 0.2);color:var(--warning);}
    .admin-notification-icon.danger{background:rgba(231, 76, 60, 0.2);color:var(--error);}
    .admin-notification-content{flex-grow:1;}
    .admin-notification-title{font-weight:600;margin-bottom:5px;}
    .admin-notification-time{font-size:0.8rem;color:var(--text-secondary);}
    .admin-notification-message{font-size:0.9rem;color:var(--text-secondary);margin-top:5px;}
    .admin-notification-actions{display:flex;gap:5px;margin-top:10px;}
    .admin-analytics-container{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:30px;}
    .admin-analytics-card{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);transition:all 0.3s ease;}
    .admin-analytics-card:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.1);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .admin-analytics-title{font-size:1.1rem;font-weight:700;margin-bottom:15px;}
    .admin-analytics-chart{height:200px;margin-bottom:15px;}
    .admin-analytics-summary{display:flex;justify-content:space-between;align-items:center;}
    .admin-analytics-value{font-size:1.5rem;font-weight:800;color:var(--text-primary);}
    .admin-analytics-change{font-size:0.9rem;font-weight:600;padding:4px 8px;border-radius:4px;}
    .admin-analytics-change.positive{background:rgba(39, 174, 96, 0.2);color:var(--success);}
    .admin-analytics-change.negative{background:rgba(231, 76, 60, 0.2);color:var(--error);}
    .admin-user-management-container{display:flex;flex-direction:column;gap:20px;}
    .admin-user-filters{display:flex;flex-wrap:wrap;gap:15px;padding:15px;background:rgba(255, 255, 255, 0.05);border-radius:8px;border:1px solid var(--card-border);}
    .admin-user-filter-group{flex:1;min-width:200px;}
    .admin-user-filter-label{display:block;font-size:0.9rem;font-weight:600;margin-bottom:5px;color:var(--text-secondary);}
    .admin-user-filter-control{width:100%;}
    .admin-user-actions-bar{display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255, 255, 255, 0.05);border-radius:8px;border:1px solid var(--card-border);}
    .admin-user-bulk-actions{display:flex;gap:10px;}
    .admin-user-pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;}
    .admin-user-pagination-btn{width:36px;height:36px;border-radius:50%;background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;}
    .admin-user-pagination-btn:hover{background:var(--glow-color-2);transform:scale(1.1);}
    .admin-user-pagination-btn.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .admin-user-pagination-btn i{color:var(--text-primary);font-size:1rem;}
    .admin-user-pagination-info{font-size:0.9rem;color:var(--text-secondary);}
    .admin-system-status-container{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;}
    .admin-system-status-card{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);transition:all 0.3s ease;}
    .admin-system-status-card:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.1);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .admin-system-status-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .admin-system-status-title{font-size:1.1rem;font-weight:700;}
    .admin-system-status-indicator{width:12px;height:12px;border-radius:50%;}
    .admin-system-status-indicator.online{background:var(--success);box-shadow:0 0 10px var(--success);}
    .admin-system-status-indicator.offline{background:var(--error);box-shadow:0 0 10px var(--error);}
    .admin-system-status-indicator.warning{background:var(--warning);box-shadow:0 0 10px var(--warning);}
    .admin-system-status-content{font-size:0.9rem;color:var(--text-secondary);margin-bottom:15px;}
    .admin-system-status-metrics{display:flex;justify-content:space-between;align-items:center;}
    .admin-system-status-metric{text-align:center;}
    .admin-system-status-metric-value{font-size:1.2rem;font-weight:700;color:var(--text-primary);}
    .admin-system-status-metric-label{font-size:0.8rem;color:var(--text-secondary);}
    .dashboard-stats-compact{display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:1rem;}
    @media (max-width: 768px){.dashboard-stats-compact{grid-template-columns:repeat(2, 1fr);}}
    .stat-box-compact{background:rgba(255, 255, 255, 0.15);border-radius:12px;padding:1rem;border:1px solid var(--card-border);transition:all 0.2s ease;color:#fff;box-shadow:0 4px 15px rgba(0, 0, 0, 0.2);position:relative;overflow:hidden;text-align:center;}
    .stat-box-compact::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px;background:var(--primary-gradient);opacity:0;transition:opacity 0.3s ease;}
    .stat-box-compact:hover::before{opacity:1;}
    .stat-box-compact:hover{transform:translateY(-5px);background:rgba(255, 255, 255, 0.2);box-shadow:0 8px 20px rgba(0, 0, 0, 0.3);border-color:var(--glow-color-2);}
    .stat-box-compact h4{font-weight:800;font-size:1.8rem;color:var(--text-accent);margin-bottom:0.25rem;}
    .stat-box-compact p{font-weight:600;color:var(--text-secondary);margin:0;font-size:0.85rem;}
    .chart-controls-no-line{display:flex;justify-content:center;gap:10px;margin-top:15px;}
    .chart-control-btn-no-line{padding:5px 15px;border-radius:20px;background:rgba(255, 255, 255, 0.1);border:1px solid var(--card-border);color:var(--text-primary);font-size:0.85rem;cursor:pointer;transition:all 0.2s ease;}
    .chart-control-btn-no-line:hover{background:var(--glow-color-2);border-color:var(--glow-color-2);}
    .chart-control-btn-no-line.active{background:var(--glow-color-1);border-color:var(--glow-color-1);}
    .search-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0, 0, 0, 0.8);z-index:1000;display:none;align-items:center;justify-content:center;}
    .search-modal-content{background:var(--card-background);border-radius:16px;border:1px solid var(--card-border);padding:2rem;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;}
    .search-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;}
    .search-modal-title{font-size:1.5rem;font-weight:700;color:var(--text-primary);}
    .search-modal-close{background:transparent;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;transition:color 0.2s ease;}
    .search-modal-close:hover{color:var(--text-primary);}
    .search-results{margin-top:1rem;max-height:400px;overflow-y:auto;}
    .search-result-item{padding:1rem;border-radius:8px;margin-bottom:0.5rem;background:rgba(255, 255, 255, 0.05);border:1px solid var(--card-border);cursor:pointer;transition:all 0.2s ease;}
    .search-result-item:hover{background:rgba(255, 255, 255, 0.1);border-color:var(--glow-color-2);transform:translateY(-2px);}
    .search-result-item-title{font-weight:600;margin-bottom:0.25rem;color:var(--text-primary);}
    .search-result-item-address{font-size:0.85rem;color:var(--text-secondary);}
    .search-result-item-distance{font-size:0.8rem;color:var(--text-accent);margin-top:0.25rem;}
    .quick-actions{position:fixed;bottom:20px;left:20px;background:var(--card-background);border-radius:16px;border:1px solid var(--card-border);padding:1rem;display:flex;flex-direction:column;gap:10px;z-index:100;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);transition:all 0.3s ease;}
    .quick-actions.hidden{transform:translateX(-120%);opacity:0;}
    .quick-action-btn{width:50px;height:50px;border-radius:50%;background:var(--primary-gradient);border:none;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;position:relative;}
    .quick-action-btn:hover{transform:scale(1.1);box-shadow:0 4px 10px rgba(0, 0, 0, 0.3);}
    .quick-action-btn i{font-size:1.2rem;}
    .quick-action-tooltip{position:absolute;left:60px;top:50%;transform:translateY(-50%);background:var(--card-background);border:1px solid var(--card-border);border-radius:8px;padding:0.5rem 1rem;white-space:nowrap;font-size:0.85rem;color:var(--text-primary);opacity:0;pointer-events:none;transition:opacity 0.2s ease;z-index:10;}
    .quick-action-btn:hover .quick-action-tooltip{opacity:1;}
    .toggle-quick-actions{position:fixed;bottom:20px;left:20px;width:50px;height:50px;border-radius:50%;background:var(--primary-gradient);border:none;color:white;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:99;box-shadow:0 4px 15px rgba(0, 0, 0, 0.3);transition:all 0.3s ease;}
    .toggle-quick-actions:hover{transform:scale(1.1);}
    .toggle-quick-actions.active{background:var(--error);}
    .profile-section{display:flex;flex-direction:column;gap:20px;}
    .profile-header{display:flex;flex-direction:column;align-items:center;text-align:center;margin-bottom:20px;}
    .profile-info{display:flex;flex-direction:column;align-items:center;text-align:center;margin-top:20px;}
    .profile-name{font-size:1.5rem;font-weight:700;margin-bottom:5px;}
    .profile-email{font-size:1rem;color:var(--text-secondary);margin-bottom:15px;}
    .profile-role{display:inline-block;padding:5px 15px;border-radius:20px;background:rgba(67, 191, 255, 0.2);color:var(--glow-color-2);font-weight:600;margin-bottom:20px;}
    .profile-avatar-container{position:relative;width:120px;height:120px;margin-bottom:20px;font-size:4rem;}
    .profile-avatar-initials{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1em;font-weight:600;color:white;background:var(--primary-gradient);border-radius:50%;}
    .profile-avatar-upload{position:absolute;bottom:0;right:0;width:36px;height:36px;border-radius:50%;background:var(--primary-gradient);display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--card-background);box-shadow:0 2px 5px rgba(0, 0, 0, 0.2);transition:all 0.2s ease;}
    .profile-avatar-upload:hover{transform:scale(1.1);box-shadow:0 3px 8px rgba(0, 0, 0, 0.3);}
    .profile-avatar-upload i{color:white;font-size:1rem;}
    .profile-form-container{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);}
    .profile-form-title{font-size:1.2rem;font-weight:700;margin-bottom:20px;color:var(--text-primary);}
    .profile-form-group{margin-bottom:20px;}
    .profile-form-label{display:block;font-weight:600;margin-bottom:8px;color:var(--text-primary);}
    .profile-form-input, .profile-form-select{width:100%;padding:12px 15px;border-radius:8px;background:rgba(255, 255, 255, 0.05);border:1px solid rgba(255, 255, 255, 0.1);color:var(--text-primary);transition:all 0.2s ease;}
    .profile-form-input:focus, .profile-form-select:focus{background:rgba(255, 255, 255, 0.1);border-color:var(--glow-color-2);box-shadow:0 0 15px rgba(67, 191, 255, 0.3);outline:none;}
    .profile-form-select{cursor:pointer;}
    .profile-form-select option{background:var(--card-background);color:var(--text-primary);}
    .profile-form-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;}
    .profile-form-button{padding:10px 20px;border-radius:8px;font-weight:600;transition:all 0.2s ease;}
    .profile-form-button-primary{background:var(--glow-color-1);color:white;border:none;}
    .profile-form-button-primary:hover{background:var(--glow-color-2);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0, 0, 0, 0.2);}
    .profile-form-button-secondary{background:transparent;color:var(--text-primary);border:1px solid var(--card-border);}
    .profile-form-button-secondary:hover{background:rgba(255, 255, 255, 0.05);}
    .admin-roles-container{background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;border:1px solid var(--card-border);margin-bottom:20px;}
    .admin-roles-title{font-size:1.2rem;font-weight:700;margin-bottom:20px;color:var(--text-primary);}
    .admin-roles-list{margin-bottom:20px;}
    .admin-role-item{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:rgba(255, 255, 255, 0.05);border-radius:8px;margin-bottom:10px;transition:all 0.2s ease;}
    .admin-role-item:hover{background:rgba(255, 255, 255, 0.1);}
    .admin-role-name{font-weight:600;color:var(--text-primary);}
    .admin-role-actions{display:flex;gap:5px;}
    .admin-role-action-btn{width:32px;height:32px;border-radius:50%;background:rgba(255, 255, 255, 0.1);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s ease;}
    .admin-role-action-btn:hover{background:var(--glow-color-2);transform:scale(1.1);}
    .admin-role-action-btn i{color:var(--text-primary);font-size:1rem;}
    .admin-add-role-form{display:flex;gap:10px;margin-top:20px;}
    .admin-add-role-input{flex-grow:1;padding:10px 15px;border-radius:8px;background:rgba(255, 255, 255, 0.05);border:1px solid rgba(255, 255, 255, 0.1);color:var(--text-primary);}
    .admin-add-role-input:focus{background:rgba(255, 255, 255, 0.1);border-color:var(--glow-color-2);box-shadow:0 0 15px rgba(67, 191, 255, 0.3);outline:none;}
    .admin-add-role-button{padding:10px 15px;border-radius:8px;background:var(--glow-color-1);color:white;border:none;font-weight:600;cursor:pointer;transition:all 0.2s ease;}
    .admin-add-role-button:hover{background:var(--glow-color-2);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0, 0, 0, 0.2);}
    @media (max-width: 768px){.profile-section, .admin-add-role-form{flex-direction:column;}
    .profile-info{margin-top:15px;}
    .profile-form-container, .admin-roles-container{padding:15px;}
    .admin-role-item{flex-direction:column;align-items:flex-start;gap:10px;}
    .admin-role-actions{align-self:flex-end;}}

    /* Mobile-specific improvements */
    @media (max-width: 768px) {
        /* Fix notification dropdown positioning on mobile */
        .notification-dropdown {
            position: fixed !important;
            top: 70px !important;
            left: 10px !important;
            right: 10px !important;
            width: auto !important;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Make navbar more mobile-friendly */
        .navbar {
            padding: 0.5rem 0;
        }
        
        .navbar-brand {
            font-size: 1rem;
        }
        
        .navbar-nav {
            margin-top: 1rem;
        }
        
        .nav-link {
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
        }
        
        /* Make section cards more mobile-friendly */
        .section-card {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        /* Improve button sizing on mobile */
        .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }
        
        /* Make stats more responsive */
        .dashboard-stats-compact {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-box-compact h4 {
            font-size: 1.5rem;
        }
        
        /* Make maps more usable on mobile */
        #map-wrapper, #stats-map-wrapper, #admin-live-map-wrapper, #admin-route-map-wrapper {
            height: 300px;
        }
        
        /* Improve form elements on mobile */
        .form-control, .form-select {
            font-size: 0.9rem;
        }
        
        /* Make admin analytics cards collapsible on mobile */
        .admin-analytics-card {
            position: relative;
        }
        
        .admin-analytics-card .admin-analytics-chart {
            height: 150px;
        }
        
        .admin-analytics-card .admin-analytics-summary {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        /* Make admin stats cards collapsible on mobile */
        .admin-stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .admin-stat-card {
            padding: 0.75rem;
        }
        
        .admin-stat-value {
            font-size: 1.5rem;
        }
        
        /* Improve admin user table on mobile */
        .admin-user-table {
            font-size: 0.85rem;
        }
        
        .admin-user-table th, .admin-user-table td {
            padding: 8px 10px;
        }
        
        /* Make system status cards more compact */
        .admin-system-status-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .admin-system-status-card {
            padding: 15px;
        }
        
        .admin-system-status-title {
            font-size: 1rem;
        }
        
        .admin-system-status-content {
            font-size: 0.85rem;
        }
        
        .admin-system-status-metrics {
            justify-content: space-around;
        }
        
        .admin-system-status-metric-value {
            font-size: 1rem;
        }
        
        .admin-system-status-metric-label {
            font-size: 0.75rem;
        }
        
        /* Make top performing users grid more responsive */
        .top-performing-users-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .top-performing-user-card {
            padding: 15px 10px;
        }
        
        .top-performing-user-avatar {
            width: 60px;
            height: 60px;
        }
        
        .top-performing-user-name {
            font-size: 0.9rem;
        }
        
        .top-performing-user-email {
            font-size: 0.7rem;
        }
        
        .top-performing-user-stats {
            font-size: 0.75rem;
        }
        
        .top-performing-user-actions .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        /* Improve modal display on mobile */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-content {
            border-radius: 12px;
        }
        
        /* Make calendar more mobile-friendly */
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .fc .fc-toolbar-title {
            font-size: 1rem;
        }
        
        .fc .fc-daygrid-day-frame {
            min-height: 60px;
        }
        
        .fc .fc-daygrid-day-number {
            font-size: 0.7rem;
            padding: 4px;
        }
        
        .fc .fc-daygrid-event {
            font-size: 0.65rem;
            padding: 1px 4px;
            margin: 1px 2px;
        }
        
        .calendar-legend {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .legend-item {
            font-size: 0.75rem;
        }
        
        /* Make profile section more mobile-friendly */
        .profile-avatar-container {
            width: 100px;
            height: 100px;
        }
        
        .profile-name {
            font-size: 1.25rem;
        }
        
        /* Make admin roles section more mobile-friendly */
        .admin-role-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .admin-role-actions {
            align-self: flex-end;
        }
    }

    /* Collapsible sections for admin dashboard */
    .collapsible-section {
        margin-bottom: 1rem;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--card-border);
    }

    .collapsible-header {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem 1.25rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s ease;
    }

    .collapsible-header:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .collapsible-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .collapsible-icon {
        transition: transform 0.3s ease;
        color: var(--text-secondary);
    }

    .collapsible-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .collapsible-section.active .collapsible-icon {
        transform: rotate(180deg);
    }

    .collapsible-section.active .collapsible-content {
        padding: 1.25rem;
        max-height: 2000px;
    }

    /* Improved Productivity Metrics Pie Chart */
    .productivity-metrics-chart-container {
        position: relative;
        height: 200px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #productivity-metrics-chart {
        max-width: 180px;
        max-height: 180px;
    }

    /* Enhanced chart hover effects */
    .chart-container {
        position: relative;
    }

    .chart-container canvas {
        transition: transform 0.3s ease;
    }

    .chart-container:hover canvas {
        transform: scale(1.02);
    }

    /* Improved loading states */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(12, 14, 20, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        border-radius: 12px;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top-color: var(--glow-color-2);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Improved mobile navigation */
    @media (max-width: 768px) {
        .navbar-collapse {
            background: rgba(15, 17, 26, 0.95);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid var(--card-border);
        }
        
        .notification-bell {
            margin-left: 1rem;
        }
        
        .navbar-nav {
            flex-direction: column;
            width: 100%;
        }
        
        .nav-item {
            width: 100%;
        }
        
        .nav-link {
            width: 100%;
            text-align: center;
        }
    }

    /* Improved mobile map controls */
    @media (max-width: 768px) {
        .map-controls {
            top: 5px;
            right: 5px;
        }
        
        .map-control-btn {
            width: 32px;
            height: 32px;
        }
        
        .map-control-btn i {
            font-size: 0.9rem;
        }
        
        .map-weather-widget {
            top: 5px;
            left: 5px;
            padding: 8px;
        }
        
        .map-weather-icon {
            font-size: 1.2rem;
        }
        
        .map-weather-info {
            font-size: 0.75rem;
        }
        
        .map-heatmap-toggle, .map-traffic-toggle {
            bottom: 5px;
            right: 5px;
        }
        
        .map-heatmap-btn, .map-traffic-btn {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
        
        .map-distance-tool {
            bottom: 45px;
            left: 5px;
        }
        
        .map-distance-btn {
            padding: 6px 12px;
            font-size: 0.75rem;
        }
    }

    /* Improved mobile calendar */
    @media (max-width: 768px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .fc .fc-toolbar-title {
            font-size: 1rem;
        }
        
        .fc .fc-daygrid-day-frame {
            min-height: 60px;
        }
        
        .fc .fc-daygrid-day-number {
            font-size: 0.7rem;
            padding: 4px;
        }
        
        .fc .fc-daygrid-event {
            font-size: 0.65rem;
            padding: 1px 4px;
            margin: 1px 2px;
        }
        
        .calendar-legend {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .legend-item {
            font-size: 0.75rem;
        }
    }

    /* Improved mobile admin dashboard */
    @media (max-width: 768px) {
        .admin-dashboard-header {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .admin-dashboard-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .admin-dashboard-actions .btn {
            flex: 1;
            font-size: 0.85rem;
        }
        
        .admin-stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .admin-stat-card {
            padding: 0.75rem;
        }
        
        .admin-stat-icon {
            font-size: 1.5rem;
        }
        
        .admin-stat-value {
            font-size: 1.5rem;
        }
        
        .admin-stat-label {
            font-size: 0.8rem;
        }
        
        .admin-stat-change {
            font-size: 0.7rem;
            padding: 2px 6px;
        }
    }

    /* Improved mobile analytics cards */
    @media (max-width: 768px) {
        .admin-analytics-container {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .admin-analytics-card {
            padding: 15px;
        }
        
        .admin-analytics-title {
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .admin-analytics-chart {
            height: 150px;
        }
        
        .admin-analytics-summary {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        
        .admin-analytics-value {
            font-size: 1.25rem;
        }
        
        .admin-analytics-change {
            font-size: 0.8rem;
            padding: 2px 6px;
        }
    }

    /* Improved mobile user management */
    @media (max-width: 768px) {
        .admin-user-filters {
            flex-direction: column;
            gap: 10px;
        }
        
        .admin-user-filter-group {
            width: 100%;
        }
        
        .admin-user-actions-bar {
            flex-direction: column;
            gap: 10px;
        }
        
        .admin-user-bulk-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .admin-user-bulk-actions .btn {
            flex: 1;
            font-size: 0.85rem;
        }
    }

    /* Improved mobile system status */
    @media (max-width: 768px) {
        .admin-system-status-container {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .admin-system-status-card {
            padding: 15px;
        }
        
        .admin-system-status-title {
            font-size: 1rem;
        }
        
        .admin-system-status-content {
            font-size: 0.85rem;
        }
        
        .admin-system-status-metrics {
            justify-content: space-around;
        }
        
        .admin-system-status-metric-value {
            font-size: 1rem;
        }
        
        .admin-system-status-metric-label {
            font-size: 0.75rem;
        }
    }

    /* Improved mobile settings */
    @media (max-width: 768px) {
        .admin-settings-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .admin-settings-control {
            align-self: flex-end;
        }
    }

    /* Improved mobile reports */
    @media (max-width: 768px) {
        .admin-reports-container {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .admin-report-card {
            padding: 15px;
        }
        
        .admin-report-icon {
            font-size: 2rem;
        }
        
        .admin-report-title {
            font-size: 1.1rem;
        }
        
        .admin-report-description {
            font-size: 0.85rem;
        }
        
        .admin-report-actions {
            flex-direction: column;
            gap: 10px;
        }
        
        .admin-report-actions .btn {
            width: 100%;
        }
    }

    /* Improved mobile notifications */
    @media (max-width: 768px) {
        .admin-notifications-container {
            max-height: 300px;
        }
        
        .admin-notification-item {
            padding: 12px;
        }
        
        .admin-notification-icon {
            width: 32px;
            height: 32px;
        }
        
        .admin-notification-title {
            font-size: 0.9rem;
        }
        
        .admin-notification-time {
            font-size: 0.75rem;
        }
        
        .admin-notification-message {
            font-size: 0.85rem;
        }
        
        .admin-notification-actions {
            flex-direction: column;
            gap: 5px;
        }
        
        .admin-notification-actions .btn {
            width: 100%;
            font-size: 0.85rem;
        }
    }

    /* Improved mobile activity timeline */
    @media (max-width: 768px) {
        .admin-activity-timeline {
            max-height: 300px;
        }
        
        .admin-activity-item {
            padding-left: 40px;
        }
        
        .admin-activity-item::before {
            left: 10px;
            width: 10px;
            height: 10px;
        }
        
        .timeline::before {
            left: 15px;
        }
        
        .admin-activity-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        .admin-activity-icon i {
            font-size: 1rem;
        }
        
        .admin-activity-title {
            font-size: 0.9rem;
        }
        
        .admin-activity-time {
            font-size: 0.75rem;
        }
        
        .admin-activity-description {
            font-size: 0.85rem;
        }
    }

    /* Improved mobile user table */
    @media (max-width: 768px) {
        .admin-user-table {
            font-size: 0.8rem;
        }
        
        .admin-user-table th, .admin-user-table td {
            padding: 6px 8px;
        }
        
        .admin-user-avatar {
            width: 28px;
            height: 28px;
        }
        
        .admin-user-action-btn {
            width: 28px;
            height: 28px;
        }
        
        .admin-user-action-btn i {
            font-size: 0.85rem;
        }
    }

    /* Improved mobile map legend */
    @media (max-width: 768px) {
        .admin-map-legend {
            bottom: 10px;
            left: 10px;
            right: 10px;
            max-width: none;
            padding: 8px;
        }
        
        .admin-map-legend-title {
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .admin-map-legend-item {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .admin-map-legend-color {
            width: 10px;
            height: 10px;
        }
    }

    /* Improved mobile top performing users */
    @media (max-width: 768px) {
        .top-performing-users-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .top-performing-user-card {
            padding: 15px 10px;
        }
        
        .top-performing-user-avatar {
            width: 60px;
            height: 60px;
        }
        
        .top-performing-user-name {
            font-size: 0.9rem;
        }
        
        .top-performing-user-email {
            font-size: 0.7rem;
        }
        
        .top-performing-user-stats {
            font-size: 0.75rem;
        }
        
        .top-performing-user-actions .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
    }

    /* Improved mobile roles management */
    @media (max-width: 768px) {
        .admin-add-role-form {
            flex-direction: column;
            gap: 10px;
        }
        
        .admin-add-role-button {
            width: 100%;
        }
    }

    /* Fix for modal backdrop */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.3) !important;
        opacity: 0.5 !important;
    }

    /* Admin user details modal tabs */
    .admin-modal-tabs {
        border-bottom: 1px solid var(--card-border);
        margin-bottom: 1rem;
        display: flex;
    }

    .admin-modal-tab {
        padding: 0.75rem 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
        position: relative;
        font-weight: 600;
    }

    .admin-modal-tab:hover {
        color: var(--text-primary);
    }

    .admin-modal-tab.active {
        color: var(--text-primary);
        border-bottom-color: var(--glow-color-2);
    }

    .admin-modal-tab.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--glow-color-2);
    }

    .admin-modal-tab-content {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }

    .admin-modal-tab-content.active {
        display: block;
    }

    /* Fix for admin section disappearing when modal opens */
    .modal-open .section {
        filter: blur(0);
        transform: none;
        opacity: 1;
    }

    /* Admin Set Status Modal Styles */
    /* --- Enhanced Admin Set Status Modal Styles --- */

    #adminSetStatusModal .modal-content {
    background: rgb(22, 25, 37); /* Opaque dark background */
    border: 1px solid var(--card-border);
    color: var(--text-primary);
    border-radius: var(--border-radius); /* Use theme's border radius (16px) */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); /* Stronger shadow to pop */
    overflow: hidden; /* Ensures header/footer corners are clipped */
    }

    #adminSetStatusModal .modal-header {
    background: rgba(255, 255, 255, 0.05); /* Slight highlight for the header */
    border-bottom: 1px solid var(--card-border);
    padding: 1.25rem; /* Add consistent padding */
    }

    #adminSetStatusModal .modal-title {
    color: var(--text-primary);
    font-weight: 700; /* Bolder title */
    }

    #adminSetStatusModal .modal-body {
    padding: 1.5rem;
    }

    #adminSetStatusModal .modal-footer {
    background: rgba(255, 255, 255, 0.02); /* Subtle background for footer */
    border-top: 1px solid var(--card-border);
    }

    #adminSetStatusModal .form-label {
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    }

    #adminSetStatusModal .form-control {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    border-radius: 8px;
    }

    #adminSetStatusModal .form-control:focus {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--glow-color-2);
    box-shadow: 0 0 15px rgba(67, 191, 255, 0.3);
    }

    #adminSetStatusModal .form-check {
    margin-bottom: 0.75rem;
    }

    #adminSetStatusModal .form-check-input {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    }

    #adminSetStatusModal .form-check-input:checked {
    background-color: var(--glow-color-2);
    border-color: var(--glow-color-2);
    }

    #adminSetStatusModal .form-check-label {
    color: var(--text-primary);
    font-weight: 500;
    }

    #adminSetStatusModal .btn-primary {
    background: var(--glow-color-1);
    border: none;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    }

    #adminSetStatusModal .btn-primary:hover {
    background: var(--glow-color-2);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* Admin Set Status Button Styles (This was part of your original block) */
    .set-status-btn {
    background: rgba(67, 191, 255, 0.2);
    border: 1px solid var(--glow-color-2);
    color: var(--glow-color-2);
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    border-radius: 6px;
    margin-left: auto;
    transition: all 0.2s ease;
    }

    .set-status-btn:hover {
    background: var(--glow-color-2);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Ensure all buttons have pointer cursor */
    button, .btn, input[type="button"], input[type="submit"], .btn-primary, .btn-secondary, .btn-info, .btn-success, .btn-warning, .btn-danger, .btn-outline-primary, .btn-outline-secondary, .btn-outline-info, .btn-outline-success, .btn-outline-warning, .btn-outline-danger, .set-status-btn, .admin-role-action-btn, .admin-user-action-btn, .quick-action-btn, .toggle-quick-actions, .fab, .map-control-btn, .map-heatmap-btn, .map-traffic-btn, .map-distance-btn, .chart-control-btn, .chart-control-btn-no-line, .admin-modal-tab, .collapsible-header, .nav-link, .admin-add-role-button {
        cursor: pointer;
    }

    /* Add these new rules inside the <style> tag */
    .event-remote, .legend-dot.remote { background: linear-gradient(45deg, #f39c12, #f1c40f) !important; }
    .event-holiday, .legend-dot.holiday { background: linear-gradient(45deg, #9b59b6, #8e44ad) !important; }
    </style>
    </head>
    <body>
        <div id="app-loader">
        <div class="spinner"></div>
    </div>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand text-light d-flex align-items-center gap-2" style="font-weight: 700; font-size: 1.2rem;">
                <img src="./Bureau_Veritas.svg.png" alt="Bureau Veritas Logo" style="height: 35px; width: auto; filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.4));"> 
                Bureau Veritas
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" data-sec="dashboard"><i class="bi bi-layout-wtf"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" data-sec="statistics"><i class="bi bi-bar-chart-line"></i> Statistics</a></li>
                    <li class="nav-item"><a class="nav-link" data-sec="profile"><i class="bi bi-person-circle"></i> Profile</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" data-sec="admin"><i class="bi bi-people"></i> Admin</a></li>
                    <li class="nav-item"><a class="nav-link" data-sec="help"><i class="bi bi-question-circle"></i> Help</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="user-name" class="navbar-text text-light me-3" style="font-weight: 600;"></span>
                    <div class="notification-bell">
    <i class="bi bi-bell-fill text-light"></i>
    <span class="notification-badge"></span>
    <div class="notification-dropdown">
        <div class="notification-header">
            <span>Notifications</span>
            <button class="btn btn-sm btn-link text-light">Mark all as read</button>
        </div>
        </div>
</div>
                    <button id="logout-btn" class="btn btn-outline-danger btn-sm">Logout</button>
                </div>
            </div>
        </div>
    </nav>
    <div id="global-alert-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 10050;"></div>
    <div id="image-viewer" style="display: none;"><img id="fullscreen-image" src="" loading="lazy"></div>
    
    <!-- Day Detail Modal -->
    <div class="modal fade" id="dayDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-date-display"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Activity on this day:</h6>
                    <div id="modal-event-details" class="list-group list-group-flush bg-transparent"></div>
                    <hr>
                    <h6>Mark Your Attendance:</h6>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-info" id="modal-mark-office-btn"><i class="bi bi-building me-2"></i>Mark as Office Work</button>
                        <button class="btn btn-warning" id="modal-mark-remote-btn"><i class="bi bi-house-door me-2"></i>Mark as Remote Job</button>
                        <button class="btn btn-danger" id="modal-mark-leave-btn"><i class="bi bi-calendar-x me-2"></i>Mark as Leave</button>
                        <button class="btn btn-secondary" id="modal-mark-clear-btn"><i class="bi bi-x-circle me-2"></i>Clear Status</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contact User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-grid gap-2">
                    <a id="modal-email-btn" class="btn btn-primary"><i class="bi bi-envelope me-2"></i>Email</a>
                    <a id="modal-call-btn" class="btn btn-info" style="display: none;"><i class="bi bi-telephone"></i>Call</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Route Modal -->
    <div class="modal fade" id="adminRouteModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminRouteModalTitle">Live Route</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="admin-route-map-wrapper">
                        <div id="admin-route-map"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin User Details Modal -->
    <div class="modal fade" id="adminUserDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="admin-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="admin-modal-user-info mb-3">
                        <p><i class="bi bi-envelope me-2"></i><strong>Email:</strong> <span id="admin-modal-email"></span></p>
                        <p><i class="bi bi-person me-2"></i><strong>Full Name:</strong> <span id="admin-modal-fullname"></span></p>
                        <p><i class="bi bi-telephone me-2"></i><strong>Contact:</strong> <span id="admin-modal-contact"></span></p>
                        <p><i class="bi bi-person-badge me-2"></i><strong>Role:</strong> <span id="admin-modal-role"></span></p>
                    </div>
                    
                    <!-- Custom tabs for Records and Calendar -->
                    <div class="admin-modal-tabs">
                        <div class="admin-modal-tab active" data-tab="records">
                            <i class="bi bi-list-ul me-2"></i> Records
                        </div>
                        <div class="admin-modal-tab" data-tab="calendar">
                            <i class="bi bi-calendar-event me-2"></i> Calendar
                        </div>
                    </div>
                    
                    <!-- Tab content -->
                    <div class="admin-modal-tab-content active" id="records-tab-content">
                        <div id="admin-modal-summary-stats" class="mb-3"></div>
                        <div id="admin-modal-records-list"></div>
                    </div>
                    <div class="admin-modal-tab-content" id="calendar-tab-content">
                        <div id="admin-modal-calendar"></div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div class="d-flex gap-2">
                        <button class="btn btn-info btn-sm" id="admin-modal-export-btn"><i class="bi bi-download"></i> Export</button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Set Status Modal -->
    <div class="modal fade" id="adminSetStatusModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Set User Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="admin-set-status-form">
                        <div class="mb-3">
                            <label for="admin-status-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="admin-status-date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="admin-status" id="admin-status-office" value="office">
                                <label class="form-check-label" for="admin-status-office">
                                    Office
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="admin-status" id="admin-status-leave" value="leave">
                                <label class="form-check-label" for="admin-status-leave">
                                    Leave
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="admin-status" id="admin-status-remote" value="remote">
                                <label class="form-check-label" for="admin-status-remote">Remote Job</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="admin-status" id="admin-status-clear" value="clear">
                                <label class="form-check-label" for="admin-status-clear">
                                    Clear Status
                                </label>
                            </div>
                        </div>
                        <input type="hidden" id="admin-status-uid">
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Set Holiday Modal -->
    <div class="modal fade" id="adminSetHolidayModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Set Holiday</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="admin-set-holiday-form">
                        <div class="mb-3">
                            <label for="admin-holiday-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="admin-holiday-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="admin-holiday-name" class="form-label">Holiday Name</label>
                            <input type="text" class="form-control" id="admin-holiday-name" placeholder="e.g., Independence Day" required>
                        </div>
                        <div class="mb-3">
                            <label for="admin-holiday-description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="admin-holiday-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="admin-holiday-notify" checked>
                                <label class="form-check-label" for="admin-holiday-notify">
                                    Notify all users about this holiday
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Set Holiday</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div id="container-main">
        <div class="section active" id="dashboard">
            <div class="section-card" id="dashboard-summary-card">
                <div class="section-title"><i class="bi bi-speedometer2"></i> Quick Stats</div>
                <div id="dashboard-stats-container">
                    <div id="no-data-stats" class="empty-state animated-card">
                        <i class="bi bi-bar-chart-fill empty-state-icon"></i>
                        <h5>No Data to Display Yet</h5>
                        <p>Start by marking a site visit!</p>
                    </div>
                </div>
                <div class="weather-widget mt-3">
                    <i class="bi bi-cloud-sun map-weather-icon"></i>
                    <div class="map-weather-info">
                        <div class="map-weather-temp">28C</div>
                        <div class="map-weather-desc">Partly Cloudy</div>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-lg-7 mb-4">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-map"></i> Mark On-Site Visit</div>
                        <div class="mb-3">
                            <div class="search-container">
                                <i class="bi bi-search search-icon"></i>
                                <input id="site-search-input" type="text" class="form-control pac-target-input search-input" placeholder="Search for a site or address..." />
                                <i class="bi bi-x-lg search-clear"></i>
                            </div>
                        </div>
                        <div id="map-wrapper" style="flex-grow: 1;">
                            <div id="map"></div>
                            <div class="map-controls">
                                <div class="map-control-btn" title="Center on your location"><i class="bi bi-crosshair"></i></div>
                                <div class="map-control-btn" title="Toggle satellite view"><i class="bi bi-layers-half"></i></div>
                                <div class="map-control-btn" title="Zoom in"><i class="bi bi-zoom-in"></i></div>
                                <div class="map-control-btn" title="Zoom out"><i class="bi bi-zoom-out"></i></div>
                            </div>
                            <div class="map-weather-widget">
                                <i class="bi bi-cloud-sun map-weather-icon"></i>
                                <div class="map-weather-info">
                                    <div class="map-weather-temp">28C</div>
                                    <div class="map-weather-desc">Partly Cloudy</div>
                                </div>
                            </div>
                            <div class="map-heatmap-toggle">
                                <button class="map-heatmap-btn">Heatmap</button>
                            </div>
                            <div class="map-traffic-toggle">
                                <button class="map-traffic-btn">Traffic</button>
                            </div>
                            <div class="map-distance-tool">
                                <button class="map-distance-btn">Measure</button>
                                <div class="map-distance-info">0 km</div>
                            </div>
                        </div>
                        <div id="gps-status" class="text-center mt-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div> Acquiring GPS...
                        </div>
                        <div class="d-flex justify-content-center gap-3 my-3 flex-column flex-sm-row" style="flex-shrink: 0;">
                            <button id="checkin-btn" class="btn btn-success btn-lg-responsive"><i class="bi bi-box-arrow-in-right"></i> Mark Entry</button>
                            <button id="checkout-btn" class="btn btn-warning btn-lg-responsive"><i class="bi bi-box-arrow-right"></i> Mark Exit</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 mb-4">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-calendar-check"></i> Attendance Calendar</div>
                        <div id="dashboard-calendar" style="flex-grow: 1;"></div>
                        <div class="calendar-legend">
                            <div class="legend-item"><span class="legend-dot site-visit"></span> Site Visit</div>
                            <div class="legend-item"><span class="legend-dot office"></span> Office</div>
                            <div class="legend-item"><span class="legend-dot remote"></span> Remote Job</div>
                            <div class="legend-item"><span class="legend-dot holiday"></span> Holiday</div>
                            <div class="legend-item"><span class="legend-dot leave"></span> Leave</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-title"><i class="bi bi-clock-history"></i> Your Recent Site Visits</div>
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <label class="form-label mb-0 fw-bold">Filter by:</label>
                    <select id="filter-select" class="form-select form-select-sm" style="max-width:180px;">
                        <option value="all">All Time</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7">Last 7 Days</option>
                        <option value="last30">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <input type="date" id="start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                    <input type="date" id="end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                </div>
                <div id="attendance-cards-container">
                    <div id="attendance-cards"></div>
                </div>
                <div id="load-more-container" class="text-center mt-3" style="display: none;"><button id="load-more-btn" class="btn btn-outline-primary">Load More</button></div>
            </div>
        </div>
        <div class="section" id="statistics">
            <div class="row g-4 mb-4">
                <div class="col-md-5">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-pie-chart"></i> Activity Breakdown</div>
                        <div id="activity-chart-container" style="position: relative; height: 300px;">
                            <div id="no-data-chart" class="empty-state">
                                <i class="bi bi-activity empty-state-icon"></i>
                                <h5>No Activity Data</h5>
                                <p>Mark your attendance to see a breakdown here.</p>
                            </div>
                            <canvas id="userActivityChart" style="display: none;"></canvas>
                        </div>
                        <div class="chart-controls-no-line">
                            <button class="chart-control-btn-no-line active" data-chart-type="doughnut">Doughnut</button>
                            <button class="chart-control-btn-no-line" data-chart-type="bar">Bar</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-7">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-bar-chart-line"></i> Summary Statistics</div>
                        <div id="statistics-holder">
                            <div id="no-data-summary" class="empty-state">
                                <i class="bi bi-bar-chart-line-fill empty-state-icon"></i>
                                <h5>No Data to Display Yet</h5>
                                <p>Start by marking a site visit!</p>
                            </div>
                        </div>
                        <div class="progress-container mt-4">
                            <div class="progress-label">
                                <span>Attendance Rate</span>
                                <span id="attendance-rate">87%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" id="attendance-progress" style="width: 87%"></div>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>Completion Rate</span>
                                <span id="completion-rate">92%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" id="completion-progress" style="width: 92%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-12">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-sign-turn-right"></i> Your Travel Details</div>
                        <div id="stats-travel-container">
                            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                <label class="form-label mb-0 fw-bold">Filter by:</label>
                                <select id="stats-travel-filter-select" class="form-select form-select-sm" style="max-width:180px;">
                                    <option value="all">All Time</option>
                                    <option value="last7">Last 7 Days</option>
                                    <option value="last30">Last 30 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                                <input type="date" id="stats-travel-start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                                <input type="date" id="stats-travel-end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                            </div>
                            <div id="stats-travel-summary"></div>
                            <div id="stats-travel-details" class="mt-3"></div>
                            <div id="stats-map-wrapper" class="mt-4">
                                <div id="stats-map"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section" id="profile">
            <div class="row g-4">
                <div class="col-12">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-person-badge"></i> Your Profile</div>
                        <div class="profile-section">
                            <div class="profile-header">
                                <div class="profile-avatar-container">
                                    <div id="profile-avatar" class="profile-avatar-initials">JD</div>
                                    <div class="profile-photo-upload" onclick="document.getElementById('profile-photo-input').click()">
                                        <i class="bi bi-camera-fill"></i>
                                    </div>
                                    <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
                                </div>
                                <div class="profile-info">
                                    <h2 id="profile-name-display" class="profile-name">John Doe</h2>
                                    <p id="profile-email-display" class="profile-email">john.doe@example.com</p>
                                    <span class="profile-role" id="profile-role-display">Engineer</span>
                                </div>
                            </div>
                            
                            <div class="profile-form-container">
                                <h3 class="profile-form-title">Edit Profile</h3>
                                <form id="profile-form">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="profile-form-group">
                                                <label class="profile-form-label" for="prof-email">Email</label>
                                                <input id="prof-email" class="profile-form-input" disabled>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="profile-form-group">
                                                <label class="profile-form-label" for="prof-username">Username</label>
                                                <input id="prof-username" class="profile-form-input">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="profile-form-group">
                                                <label class="profile-form-label" for="prof-fullname">Full Name</label>
                                                <input id="prof-fullname" class="profile-form-input">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="profile-form-group">
                                                <label class="profile-form-label" for="prof-contact">Contact</label>
                                                <input id="prof-contact" class="profile-form-input">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="profile-form-group">
                                                <label class="profile-form-label" for="prof-role">Role</label>
                                                <select id="prof-role" class="profile-form-select">
                                                    <option value="Engineer">Engineer</option>
                                                    <option value="Senior Engineer">Senior Engineer</option>
                                                    <option value="Project Manager">Project Manager</option>
                                                    <option value="Site Supervisor">Site Supervisor</option>
                                                    <option value="Quality Inspector">Quality Inspector</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="profile-form-buttons">
                                        <button type="submit" class="profile-form-button profile-form-button-primary">Save Changes</button>
                                        <button type="button" class="profile-form-button profile-form-button-secondary">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="section-card">
                        <div class="section-title"><i class="bi bi-house-gear"></i> Set Home Address</div>
                        <form id="home-address-form">
                            <div class="mb-3">
                                <label class="form-label">Your current home address</label>
                                <div class="input-group">
                                    <input type="text" id="home-address-input" class="form-control pac-target-input" placeholder="Start typing your address..." />
                                    <span class="input-group-text" id="home-valid-icon" style="display: none;"><i class="bi bi-check-circle-fill text-success"></i></span>
                                </div>
                                <div class="form-text">This is used to calculate travel distances.</div>
                            </div>
                            <button class="btn btn-success" type="submit">Save Home</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="section" id="admin">
            <div class="section-card" id="admin-summary-card">
                <div class="section-title"><i class="bi bi-speedometer2"></i> Admin Overview</div>
                <div id="admin-stats-container"></div>
                <div class="top-performing-users-container" id="top-performing-users-container">
                    <h5 class="w-100 mb-3">Top Performing Employees</h5>
                    <div id="top-performing-users-list">
                        <div class="empty-state">
                            <i class="bi bi-trophy-fill empty-state-icon"></i>
                            <h5>No employee data yet</h5>
                            <p>Employee performance data will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Holiday Management Section -->
            <div class="section-card">
                <div class="section-title"><i class="bi bi-calendar-event"></i> Holiday Management</div>
                <div class="admin-holiday-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="admin-holiday-title">Manage Holidays</h3>
                        <button id="admin-set-holiday-btn" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i> Set Holiday
                        </button>
                    </div>
                    <div id="admin-holidays-list" class="admin-holidays-list">
                        <div class="empty-state">
                            <i class="bi bi-calendar-x empty-state-icon"></i>
                            <h5>No holidays set yet</h5>
                            <p>Holidays will appear here once they are set</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Roles Management Section -->
            <div class="section-card">
                <div class="section-title"><i class="bi bi-person-badge-fill"></i> Roles Management</div>
                <div class="admin-roles-container">
                    <h3 class="admin-roles-title">Manage User Roles</h3>
                    <div class="admin-roles-list" id="admin-roles-list">
                        <div class="admin-role-item">
                            <span class="admin-role-name">Engineer</span>
                            <div class="admin-role-actions">
                                <button class="admin-role-action-btn" title="Edit Role">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="admin-role-action-btn" title="Delete Role">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="admin-role-item">
                            <span class="admin-role-name">Senior Engineer</span>
                            <div class="admin-role-actions">
                                <button class="admin-role-action-btn" title="Edit Role">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="admin-role-action-btn" title="Delete Role">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="admin-role-item">
                            <span class="admin-role-name">Project Manager</span>
                            <div class="admin-role-actions">
                                <button class="admin-role-action-btn" title="Edit Role">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="admin-role-action-btn" title="Delete Role">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="admin-add-role-form">
                        <input type="text" id="new-role-input" class="admin-add-role-input" placeholder="Enter new role name">
                        <button id="add-role-btn" class="admin-add-role-button">
                            <i class="bi bi-plus-circle"></i> Add Role
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Live Employee Map Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-broadcast-pin"></i> Live Employee Map</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="admin-map-container">
                        <div id="admin-live-map"></div>
                        <div class="admin-map-controls">
                            <div class="admin-map-control-btn" title="Refresh map"><i class="bi bi-arrow-clockwise"></i></div>
                            <div class="admin-map-control-btn" title="Fit all markers"><i class="bi bi-arrows-angle-expand"></i></div>
                            <div class="admin-map-control-btn" title="Toggle satellite view"><i class="bi bi-layers-half"></i></div>
                            <div class="admin-map-control-btn" title="Toggle traffic layer"><i class="bi bi-traffic-light"></i></div>
                            <div class="admin-map-control-btn" title="Toggle heatmap"><i class="bi bi-fire"></i></div>
                            <div class="admin-map-control-btn" title="Toggle weather"><i class="bi bi-cloud-sun"></i></div>
                        </div>
                        <div class="admin-map-legend">
                            <div class="admin-map-legend-title">Legend</div>
                            <div class="admin-map-legend-item">
                                <div class="admin-map-legend-color" style="background-color: #4c68ff;"></div>
                                <span>Active Employee</span>
                            </div>
                            <div class="admin-map-legend-item">
                                <div class="admin-map-legend-color" style="background-color: #6c757d;"></div>
                                <span>Inactive Employee</span>
                            </div>
                            <div class="admin-map-legend-item">
                                <div class="admin-map-legend-color" style="background-color: #f39c12;"></div>
                                <span>Office Location</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span id="admin-live-map-status" class="small text-secondary"></span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="refresh-live-map"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                            <button class="btn btn-sm btn-outline-primary" id="fit-all-markers"><i class="bi bi-arrows-angle-expand"></i> Fit All</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible User Selection Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-people"></i> Select Users</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-primary btn-sm" id="admin-toggle-select-mode"><i class="bi bi-check2-square me-2"></i>Select</button>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        <label class="form-label mb-0 fw-bold">Filter records by:</label>
                        <select id="admin-filter-select" class="form-select form-select-sm" style="max-width:180px;">
                            <option value="all">All Time</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="last7">Last 7 Days</option>
                            <option value="last30">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <input type="date" id="admin-start-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                        <input type="date" id="admin-end-date" class="form-control form-control-sm" style="display:none; max-width: 150px;">
                    </div>
                    <div id="admin-actions-bar" class="d-flex justify-content-between align-items-center mb-3" style="display: none;">
                        <div class="form-check mb-0">
                            <input class="form-check-input" type="checkbox" id="admin-select-all-users">
                            <label class="form-check-label" for="admin-select-all-users">Select All</label>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="admin-export-selected" class="btn btn-info btn-sm"><i class="bi bi-download"></i> Export</button>
                            <button id="admin-delete-selected" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i> Delete</button>
                        </div>
                    </div>
                    <div class="mb-3"><input type="text" id="admin-user-search" class="form-control" placeholder="Search users..."></div>
                    <div id="admin-users-list" class="mb-4"></div>
                </div>
            </div>
            
            <!-- Collapsible Issues Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-exclamation-triangle"></i> Reported Issues</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div id="admin-issues-holder" class="issue-list-container"></div>
                </div>
            </div>
            
            <!-- Collapsible Analytics Dashboard Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-graph-up"></i> Analytics Dashboard</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="admin-analytics-container">
                        <div class="admin-analytics-card">
                            <div class="admin-analytics-title">Attendance Trends</div>
                            <div class="admin-analytics-chart">
                                <canvas id="attendance-trends-chart"></canvas>
                            </div>
                            <div class="admin-analytics-summary">
                                <div class="admin-analytics-value">+8%</div>
                                <div class="admin-analytics-change positive">vs last month</div>
                            </div>
                        </div>
                        <div class="admin-analytics-card">
                            <div class="admin-analytics-title">Productivity Metrics</div>
                            <div class="admin-analytics-chart productivity-metrics-chart-container">
                                <canvas id="productivity-metrics-chart"></canvas>
                            </div>
                            <div class="admin-analytics-summary">
                                <div class="admin-analytics-value">92%</div>
                                <div class="admin-analytics-change positive">vs last month</div>
                            </div>
                        </div>
                        <div class="admin-analytics-card">
                            <div class="admin-analytics-title">Travel Patterns</div>
                            <div class="admin-analytics-chart">
                                <canvas id="travel-patterns-chart"></canvas>
                            </div>
                            <div class="admin-analytics-summary">
                                <div class="admin-analytics-value">215 km</div>
                                <div class="admin-analytics-change negative">vs last month</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible System Settings Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-gear"></i> System Settings</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="admin-settings-panel">
                        <div class="admin-settings-group">
                            <div class="admin-settings-group-title">General Settings</div>
                            <div class="admin-settings-item">
                                <div>
                                    <div class="admin-settings-label">Enable Email Notifications</div>
                                    <div class="admin-settings-description">Send email notifications for important events</div>
                                </div>
                                <div class="admin-settings-control">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-settings-item">
                                <div>
                                    <div class="admin-settings-label">Auto-refresh Live Map</div>
                                    <div class="admin-settings-description">Automatically refresh live employee locations</div>
                                </div>
                                <div class="admin-settings-control">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="auto-refresh-map" checked>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-settings-item">
                                <div>
                                    <div class="admin-settings-label">Data Retention Period</div>
                                    <div class="admin-settings-description">How long to keep attendance records</div>
                                </div>
                                <div class="admin-settings-control">
                                    <select class="form-select form-select-sm" id="data-retention">
                                        <option value="6">6 months</option>
                                        <option value="12" selected>1 year</option>
                                        <option value="24">2 years</option>
                                        <option value="0">Unlimited</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="admin-settings-group">
                            <div class="admin-settings-group-title">Map Settings</div>
                            <div class="admin-settings-item">
                                <div>
                                    <div class="admin-settings-label">Default Map View</div>
                                    <div class="admin-settings-description">Initial view type for maps</div>
                                </div>
                                <div class="admin-settings-control">
                                    <select class="form-select form-select-sm" id="default-map-view">
                                        <option value="roadmap" selected>Roadmap</option>
                                        <option value="satellite">Satellite</option>
                                        <option value="hybrid">Hybrid</option>
                                        <option value="terrain">Terrain</option>
                                    </select>
                                </div>
                            </div>
                            <div class="admin-settings-item">
                                <div>
                                    <div class="admin-settings-label">Show Traffic Layer</div>
                                    <div class="admin-settings-description">Display traffic information on maps</div>
                                </div>
                                <div class="admin-settings-control">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="show-traffic-layer">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible System Status Section -->
            <div class="collapsible-section">
                <div class="collapsible-header">
                    <div class="collapsible-title"><i class="bi bi-hdd-network"></i> System Status</div>
                    <i class="bi bi-chevron-down collapsible-icon"></i>
                </div>
                <div class="collapsible-content">
                    <div class="admin-system-status-container">
                        <div class="admin-system-status-card">
                            <div class="admin-system-status-header">
                                <div class="admin-system-status-title">Database</div>
                                <div class="admin-system-status-indicator online"></div>
                            </div>
                            <div class="admin-system-status-content">
                                Firebase Firestore connection is active and responding normally.
                            </div>
                            <div class="admin-system-status-metrics">
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">98.7%</div>
                                    <div class="admin-system-status-metric-label">Uptime</div>
                                </div>
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">12ms</div>
                                    <div class="admin-system-status-metric-label">Response Time</div>
                                </div>
                            </div>
                        </div>
                        <div class="admin-system-status-card">
                            <div class="admin-system-status-header">
                                <div class="admin-system-status-title">Authentication</div>
                                <div class="admin-system-status-indicator online"></div>
                            </div>
                            <div class="admin-system-status-content">
                                Firebase Authentication service is running normally.
                            </div>
                            <div class="admin-system-status-metrics">
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">24</div>
                                    <div class="admin-system-status-metric-label">Active Users</div>
                                </div>
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">0</div>
                                    <div class="admin-system-status-metric-label">Failed Logins</div>
                                </div>
                            </div>
                        </div>
                        <div class="admin-system-status-card">
                            <div class="admin-system-status-header">
                                <div class="admin-system-status-title">Maps Service</div>
                                <div class="admin-system-status-indicator online"></div>
                            </div>
                            <div class="admin-system-status-content">
                                Google Maps API is responding normally.
                            </div>
                            <div class="admin-system-status-metrics">
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">1,247</div>
                                    <div class="admin-system-status-metric-label">API Calls Today</div>
                                </div>
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">42%</div>
                                    <div class="admin-system-status-metric-label">Quota Used</div>
                                </div>
                            </div>
                        </div>
                        <div class="admin-system-status-card">
                            <div class="admin-system-status-header">
                                <div class="admin-system-status-title">Storage</div>
                                <div class="admin-system-status-indicator warning"></div>
                            </div>
                            <div class="admin-system-status-content">
                                Firebase Storage is running but approaching capacity limits.
                            </div>
                            <div class="admin-system-status-metrics">
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">4.2GB</div>
                                    <div class="admin-system-status-metric-label">Used</div>
                                </div>
                                <div class="admin-system-status-metric">
                                    <div class="admin-system-status-metric-value">5GB</div>
                                    <div class="admin-system-status-metric-label">Total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="section" id="help">
            <div class="section-card">
                <div class="section-title"><i class="bi bi-question-circle"></i> Get Help</div>
                <form id="help-form"><label class="form-label">Describe your issue</label><textarea id="help-message" rows="4" maxlength="700" class="form-control mb-3" placeholder="I am facing issues with..."></textarea><button type="submit" class="btn btn-primary">Send Message</button></form>
                <div class="mt-4"><label class="form-label">Contact Us Directly:</label><br><a href="https://wa.me/9007947130" target="_blank" class="btn btn-success me-2"><i class="bi bi-whatsapp"></i> WhatsApp</a><a href="tel:+919007947130" class="btn btn-info"><i class="bi bi-telephone"></i> Call</a></div>
            </div>
        </div>
    </div>
    <div id="credits-section" class="pb-4">
        <p class="mb-1">Developed by</p>
        <p class="fw-bold mb-0">Mainak Debnath & Arjak Ghosh</p>
    </div>
    <div id="camera-modal">
        <div class="camera-modal-content">
            <div id="video-container">
                <video id="video" autoplay playsinline></video>
            </div>
            <div id="camera-controls" class="d-flex gap-3">
                <button id="snap-btn" class="btn btn-primary"><i class="bi bi-camera-fill"></i> Capture</button>
                <button id="flip-btn" class="btn btn-secondary"><i class="bi bi-arrow-repeat"></i> Flip</button>
                <button id="cancel-btn" class="btn btn-danger"><i class="bi bi-x"></i> Cancel</button>
            </div>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
    </div>
    <div id="search-modal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h3 class="search-modal-title">Search for a Location</h3>
                <button class="search-modal-close">&times;</button>
            </div>
            <div class="mb-3">
                <div class="search-container">
                    <i class="bi bi-search search-icon"></i>
                    <input id="modal-search-input" type="text" class="form-control search-input" placeholder="Type to search for a location..." />
                    <i class="bi bi-x-lg search-clear"></i>
                </div>
            </div>
            <div id="search-results" class="search-results">
                <div class="text-center text-secondary p-4">
                    <i class="bi bi-search fs-1 mb-3"></i>
                    <p>Start typing to search for locations</p>
                </div>
            </div>
        </div>
    </div>
    <button class="fab" id="fab-btn">
        <i class="bi bi-plus-lg"></i>
    </button>
    <button class="toggle-quick-actions" id="toggle-quick-actions">
        <i class="bi bi-three-dots-vertical"></i>
    </button>
    <div class="quick-actions hidden" id="quick-actions">
        <button class="quick-action-btn" id="quick-checkin" title="Quick Check In">
            <i class="bi bi-box-arrow-in-right"></i>
            <span class="quick-action-tooltip">Quick Check In</span>
        </button>
        <button class="quick-action-btn" id="quick-checkout" title="Quick Check Out">
            <i class="bi bi-box-arrow-right"></i>
            <span class="quick-action-tooltip">Quick Check Out</span>
        </button>
        <button class="quick-action-btn" id="quick-search" title="Search Location">
            <i class="bi bi-search"></i>
            <span class="quick-action-tooltip">Search Location</span>
        </button>
    </div>
    <div class="modal fade" id="adminHomeLocationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminHomeLocationModalTitle">User's Home Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="admin-home-map-wrapper" style="height: 450px; border-radius: 12px; overflow: hidden;">
                        <div id="admin-home-map" style="height: 100%; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" async defer></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&loading=async&libraries=places,marker,geometry,routes,drawing,visualization&callback=initMaps"></script>
        <script>
            // Use document ready to ensure all DOM elements are available before binding events
            // script.js

// Use document ready to ensure all DOM elements are available before binding events
 const firebaseConfig = {
    apiKey: "AIzaSyDiuVZqGwUFeN8hoMTd7iLOqMy3Yp8zT9Q",
    authDomain: "engineer-attendance-60374.firebaseapp.com",
    projectId: "engineer-attendance-60374",
    storageBucket: "engineer-attendance-60374.firebasestorage.app",
    messagingSenderId: "575411706871",
    appId: "1:575411706871:web:839ed7b22530d3be93acf2",
    measurementId: "G-SC1JL1B8VC" 
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
db.settings({
    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
});
firebase.firestore().enablePersistence().catch(err => {
    if (err.code == 'failed-precondition') {
        console.warn("Offline persistence not enabled. Multiple tabs open or browser not supported.");
    } else if (err.code == 'unimplemented') {
        console.warn("Offline persistence not supported by this browser.");
    }
});
const allowedAdminEmails = ["mainakdebnath13@gmail.com", "mainakdebnatha@gmail.com", "dipankar.ram@bureauveritas.com","mister.ram2022@gmail.com"];
const BUREAU_VERITAS_KOLKATA = {
    lat: 22.5746,
    lng: 88.4313
};
let userName, userEmail, userUid, isAdmin = false,
    map, siteMarker, userLiveMarker, selectedPlace = null,
    homePlace = null, statsMap, statsMapMarkers = [],
    adminLiveMap, adminLiveMapMarkers = new Map(),
    AdvancedMarkerElement, PinElement, currentSectionId = '#dashboard',
    usingFront = false, globalStream, userLat = null, userLng = null, dayDetailModal, contactModal,
    isAdminSelectMode = false, fullCalendar, adminDetailCalendar, lastVisibleJob = null,
    allUsersCache = [], userActivityChart, monthlyAttendanceChart, adminSummaryListeners = [], adminUserDetailsModal;
const USERS_PER_PAGE = 20;
const JOBS_PER_PAGE = 10;
let lastVisibleUser = null;
let isLoggingOut = false;
let adminLiveLocationListener = null;
let markerClusterer = null;
let currentMarkerClusterer = null; // <-- This is the fix from before
let notificationListener = null;
let adminRouteMap;
let routeDirectionsRenderer;
let locationUpdateInterval = null;
let isCheckinProcessing = false;
let isCheckoutProcessing = false;
let heatmap = null;
let userRoles = ["Engineer", "Senior Engineer", "Project Manager", "Site Supervisor", "Quality Inspector"];
let directionsService = null;
let distanceMatrixService = null;

// Custom Toast Function
function showToast(message, type = 'success') {
    const icon = type === 'success' ? 'check-circle-fill' : type === 'danger' ? 'exclamation-triangle-fill' : 'info-circle-fill';
    const toastHtml = `
    <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"><i class="bi bi-${icon} me-2"></i>${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>`;
    const toastContainer = document.getElementById('global-alert-container');
    if (toastContainer) {
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        toastContainer.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement.querySelector('.toast'));
        toast.show();
    }
}

// Authentication & Initialization
auth.onAuthStateChanged(async (user) => {
    if (isLoggingOut) return;
    const appLoader = document.getElementById('app-loader');
    const loaderText = document.createElement('p');
    loaderText.id = 'loader-text';
    loaderText.textContent = 'Verifying user...';
    appLoader.appendChild(loaderText);

    if (user) {
        userEmail = user.email;
        userUid = user.uid;
        isAdmin = allowedAdminEmails.includes(userEmail);
        loaderText.textContent = 'Fetching profile data...';

        const userProfileRef = db.collection("profiles").doc(user.uid);
        try {
            const doc = await userProfileRef.get();
            if (!doc.exists) {
                userName = user.displayName || user.email.split('@')[0];
                loaderText.textContent = 'Creating new profile...';
                await userProfileRef.set({
                    email: user.email,
                    fullname: userName
                }, {
                    merge: true
                });
            } else {
                userName = doc.data().fullname || user.displayName || user.email.split('@')[0];
            }
        } catch (error) {
            console.error("Error fetching user profile:", error);
            showToast("Failed to load user profile. Please try again.", "danger");
        }

        gsap.fromTo(appLoader, {
            opacity: 1
        }, {
            opacity: 0,
            duration: 0.8,
            delay: 0.5,
            onComplete: () => $(appLoader).hide()
        });

        loaderText.textContent = 'Initializing dashboard...';
        initializeApp();
    } else {
        window.location.href = "index.html";
    }
});

async function initializeApp() {
    $("#user-name").text(`Welcome, ${userName.split(' ')[0]}`);
    $('.admin-only').toggle(isAdmin);
    const initialSection = $(currentSectionId);
    initialSection.addClass('active');

    setupNavListeners();
    initDashboard();
    initProfile();
    initHelp();
    setupNotificationListener();
    if (isAdmin) {
        initAdmin();
    }

    $('#adminRouteModal').on('shown.bs.modal', function() {
        if (adminRouteMap) {
            google.maps.event.trigger(adminRouteMap, 'resize');
        }
    });

    $('#image-viewer').on('click', function() {
        $(this).fadeOut(200);
    });
    dayDetailModal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
    contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
    adminUserDetailsModal = new bootstrap.Modal(document.getElementById('adminUserDetailsModal'));
    
    // Initialize holiday modal
    const adminSetHolidayModal = new bootstrap.Modal(document.getElementById('adminSetHolidayModal'));
    
    // Set up holiday button click handler
    $('#admin-set-holiday-btn').on('click', function() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        $('#admin-holiday-date').val(today);
        adminSetHolidayModal.show();
    });
    
    // Set up holiday form submission
    $('#admin-set-holiday-form').on('submit', handleSetHoliday);
}

//  ADD THIS ENTIRE FUNCTION 
// ... (code for initializeApp() ends here)
    
    // Set up holiday form submission
    


//  ADD THESE 3 FUNCTIONS HERE 

async function handleSetHoliday(e) {
    e.preventDefault();
    const btn = $(e.target).find('button[type="submit"]');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');
    
    const dateString = $('#admin-holiday-date').val();
    const holidayName = $('#admin-holiday-name').val();
    const description = $('#admin-holiday-description').val();
    const notifyUsers = $('#admin-holiday-notify').is(':checked');

    if (!dateString || !holidayName) {
        showToast("Date and Holiday Name are required.", "warning");
        btn.prop('disabled', false).text('Set Holiday');
        return;
    }

    try {
        await Firestore.setHoliday(dateString, holidayName, description);
        showToast("Holiday set successfully!", "success");
        
        if (fullCalendar) fullCalendar.refetchEvents();
        if (adminDetailCalendar) adminDetailCalendar.refetchEvents();
        
        renderAdminHolidays(); // This refreshes the holiday list in the admin panel

        // This is the new notification logic
        if (notifyUsers) {
            console.log("Sending notifications to all users...");
            const allUsers = await Firestore.getAllUsers();
            
            const notificationPromises = allUsers.map(user => {
                // Use the new function from the Firestore object
                return Firestore.createNotification(
                    user.uid,
                    "New Holiday Announced",
                    `A holiday is set for ${dateString}: ${holidayName}`
                );
            });
            
            await Promise.all(notificationPromises);
            showToast(`Notifications sent to ${allUsers.length} users.`, 'info');
        }

    } catch (err) {
        console.error("Error setting holiday:", err);
        showToast("Failed to set holiday.", "danger");
    } finally {
        btn.prop('disabled', false).text('Set Holiday');
        const adminSetHolidayModal = bootstrap.Modal.getInstance(document.getElementById('adminSetHolidayModal'));
        if (adminSetHolidayModal) {
            adminSetHolidayModal.hide();
        }
        $('#admin-set-holiday-form')[0].reset();
    }
}

async function renderAdminHolidays() {
    const holidaysListContainer = $('#admin-holidays-list');
    holidaysListContainer.html(getSpinnerHTML()); // Show a spinner
    
    try {
        const holidays = await Firestore.getHolidays();
        
        if (holidays.length === 0) {
            holidaysListContainer.html(`
                <div class="empty-state">
                    <i class="bi bi-calendar-x empty-state-icon"></i>
                    <h5>No holidays set yet</h5>
                    <p>Holidays will appear here once they are set</p>
                </div>
            `);
            return;
        }
        
        holidaysListContainer.empty(); // Clear spinner/empty state
        
        holidays.sort((a, b) => a.id.localeCompare(b.id)); // Sort by date
        
        holidays.forEach(holiday => {
            const date = new Date(holiday.id + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const holidayItem = $(`
                <div class="admin-role-item" data-holiday-id="${holiday.id}">
                    <div>
                        <div class="admin-role-name">${escape(holiday.name)}</div>
                        <div class="card-date small">${formattedDate}</div>
                    </div>
                    <div class="admin-role-actions">
                        <button class="admin-role-action-btn" title="Delete Holiday">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `);
            
            holidayItem.find('button[title="Delete Holiday"]').on('click', async function() {
                if (confirm(`Are you sure you want to delete the holiday "${holiday.name}" on ${formattedDate}?`)) {
                    await Firestore.deleteHoliday(holiday.id);
                    showToast('Holiday deleted.', 'success');
                    renderAdminHolidays(); // Re-render this list
                    if (fullCalendar) fullCalendar.refetchEvents();
                    if (adminDetailCalendar) adminDetailCalendar.refetchEvents();
                }
            });
            
            holidaysListContainer.append(holidayItem);
        });

    } catch (err) {
        console.error("Error rendering holidays:", err);
        holidaysListContainer.html('<p class="text-danger text-center">Failed to load holidays.</p>');
    }
}

function timeSince(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
}

//  END OF NEW FUNCTIONS 

function setupNotificationListener() {
    if (notificationListener) notificationListener(); // Stop any old listener

    // Start a new listener using the Firestore object function
    notificationListener = Firestore.getNotifications(userUid, (snapshot) => {
        const notifications = [];
        snapshot.forEach(doc => {
            notifications.push({ id: doc.id, ...doc.data() });
        });
        // Pass the new data to our render function
        renderNotifications(notifications);
    });
}

function renderNotifications(notifications) {
    const dropdown = $('.notification-dropdown');
    const header = dropdown.find('.notification-header'); // Keep the header
    const badge = $('.notification-badge');
    
    // Clear only the notification items, not the header
    dropdown.find('.notification-item').remove(); 
    
    const unreadNotifications = notifications.filter(n => !n.isRead);
    
    // Update badge count
    if (unreadNotifications.length > 0) {
        badge.text(unreadNotifications.length).show();
    } else {
        badge.hide();
    }

    if (notifications.length === 0) {
        // Add a "no notifications" message
        header.after('<div class="notification-item"><div class="notification-text text-center text-secondary">No notifications</div></div>');
        return;
    }

    // Add each notification to the dropdown
    notifications.forEach(notif => {
        const timeAgo = notif.timestamp ? timeSince(notif.timestamp.toDate()) : 'just now';
        
        // Add styling for unread items
        const unreadClass = !notif.isRead ? 'fw-bold' : ''; 
        const unreadDot = !notif.isRead ? '<span class="status-dot completed me-2"></span>' : '<span class="status-dot" style="background:transparent; me-2"></span>';

        const itemHtml = `
            <div class="notification-item ${unreadClass}" data-id="${notif.id}">
                <div class="d-flex align-items-center mb-1">
                    ${unreadDot}
                    <div class="notification-title">${escape(notif.title)}</div>
                </div>
                <div class="notification-text ps-4">${escape(notif.text)}</div>
                <div class="notification-time ps-4">${timeAgo}</div>
            </div>
        `;
        // .after() inserts new items *below* the header, so they appear in order
        header.after(itemHtml);
    });

    // Re-attach the "Mark all as read" button's click listener
    const markReadBtn = header.find('button');
    markReadBtn.off('click').on('click', async () => {
        const unreadIds = unreadNotifications.map(n => n.id);
        if (unreadIds.length > 0) {
            try {
                // Use the new function from the Firestore object
                await Firestore.markAllNotificationsRead(userUid, unreadIds);
                showToast('Notifications marked as read.', 'success');
            } catch (err) {
                showToast('Could not mark notifications as read.', 'danger');
            }
        }
    });
    
    // Toggle the notification dropdown
    // Note: You need to add a click listener for the bell icon itself
    $('.notification-bell').off('click').on('click', function(e) {
        e.stopPropagation();
        $('.notification-dropdown').toggleClass('show');
    });
    
    // Close dropdown if clicking outside
    $(document).on('click', function(e) {
        if (!$('.notification-bell').is(e.target) && $('.notification-bell').has(e.target).length === 0) {
            $('.notification-dropdown').removeClass('show');
        }
    });
}


function setupNavListeners() {
    $('.nav-link').click(function(e) {
        e.preventDefault();
        const targetSectionId = '#' + $(this).data('sec');
        if (targetSectionId === currentSectionId) return;

        if (currentSectionId === '#admin') {
            if (adminLiveLocationListener) {
                adminLiveLocationListener();
                adminLiveLocationListener = null;
            }
            adminSummaryListeners.forEach(unsubscribe => unsubscribe());
            adminSummaryListeners = [];
        }

        if (locationUpdateInterval) {
            clearInterval(locationUpdateInterval);
            locationUpdateInterval = null;
        }

        const oldSection = $(currentSectionId);
        const newSection = $(targetSectionId);

        gsap.to(oldSection, {
            opacity: 0,
            y: -15,
            duration: 0.2,
            onComplete: () => {
                oldSection.removeClass('active').hide();
                newSection.addClass('active').show();

                gsap.fromTo(newSection, {
                    opacity: 0,
                    y: 15
                }, {
                    opacity: 1,
                    y: 0,
                    duration: 0.4,
                    onComplete: () => {
                        ['map', 'statsMap', 'adminLiveMap', 'adminRouteMap'].forEach(mapId => {
                            const mapInstance = window[mapId];
                            if (mapInstance && $(`#${mapId}`).is(':visible')) {
                                google.maps.event.trigger(mapInstance, 'resize');
                            }
                        });
                        if (fullCalendar) fullCalendar.render();
                        if (adminDetailCalendar) adminDetailCalendar.render();
                        if (userActivityChart && $(userActivityChart.canvas).is(':visible')) userActivityChart.resize();
                        
                        // Initialize admin analytics charts when admin section is shown
                        if (targetSectionId === '#admin' && isAdmin) {
                            initializeAdminAnalyticsCharts();
                        }
                    }
                });
            }
        });

        if (targetSectionId === '#admin') {
            if (isAdmin) {
                renderAdminLiveMap();
                renderAdminSummaryStats();
                renderTopPerformingUsers();
                renderAdminHolidays(); // Load holidays when admin section is shown
            }
        }
        if (targetSectionId === '#statistics') {
            renderStatistics();
        }

        currentSectionId = targetSectionId;
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
    });

    $("#logout-btn").click(() => {
        isLoggingOut = true;
        if (adminLiveLocationListener) adminLiveLocationListener();
        adminSummaryListeners.forEach(unsubscribe => unsubscribe());
        if (locationUpdateInterval) clearInterval(locationUpdateInterval);
        auth.signOut().then(() => {
            window.location.href = "index.html";
        });
    });

    $('button, .nav-link, .admin-user-row, .issue-card, .travel-card, .attendance-card').on('click', function() {
        // Visual feedback for clicks
        const el = $(this);
        el.addClass('active');
        setTimeout(() => el.removeClass('active'), 200);
    });
}

const Firestore = {
    getProfile: (uid) => db.collection("profiles").doc(uid).get().then(doc => doc.exists ? {
        uid: doc.id,
        ...doc.data()
    } : {}),
    setProfile: (data, uid = userUid) => db.collection("profiles").doc(uid).set(data, {
        merge: true
    }),
    getJobs: (uid) => db.collection("attendance").doc(uid).collection("entries").orderBy("entryTime", "desc").get().then(snap => snap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }))),
    getUsersPaginated: async (startAfter = null) => {
        let query = db.collection("profiles").orderBy("fullname", "asc");
        if (startAfter) query = query.startAfter(startAfter);
        const snapshot = await query.limit(USERS_PER_PAGE).get();
        const users = snapshot.docs.map(doc => ({
            uid: doc.id,
            ...doc.data()
        }));
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        return {
            users,
            lastVisible
        };
    },
    getDailyStatuses: (uid) => db.collection("daily_status").doc(uid).collection("entries").get().then(snap => snap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }))),
    addJob: (job, uid = userUid) => db.collection("attendance").doc(uid).collection("entries").add(job),
    updateJob: (jobId, data, uid = userUid) => db.collection("attendance").doc(uid).collection("entries").doc(jobId).update(data),
    deleteJob: (jobId, uid = userUid) => db.collection("attendance").doc(uid).collection("entries").doc(jobId).delete(),
    addIssue: (issue) => db.collection("issues").add(issue),
    getIssues: () => db.collection("issues").orderBy("timestamp", "desc").get().then(snap => snap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }))),
    updateLiveLocation: (locationData, uid = userUid) => {
        const filteredData = Object.fromEntries(
            Object.entries(locationData).filter(([_, value]) => value !== undefined)
        );
        return db.collection("live_locations").doc(uid).set(filteredData, {
            merge: true
        });
    },
    updateLiveLocationHistory: (locationData, uid = userUid) => db.collection("live_locations_history").doc(uid).collection('locations').add(locationData),
    setDailyStatus: (dateString, status, uid = userUid) => db.collection("daily_status").doc(uid).collection("entries").doc(dateString).set({
        status
    }),
    deleteDailyStatus: (dateString, uid = userUid) => db.collection("daily_status").doc(uid).collection("entries").doc(dateString).delete(),
    getJobsPaginated: async (uid, startAfter = null) => {
        let query = db.collection("attendance").doc(uid).collection("entries").orderBy("entryTime", "desc");
        if (startAfter) query = query.startAfter(startAfter);
        const snapshot = await query.limit(JOBS_PER_PAGE).get();
        const jobs = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        const lastVisible = snapshot.docs[snapshot.docs.length - 1];
        return {
            jobs,
            lastVisible
        };
    },
    // Holiday management functions
    setHoliday: (dateString, name, description) => db.collection("global_events").doc(dateString).set({
        type: 'holiday',
        name: name,
        description: description || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }),
    getHolidays: () => db.collection("global_events").where("type", "==", "holiday").get().then(snap => snap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
    }))),
    deleteHoliday: (dateString) => db.collection("global_events").doc(dateString).delete(),
    // Function to get all users for notifications
    getAllUsers: () => db.collection("profiles").get().then(snap => snap.docs.map(doc => ({
        uid: doc.id,
        ...doc.data()
    }))),
    createNotification: (targetUid, title, text) => {
        return db.collection("profiles").doc(targetUid).collection("notifications").add({
            title: title,
            text: text,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            isRead: false,
            link: '#'
        });
    },
    
    getNotifications: (uid, callback) => {
        return db.collection("profiles").doc(uid).collection("notifications")
            .orderBy("timestamp", "desc")
            .limit(20)
            .onSnapshot(callback);
    },

    markAllNotificationsRead: (uid, notificationIds) => {
        const batch = db.batch();
        notificationIds.forEach(id => {
            const docRef = db.collection("profiles").doc(uid).collection("notifications").doc(id);
            batch.update(docRef, { isRead: true });
        });
        return batch.commit();
    }
};

// CORE APP FUNCTIONS
async function initDashboard() {
    renderDashboardSummary();
    $('#checkin-btn').click(handleCheckIn);
    $('#checkout-btn').click(handleCheckout);
    $("#filter-select, #start-date, #end-date").change(handleFilterChange);
    $('#load-more-btn').click(loadMoreJobs);
    handleFilterChange();
    initializeFullCalendar();
}

async function renderDashboardSummary() {
    const container = $("#dashboard-stats-container");
    container.html(getSpinnerHTML());
    try {
        const jobs = await Firestore.getJobs(userUid);

        if (jobs.length === 0) {
            container.html(`
                <div id="no-data-stats" class="empty-state animated-card">
                    <i class="bi bi-bar-chart-fill empty-state-icon"></i>
                    <h5>No Data to Display Yet</h5>
                    <p>Start by marking a site visit!</p>
                </div>
            `);
            return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const last30 = new Date();
        last30.setDate(today.getDate() - 29);
        let todayCount = 0,
            last30Count = 0;
        jobs.forEach(j => {
            if (!j.entryTime) return;
            const d = new Date(j.entryTime);
            d.setHours(0, 0, 0, 0);
            if (d.getTime() === today.getTime()) todayCount++;
            if (d >= last30) last30Count++;
        });
        
        // Add additional stats for better dashboard summary
        const completedJobs = jobs.filter(j => j.status === 'completed');
        const pendingJobs = jobs.filter(j => j.status === 'pending-exit');
        
        const statsHtml = `
            <div class="dashboard-stats-compact">
                <div class="stat-box-compact">
                    <h4>${todayCount}</h4>
                    <p>Today's Visits</p>
                </div>
                <div class="stat-box-compact">
                    <h4>${last30Count}</h4>
                    <p>Last 30 Days</p>
                </div>
                <div class="stat-box-compact">
                    <h4>${jobs.length}</h4>
                    <p>Total Records</p>
                </div>
                <div class="stat-box-compact">
                    <h4>${pendingJobs.length}</h4>
                    <p>Pending</p>
                </div>
            </div>
        `;
        container.html(statsHtml);
        
        // Apply animation class to stat boxes
        applyAnimatedCardClass();
    } catch (err) {
        console.error("Could not load dashboard stats.", err);
        container.html('<p class="text-danger text-center">Failed to load summary stats.</p>');
    }
}

async function renderStatistics() {
    const statsHolder = $("#statistics-holder");
    statsHolder.html(getSpinnerHTML());
    try {
        const jobs = await Firestore.getJobs(userUid);
        if (jobs.length === 0) {
            statsHolder.html(`
                <div id="no-data-summary" class="empty-state">
                    <i class="bi bi-bar-chart-line-fill empty-state-icon"></i>
                    <h5>No Data to Display Yet</h5>
                    <p>Start by marking a site visit!</p>
                </div>
            `);
            initAndRenderStatsTravel();
            return;
        }
        const last7 = new Date();
        last7.setDate(new Date().getDate() - 6);
        const last30 = new Date();
        last30.setDate(new Date().getDate() - 29);
        let last7Count = 0,
            last30Count = 0;
        jobs.forEach(j => {
            if (!j.entryTime) return;
            const d = new Date(j.entryTime);
            if (d >= last7) last7Count++;
            if (d >= last30) last30Count++;
        });
        
        // Add more detailed statistics
        const completedJobs = jobs.filter(j => j.status === 'completed');
        const pendingJobs = jobs.filter(j => j.status === 'pending-exit');
        const profile = await Firestore.getProfile(userUid);
        const homeCoords = profile.homeLocation?.coords;
        let totalDistance = 0;
        const validJobs = jobs.filter(j => j.coords && j.entryTime);
        
        if (validJobs.length > 0 && homeCoords) {
            validJobs.forEach(job => {
                totalDistance += (getDistanceKm(homeCoords, job.coords) * 2);
            });
        }
        
        statsHolder.html(`
            <div class="row text-center g-3 g-md-4">
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${last7Count}</h4>
                        <p>Last 7 Days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${last30Count}</h4>
                        <p>Last 30 Days</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${jobs.length}</h4>
                        <p>Total Records</p>
                    </div>
                </div>
            </div>
            <div class="row text-center g-3 g-md-4 mt-2">
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${completedJobs.length}</h4>
                        <p>Completed</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${pendingJobs.length}</h4>
                        <p>Pending</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-box">
                        <h4>${totalDistance.toFixed(1)} km</h4>
                        <p>Total Distance</p>
                    </div>
                </div>
            </div>
        `);
        initAndRenderStatsTravel();
        
        // Calculate and update rates
        updateStatisticsRates(jobs);
    } catch (err) {
        console.error("Could not load statistics.", "error");
        statsHolder.html('<p class="text-danger text-center">Failed to load data.</p>');
    }
    renderUserActivityChart();
}

// Function to calculate and update attendance and completion rates
async function updateStatisticsRates(jobs) {
    try {
        // Calculate completion rate
        const completedJobs = jobs.filter(j => j.status === 'completed').length;
        const totalJobs = jobs.length;
        const completionRate = totalJobs > 0 ? Math.round((completedJobs / totalJobs) * 100) : 0;
        
        // Calculate attendance rate (days with activity / total working days)
        const dailyStatuses = await Firestore.getDailyStatuses(userUid);
        const uniqueDays = new Set();
        
        // Add days with site visits
        jobs.forEach(job => {
            if (job.entryTime) {
                const date = new Date(job.entryTime).toISOString().split('T')[0];
                uniqueDays.add(date);
            }
        });
        
        // Add days with office/leave status
        dailyStatuses.forEach(status => {
            uniqueDays.add(status.id);
        });
        
        // Estimate working days (weekdays in last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        let workingDays = 0;
        const date = new Date(thirtyDaysAgo);
        
        while (date <= today) {
            const day = date.getDay();
            if (day !== 0 && day !== 6) { // Not Sunday (0) or Saturday (6)
                workingDays++;
            }
            date.setDate(date.getDate() + 1);
        }
        
        const attendanceRate = workingDays > 0 ? Math.round((uniqueDays.size / workingDays) * 100) : 0;
        
        // Update UI
        $('#attendance-rate').text(`${attendanceRate}%`);
        $('#attendance-progress').css('width', `${attendanceRate}%`);
        
        $('#completion-rate').text(`${completionRate}%`);
        $('#completion-progress').css('width', `${completionRate}%`);
        
    } catch (err) {
        console.error("Error calculating statistics rates:", err);
    }
}

async function initAndRenderStatsTravel() {
    if (!statsMap) {
        try {
            const {
                Map
            } = await google.maps.importLibrary("maps");
            statsMap = new Map(document.getElementById('stats-map'), {
                center: {
                    lat: 20.5937,
                    lng: 78.9629
                },
                zoom: 5,
                mapId: 'STATS_MAP',
                backgroundColor: '#0b0c10',
                gestureHandling: "greedy",
                streetViewControl: false,
                mapTypeControl: false,
                disableDefaultUI: true
            });
        } catch (e) {
            $("#stats-map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');
            return;
        }
    }
    const filterAndRender = () => {
        renderTravelStats('stats');
        renderUserActivityChart();
    };
    $("#stats-travel-filter-select, #stats-travel-start-date, #stats-travel-end-date").off('change').on('change', filterAndRender);
    await renderTravelStats('stats');
}

async function initProfile() {
    try {
        const [p, rolesDoc] = await Promise.all([
            Firestore.getProfile(userUid),
            db.collection("settings").doc("roles").get()
        ]);

        if (rolesDoc.exists) {
            userRoles = rolesDoc.data().roles || userRoles;
        }

        const displayName = p.fullname || userName;
        $("#profile-name-display").text(displayName);
        $("#profile-email-display").text(userEmail);
        
        $("#prof-email").val(userEmail);
        $("#prof-username").val(p.username || userEmail.split('@')[0]);
        $("#prof-fullname").val(displayName);
        $("#prof-contact").val(p.contact || "");

        const roleSelect = $("#prof-role");
        roleSelect.empty();
        userRoles.forEach(role => {
            roleSelect.append(new Option(role, role));
        });

        const userRole = p.role || "Engineer";
        roleSelect.val(userRole);
        $("#profile-role-display").text(userRole);

        // Use the new helper function for the main profile avatar
        $('#profile-avatar').html(getAvatarHtml(p));
        
        $("#profile-form").off('submit').submit(handleProfileSave);
        $("#home-address-input").val(p.homeLocation ? p.homeLocation.address || p.homeLocation.name : '');
        $("#home-address-form").off('submit').submit(handleHomeAddressSave);
    } catch (err) {
        console.error("Could not load your profile data.", err);
        showToast("Error loading profile.", "danger");
    }
}

async function initAdmin() {
    $('#admin-users-list').html(getSpinnerHTML());
    $('#admin-issues-holder').html(getSpinnerHTML());
    $('#admin-live-map-status').html('<div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading live map...');
    try {
        const {
            users
        } = await loadAdminUsers();
        allUsersCache = users;
        renderAdminUserList(allUsersCache);

        const issues = await Firestore.getIssues();
        renderAdminIssues(issues);

        isAdminSelectMode = false;
        toggleAdminSelectMode(true);

        $('#admin-user-search').off('input').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            const filteredUsers = allUsersCache.filter(user =>
                (user.fullname && user.fullname.toLowerCase().includes(searchTerm)) ||
                (user.email && user.email.toLowerCase().includes(searchTerm))
            );
            renderAdminUserList(filteredUsers);
        });

        $('#admin-users-list').on('click', '.admin-user-row', handleAdminUserRowClick);
        $('#admin-toggle-select-mode').off('click').on('click', () => toggleAdminSelectMode());
        $('#admin-select-all-users').off('change').on('change', function() {
            $('#admin-users-list .admin-user-checkbox').prop('checked', this.checked).trigger('change');
        });
        $('#admin-export-selected').off('click').on('click', handleMultiExport);
        $('#admin-delete-selected').off('click').on('click', handleMultiDelete);
        $('#admin-filter-select').off('change.admindatepicker').on('change.admindatepicker', function() {
            $("#admin-start-date, #admin-end-date").toggle($(this).val() === 'custom');
        });

        await initAdminLiveMap();
        renderAdminLiveMap();
        renderAdminSummaryStats();
        renderTopPerformingUsers();
        renderAdminRolesList();
        renderAdminHolidays(); // Load holidays when admin section is initialized
    } catch (err) {
        console.error("Failed to load admin dashboard data.", err);
        $("#admin-users-list").html('<p class="text-danger">Failed to load users.</p>');
        $("#admin-issues-holder").html('<p class="text-danger">Failed to load issues.</p>');
        $("#admin-live-map-wrapper").html('<p class="text-danger">Map could not be loaded.</p>');
    }
}

async function loadAdminUsers() {
    const userListContainer = $('#admin-users-list');
    userListContainer.html('<p class="text-center text-secondary p-5">Loading users for the first time. This may take a moment...</p>');

    try {
        const {
            users,
            lastVisible
        } = await Firestore.getUsersPaginated();
        allUsersCache = users;
        lastVisibleUser = lastVisible;
        renderAdminUserList(users);
        return {
            users,
            lastVisible
        };
    } catch (err) {
        console.error("Failed to load initial user list.", err);
        userListContainer.html('<p class="text-danger text-center">Failed to load users.</p>');
        return {
            users: [],
            lastVisible: null
        };
    }
}

function renderAdminUserList(users) {
    const userList = $("#admin-users-list").empty();
    if (users.length === 0) {
        userList.html("<p class='text-secondary text-center p-3'>No users found.</p>");
        return;
    }
    users.forEach(user => {
        const displayName = escape(user.fullname || user.email || 'Unnamed User');
        const displayEmail = escape(user.email || 'No Email');
        const userRole = user.role || "Engineer";
        
        // Use the new helper function for the user list avatar
        const avatar = getAvatarHtml(user);

        const userRow = $(`<div class="admin-user-row" data-uid="${user.uid}" data-name="${displayName}" data-email="${displayEmail}">
            <input type="checkbox" class="form-check-input admin-user-checkbox">
            <div class="flex-grow-1 d-flex align-items-center">
                <div class="avatar">
                    ${avatar}
                </div>
                <div class="ms-3">
                    <div>${displayName}</div>
                    <div class="email">${displayEmail}</div>
                    <div class="badge-custom badge-info">${userRole}</div>
                </div>
            </div>
            <button class="set-status-btn btn btn-sm" data-uid="${user.uid}" data-name="${displayName}">
                <i class="bi bi-calendar-check"></i> Set Status
            </button>
        </div>`);
        userList.append(userRow);
    });
}

async function renderAdminIssues(issues) {
    const issuesHolder = $("#admin-issues-holder").empty();
    if (issues.length === 0) {
        issuesHolder.html("<p class='text-secondary text-center p-5'>No issues reported.</p>");
        return;
    }
    const issuePromises = issues.map(async issue => {
        const userProfile = await Firestore.getProfile(issue.userUid);
        const userContact = userProfile?.contact || null;

        // Use the new helper function for the issue card avatar
        const avatar = getAvatarHtml(userProfile);

        const issueCard = $(`<div class="issue-card" id="issue-${issue.id}">
            <div class="issue-card-header">
                <div class="d-flex align-items-center">
                    <div class="avatar">
                        ${avatar}
                    </div>
                    <div class="ms-3">
                        <strong class="card-place">${escape(issue.userName)}</strong>
                        <div class="card-date small">${escape(issue.userEmail)}</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-info" onclick="showContactModal('${issue.userEmail}', '${userContact}')" title="Contact">
                        <i class="bi bi-chat-dots"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAdminIssue('${issue.id}')" title="Delete Issue">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <hr style="border-color: var(--card-border);">
            <p class="m-0" style="white-space: pre-wrap;">${escape(issue.message)}</p>
        </div>`);
        issuesHolder.append(issueCard);
    });
    await Promise.all(issuePromises);
}

async function initAdminLiveMap() {
    if (!adminLiveMap) {
        try {
            const {
                Map
            } = await google.maps.importLibrary("maps");
            adminLiveMap = new Map(document.getElementById('admin-live-map'), {
                center: BUREAU_VERITAS_KOLKATA,
                zoom: 12,
                mapId: 'ADMIN_LIVE_MAP',
                backgroundColor: '#0b0c10',
                gestureHandling: "greedy",
                streetViewControl: false,
                mapTypeControl: false,
                disableDefaultUI: true
            });
        } catch (e) {
            $("#admin-live-map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');
        }
    }
}

async function renderAdminLiveMap() {
    if (!adminLiveMap || !isAdmin) return;

    const officeMarkerContent = document.createElement('div');
    officeMarkerContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="${getComputedStyle(document.documentElement).getPropertyValue('--warning').trim()}" stroke="#fff" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`;
    new AdvancedMarkerElement({
        position: BUREAU_VERITAS_KOLKATA,
        map: adminLiveMap,
        title: 'Bureau Veritas (Kolkata)',
        content: officeMarkerContent
    });

    const statusEl = $('#admin-live-map-status');
    statusEl.html('<div class="spinner-border spinner-border-sm me-2" role="status"></div>Connecting to live feed...');

    const liveLocationsRef = db.collection("live_locations");

    if (adminLiveLocationListener) {
        adminLiveLocationListener();
    }

    adminLiveLocationListener = liveLocationsRef.onSnapshot(async querySnapshot => {
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        let activeUsersCount = 0;

        adminLiveMapMarkers.forEach(marker => marker.map = null);
        adminLiveMapMarkers.clear();

        const currentMarkers = [];
        for (const doc of querySnapshot.docs) {
            const uid = doc.id;
            const data = doc.data();
            if (!data.coords || !data.timestamp || !data.fullname) continue;

            const isStale = data.timestamp < fiveMinutesAgo;
            if (!isStale) {
                activeUsersCount++;
            }

            const userName = data.fullname || "Unknown User";
            const title = `${userName}\nLast Update: ${new Date(data.timestamp).toLocaleString()}`;

            const markerContent = document.createElement('div');
            markerContent.className = 'map-marker';
            const color = isStale ? '#6c757d' : getComputedStyle(document.documentElement).getPropertyValue('--glow-color-1').trim();
            markerContent.innerHTML = `
                <svg width="32" height="32" viewBox="0 0 24 24" fill="${color}" stroke="#FFF" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="position: relative; z-index: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4)); opacity: ${isStale ? 0.5 : 1};">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
                </svg>
                ${!isStale ? '<div class="pulse" style="width: 24px; height: 24px;"></div>' : ''}
            `;

            const marker = new AdvancedMarkerElement({
                map: adminLiveMap,
                position: data.coords,
                title,
                content: markerContent,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="color: #000; font-family: 'Poppins', sans-serif;">
                        <strong>${userName}</strong><br>
                        <small>${data.email}</small><br>
                        <small>Updated: ${new Date(data.timestamp).toLocaleTimeString()}</small>
                    </div>
                `,
            });

            marker.addListener('click', () => {
                infoWindow.open({
                    anchor: marker,
                    map: adminLiveMap,
                });
            });

            adminLiveMapMarkers.set(uid, marker);
            currentMarkers.push(marker);
        }

        if (markerClusterer) markerClusterer.clearMarkers();
        if (window.markerClusterer) {
            markerClusterer = new markerClusterer.MarkerClusterer({ map: adminLiveMap, markers: currentMarkers });
        } else {
            console.error("MarkerClusterer library not loaded.");
        }

        statusEl.html(`Live feed connected. <strong>${activeUsersCount}</strong> active user(s). Last update: ${new Date().toLocaleTimeString()}`);
    }, err => {
        console.error("Error with live location listener: ", err);
        statusEl.text('Live feed disconnected. Check console for errors.');
        showToast("Error connecting to live location feed.", "danger");
    });
}

async function deleteAdminIssue(issueId) {
    if (!confirm("Are you sure you want to delete this issue?")) return;
    try {
        const issueElement = $("#issue-" + issueId);
        await db.collection("issues").doc(issueId).delete();
        showToast("Issue deleted successfully.", "success");
        gsap.to(issueElement, {
            opacity: 0,
            height: 0,
            margin: 0,
            padding: 0,
            duration: 0.3,
            onComplete: () => issueElement.remove()
        });
    } catch (err) {
        console.error("Failed to delete issue.", "error");
        showToast("Failed to delete issue.", "danger");
    }
}

function initHelp() {
    $("#help-form").off('submit').submit(handleHelpRequest);
}

function getSpinnerHTML() {
    return `<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
}

async function setupAdminView(uid, profile) {
    // 1. Update User Info in Modal Header
    $('#admin-modal-title').text(profile.fullname || profile.email);
    $('#admin-modal-email').text(profile.email || 'N/A');
    $('#admin-modal-fullname').text(profile.fullname || 'N/A');
    $('#admin-modal-contact').text(profile.contact || 'Not Provided');
    $('#admin-modal-role').text(profile.role || 'Not Provided');
    
    // Store UID in modal title for later use
    $('#admin-modal-title').data('uid', uid);

    $('#admin-modal-export-btn').off('click').on('click', () => handleSingleUserExport(uid, profile.fullname));

    // 2. Load the record data for the default active tab
    await loadAndRenderAdminUserData(uid, profile, true);
}

async function loadAndRenderAdminUserData(uid, profile, isModal = false) {
    const allJobs = await Firestore.getJobs(uid);
    const filteredJobs = filterJobs(allJobs, $('#admin-filter-select').val(), 'admin');
    if (isModal) {
        renderAdminSummary(filteredJobs, profile, 'admin-modal-summary-stats');
        renderAdminDetails(filteredJobs, profile, uid, 'admin-modal-records-list');
    } else {
        renderAdminSummary(filteredJobs, profile, 'admin-summary-stats');
        renderAdminDetails(filteredJobs, profile, uid, 'admin-records-list');
    }
}

function renderAdminSummary(jobs, profile, targetId) {
    const summaryContainer = $(`#${targetId}`).empty();
    const homeCoords = profile.homeLocation?.coords;
    let totalDistance = 0;
    const validJobs = jobs.filter(j => j.coords && j.entryTime);
    if (validJobs.length > 0 && homeCoords) {
        validJobs.forEach(job => {
            totalDistance += (getDistanceKm(homeCoords, job.coords) * 2);
        });
        summaryContainer.html(`<div class="row text-center g-3 g-md-4"><div class="col-6"><div class="stat-box"><h4>${jobs.length}</h4><p>Total Records</p></div></div><div class="col-6"><div class="stat-box"><h4>${totalDistance.toFixed(1)} <small>km</small></h4><p>Total Distance</p></div></div></div>`);
    } else {
        summaryContainer.html(`<div class="row text-center g-3 g-md-4"><div class="col-6"><div class="stat-box"><h4>${jobs.length}</h4><p>Total Records</p></div></div><div class="col-6"><div class="stat-box"><h4>N/A</h4><p>Total Distance</p></div></div></div>`);
    }
}

function renderAdminDetails(jobs, profile, uid, targetId) {
    const container = $(`#${targetId}`).empty();
    if (!jobs || jobs.length === 0) {
        container.html("<p class='text-secondary mt-3 text-center'>No records found for this user for the selected period.</p>");
        return;
    }
    const homeCoords = profile.homeLocation?.coords;
    jobs.forEach(job => {
        const duration = job.exitTime ? calculateDuration(job.entryTime, job.exitTime) : 'Ongoing';
        let distanceText = `<span class="text-secondary fst-italic">No travel data</span>`;
        if (homeCoords && job.coords) {
            const roundTrip = getDistanceKm(homeCoords, job.coords) * 2;
            distanceText = `<i class="bi bi-geo-alt"></i> ${roundTrip.toFixed(1)} km`;
        } else if (!homeCoords) {
            distanceText = `<i class="bi bi-geo-alt"></i> <span class="text-secondary fst-italic" title="Set a home address in the user's profile to calculate distance.">No home set</span>`;
        }

        const entryTimeFormatted = job.entryTime ? formatDate(new Date(job.entryTime)) : 'N/A';
        const exitTimeFormatted = job.exitTime ? formatDate(new Date(job.exitTime)) : 'N/A';

        const card = $(`<div class="attendance-card" id="admin-job-${job.id}"><div class="card-summary d-flex align-items-center" style="cursor: pointer;"><span class="status-dot ${job.status==='completed'?'completed':'pending'} me-3"></span><div class="flex-grow-1"><div class="card-place">${escape(job.place)}</div><div class="card-date small d-flex justify-content-between align-items-center"><span>${new Date(job.entryTime).toLocaleDateString()}</span><span class="text-info fw-bold">${distanceText}</span></div></div><i class="bi bi-chevron-down ms-3"></i></div><div class="record-details admin-record-details" style="display:none;"><div class="row g-3"><div class="col-12 col-sm-6 text-center record-photo-container"><a class="view-photo-btn" data-img-src="${job.entryPhoto}"><img src="${job.entryPhoto}" loading="lazy" class="rounded w-100"></a><div class="small mt-1 text-secondary">Entry Photo</div></div>${job.exitPhoto?`<div class="col-12 col-sm-6 text-center record-photo-container"><a class="view-photo-btn" data-img-src="${job.exitPhoto}"><img src="${job.exitPhoto}" loading="lazy" class="rounded w-100"></a><div class="small mt-1 text-secondary">Exit Photo</div></div>`:''}<div class="col-12 record-info-container"><p class="small mb-1"><span class="info-label">Duration:</span> <strong>${duration}</strong></p><p class="small mb-1"><span class="info-label">Entry Time:</span> <strong>${entryTimeFormatted}</strong></p>${job.exitTime?`<p class="small mb-0"><span class="info-label">Exit Time:</span> <strong>${exitTimeFormatted}</strong></p>`:''}</div></div><div class="text-end mt-3"><button class="btn btn-outline-primary btn-sm me-2" onclick="showAdminHomeLocationModal('${uid}')"><i class="bi bi-house-door-fill me-2"></i>View Home</button><button class="btn btn-outline-danger btn-sm admin-delete-btn" data-jobid="${job.id}"><i class="bi bi-trash"></i> Delete Record</button></div></div></div>`);
        card.find('.card-summary').click(function() {
            $(this).next('.record-details').slideToggle(300);
            $(this).find('i').toggleClass('bi-chevron-down bi-chevron-up');
        });
        card.find('.admin-delete-btn').click(async function() {
            const jobId = $(this).data('jobid');
            if (confirm("Are you sure you want to permanently delete this record? This cannot be undone.")) {
                try {
                    const cardElement = $(`#admin-job-${jobId}`);
                    await Firestore.deleteJob(jobId, uid);
                    gsap.to(cardElement, {
                        opacity: 0,
                        height: 0,
                        margin: 0,
                        padding: 0,
                        duration: 0.5,
                        onComplete: () => cardElement.remove()
                    });
                    showToast('Record deleted successfully.', 'success');
                } catch (err) {
                    console.error('Failed to delete the record.', 'error');
                    showToast('Failed to delete the record.', 'danger');
                }
            }
        });
        container.append(card);
    });
}

async function initMaps() {
    
    
    try {
        const {
            Map
        } = await google.maps.importLibrary("maps");
        const markerLib = await google.maps.importLibrary("marker");
        const placesLib = await google.maps.importLibrary("places");
        AdvancedMarkerElement = markerLib.AdvancedMarkerElement;
        PinElement = markerLib.PinElement;
        
        // Initialize directions service and distance matrix service
        directionsService = new google.maps.DirectionsService();
        distanceMatrixService = new google.maps.DistanceMatrixService();
        
        map = new Map(document.getElementById('map'), {
            center: BUREAU_VERITAS_KOLKATA,
            zoom: 12,
            mapId: 'DASHBOARD_MAP',
            backgroundColor: '#0b0c10',
            gestureHandling: "greedy",
            streetViewControl: false,
            mapTypeControl: false,
            disableDefaultUI: true
        });
        const siteSearchInput = document.getElementById('site-search-input');
        const siteAutocomplete = new placesLib.Autocomplete(siteSearchInput);
        siteAutocomplete.addListener('place_changed', () => {
            const place = siteAutocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) return;
            selectedPlace = place;
            if (siteMarker) siteMarker.map = null;
            siteMarker = new AdvancedMarkerElement({
                map,
                position: place.geometry.location.toJSON()
            });
            map.panTo(place.geometry.location);
            map.setZoom(16);
        });
        const homeAddressInput = document.getElementById('home-address-input');
        const homeAutocomplete = new placesLib.Autocomplete(homeAddressInput);
        homeAutocomplete.addListener('place_changed', () => {
            homePlace = homeAutocomplete.getPlace();
            if (homePlace?.formatted_address) {
                homeAddressInput.value = homePlace.formatted_address;
                $('#home-valid-icon').fadeIn();
            }
        });
        $(homeAddressInput).on('input', () => {
            homePlace = null;
            $('#home-valid-icon').fadeOut();
        });
        setupGeolocationWatcher();
    } catch (e) {
        $("#map-wrapper").html('<p class="text-danger text-center">Map could not be loaded.</p>');
        $("#gps-status").html('<i class="bi bi-exclamation-triangle-fill text-danger"></i> Map services failed to load.');
    }
}

function setupGeolocationWatcher() {
    const gpsStatus = $('#gps-status');
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((pos) => {
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
            const currentPos = {
                lat: userLat,
                lng: userLng
            };
            gpsStatus.html(`<i class="bi bi-geo-alt-fill text-success"></i> GPS Lock Acquired`);
            if (!userLiveMarker) {
                const pin = new PinElement({
                    background: '#4285F4',
                    borderColor: '#FFFFFF',
                    glyphColor: '#FFFFFF'
                });
                userLiveMarker = new AdvancedMarkerElement({
                    position: currentPos,
                    map,
                    content: pin.element
                });
                map.setCenter(currentPos);
                map.setZoom(15);
            } else {
                userLiveMarker.position = currentPos;
            }
            Firestore.updateLiveLocation({
                coords: currentPos,
                timestamp: Date.now(),
                fullname: userName,
                email: userEmail
            }).catch(err => console.error("Could not update live location", err));
        }, (err) => {
            let message = "Could not get your location.";
            if (err.code === 1) message = "Location access denied. Please enable it in your browser settings.";
            else if (err.code === 2) message = "Location unavailable.";
            else if (err.code === 3) message = "Location timeout.";
            gpsStatus.html(`<i class="bi bi-exclamation-triangle-fill text-danger"></i> ${message}`);
        }, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    } else {
        gpsStatus.text("Geolocation is not supported by this browser.");
    }
}

function handleFilterChange() {
    const filter = $("#filter-select").val();
    $("#start-date, #end-date").toggle(filter === 'custom');
    $("#attendance-cards").empty();
    lastVisibleJob = null;
    $('#load-more-container').hide();
    loadMoreJobs();
}

function applyAnimatedCardClass() {
    $('#dashboard-stats-container').find('.stat-box-compact').addClass('animated-card');
}

async function loadMoreJobs() {
    const loadMoreBtn = $('#load-more-btn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Loading...');
    try {
        const {
            jobs,
            lastVisible
        } = await Firestore.getJobsPaginated(userUid, lastVisibleJob);
        lastVisibleJob = lastVisible;
        const filteredJobs = filterJobs(jobs, $("#filter-select").val(), 'attendance');
        if (filteredJobs.length === 0 && $("#attendance-cards").children().length === 0) {
            $("#attendance-cards").html(`<p class='text-center text-secondary p-4'>No site visit records for this period.</p>`);
            $('#load-more-container').hide();
            return;
        }
        appendJobCards(filteredJobs);
        $('#load-more-container').toggle(jobs.length >= JOBS_PER_PAGE);
    } catch (err) {
        console.error("Failed to load attendance records.", "error");
    } finally {
        loadMoreBtn.prop('disabled', false).html('Load More');
    }
}

function getAvatarHtml(user) {
    // user is an object that should contain profilePhoto, googlePhotoURL, fullname, and email
    if (!user) return `<div class="profile-avatar-initials">?</div>`;

    const name = user.fullname || user.email || 'User';
    const initials = (name.split(' ').map(n => n[0]).join('') || '?').toUpperCase();

    if (user.profilePhoto) {
        // Priority 1: Use the photo uploaded within the app
        return `<img src="${user.profilePhoto}" alt="${escape(name)}">`;
    } else if (user.googlePhotoURL) {
        // Priority 2: Use the Google profile photo
        return `<img src="${user.googlePhotoURL}" alt="${escape(name)}">`;
    } else {
        // Priority 3: Fallback to initials
        return `<div class="profile-avatar-initials">${initials}</div>`;
    }
}

function formatDate(date) {
    const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    };
    return date.toLocaleString('en-US', options);
}

function appendJobCards(jobs) {
    const container = $("#attendance-cards");
    jobs.forEach((job, index) => {
        const duration = job.exitTime ? calculateDuration(job.entryTime, job.exitTime) : 'Ongoing';
        const entryTimeFormatted = job.entryTime ? formatDate(new Date(job.entryTime)) : 'N/A';
        const exitTimeFormatted = job.exitTime ? formatDate(new Date(job.exitTime)) : 'N/A';

        const card = $(`<div class="attendance-card" id="job-${job.id}"><div class="card-summary d-flex align-items-center" style="cursor:pointer;"><span class="status-dot ${job.status==='completed'?'completed':'pending'} me-3"></span><div class="flex-grow-1"><div class="card-place">${escape(job.place)}</div><div class="card-date small">${new Date(job.entryTime).toLocaleDateString()}</div></div><i class="bi bi-chevron-down ms-3"></i></div><div class="record-details" style="display:none;"><div class="row g-3"><div class="col-12 col-sm-6 text-center record-photo-container"><a class="view-photo-btn" data-img-src="${job.entryPhoto}"><img src="${job.entryPhoto}" loading="lazy" class="rounded w-100"></a><div class="small mt-1 text-secondary">Entry Photo</div></div>${job.exitPhoto?`<div class="col-12 col-sm-6 text-center record-photo-container"><a class="view-photo-btn" data-img-src="${job.exitPhoto}"><img src="${job.exitPhoto}" loading="lazy" class="rounded w-100"></a><div class="small mt-1 text-secondary">Exit Photo</div></div>`:''}<div class="col-12 record-info-container"><p class="small mb-1"><span class="info-label">Duration:</span> <strong>${duration}</strong></p><p class="small mb-1"><span class="info-label">Entry Time:</span> <strong>${entryTimeFormatted}</strong></p>${job.exitTime?`<p class="small mb-0"><span class="info-label">Exit Time:</span> <strong>${exitTimeFormatted}</strong></p>`:''}</div></div></div></div>`);
        card.find('.card-summary').click(function() {
            $(this).next('.record-details').slideToggle(300);
            $(this).find('i').toggleClass('bi-chevron-down bi-chevron-up');
        });
        container.append(card);
    });
}

async function handleCheckIn() {
    if (isCheckinProcessing) {
        return;
    }
    isCheckinProcessing = true;
    const btn = $('#checkin-btn');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processing...');

    try {
        if (!userLat || !userLng) {
            showToast("Waiting for GPS signal...", "warning");
            return;
        }
        if (!selectedPlace) {
            showToast("Please select a site from the map first.", "warning");
            return;
        }
        const pendingJobs = (await Firestore.getJobs(userUid)).filter(j => j.status === "pending-exit");
        if (pendingJobs.length > 0) {
            showToast("You already have a pending check-in. Please check out first.", "warning");
            return;
        }
        const distance = getDistance(userLat, userLng, selectedPlace.geometry.location.lat(), selectedPlace.geometry.location.lng());
        if (distance <= 500) {
            openCamera('entry');
        } else {
            showToast(`You are ${Math.round(distance)}m away. You must be within 500m of the site to mark entry.`, "danger");
        }
    } catch (err) {
        console.error("Could not verify check-in status.", "error");
        showToast("Could not verify check-in status.", "danger");
    } finally {
        isCheckinProcessing = false;
        btn.prop('disabled', false).html('<i class="bi bi-box-arrow-in-right"></i> Mark Entry');
    }
}

async function handleCheckout() {
    if (isCheckoutProcessing) {
        return;
    }
    isCheckoutProcessing = true;
    const btn = $('#checkout-btn');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processing...');

    try {
        if (!userLat || !userLng) {
            showToast("Waiting for GPS signal...", "warning");
            return;
        }
        const pendingJob = (await Firestore.getJobs(userUid)).find(j => j.status === "pending-exit");
        if (!pendingJob) {
            showToast("No active check-in found.", "warning");
            return;
        }
        const distance = getDistance(userLat, userLng, pendingJob.coords.lat, pendingJob.coords.lng);
        if (distance <= 1000) {
            openCamera('exit', pendingJob.id);
        } else {
            showToast(`You are ${Math.round(distance)}m away from the last check-in location. You must be within 1km of the site to mark exit.`, "danger");
        }
    } catch (err) {
        console.error("Could not verify check-out status.", "error");
        showToast("Could not verify check-out status.", "danger");
    } finally {
        isCheckoutProcessing = false;
        btn.prop('disabled', false).html('<i class="bi bi-box-arrow-right"></i> Mark Exit');
    }
}

async function finishAttendance(type, photo, jobId = null) {
    const location = selectedPlace.geometry.location;
    const jobData = {
        place: selectedPlace.name || "Unknown",
        address: selectedPlace.formatted_address || "N/A",
        coords: {
            lat: location.lat(),
            lng: location.lng()
        }
    };
    try {
        if (type === 'entry') {
            Object.assign(jobData, {
                entryTime: new Date().toISOString(),
                entryPhoto: photo,
                status: "pending-exit"
            });
            await Firestore.addJob(jobData);
            showToast("Entry marked successfully! Remember to check out.", 'success');
        } else {
            await Firestore.updateJob(jobId, {
                exitTime: new Date().toISOString(),
                exitPhoto: photo,
                status: "completed"
            });
            showToast("Exit marked successfully!", 'success');
        }
        handleFilterChange();
        renderDashboardSummary();
        if ($('#statistics').is(':visible')) renderStatistics();
        if (fullCalendar) fullCalendar.refetchEvents();
    } catch (err) {
        console.error("Error saving attendance.", "error");
        showToast("Error saving attendance.", "danger");
    }
}

async function handleProfileSave(e) {
    e.preventDefault();
    const btn = $(e.target).find('button[type="submit"]');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');
    try {
        const newFullname = $("#prof-fullname").val();
        const profilePhotoInput = $('#profile-photo-input')[0];
        let profilePhotoUrl = $('#profile-avatar img').attr('src'); // Get existing photo URL if it's an img
        
        // Check if a new file was uploaded (a more robust check would be needed for real file uploads)
        if (!profilePhotoUrl && !$('#profile-avatar img').length) {
            profilePhotoUrl = ''; // Or handle default initials logic
        }

        const userRole = $("#prof-role").val();
        
        await Firestore.setProfile({
            email: userEmail,
            username: $("#prof-username").val(),
            fullname: newFullname,
            contact: $("#prof-contact").val(),
            profilePhoto: profilePhotoUrl || '', // Ensure a value is set
            role: userRole
        });
        userName = newFullname;
        
        // Update all display elements
        $("#user-name").text(`Welcome, ${userName.split(' ')[0]}`);
        $("#profile-name-display").text(newFullname);
        $("#profile-email-display").text(userEmail);
        $("#profile-role-display").text(userRole);
        
        showToast('Profile saved!', 'success');
    } catch (err) {
        console.error('Failed to save profile.', err);
        showToast('Failed to save profile.', 'danger');
    } finally {
        btn.prop('disabled', false).text('Save Changes');
    }
}

async function handleHomeAddressSave(e) {
    e.preventDefault();
    const btn = $(e.target).find('button[type="submit"]');
    if (!homePlace) {
        return showToast('Please select a valid address from the list.', 'warning');
    }
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');
    const homeData = {
        homeLocation: {
            name: homePlace.name,
            address: homePlace.formatted_address,
            coords: {
                lat: homePlace.geometry.location.lat(),
                lng: homePlace.geometry.location.lng()
            }
        }
    };
    try {
        await Firestore.setProfile(homeData);
        $('#home-valid-icon').fadeOut();
        showToast('Home address saved!', 'success');
        if ($('#statistics').is(':visible')) renderStatistics();
    } catch (err) {
        console.error('Failed to save home address.', 'error');
        showToast('Failed to save home address.', 'danger');
    } finally {
        btn.prop('disabled', false).text('Save Home');
    }
}

async function renderTravelStats(type = 'profile') {
    if (typeof google === 'undefined' || !google.maps?.geometry) {
        setTimeout(() => renderTravelStats(type), 250);
        return;
    }
    const detailsId = `#${type}-travel-details`;
    const summaryId = `#${type}-travel-summary`;
    $(detailsId).html(getSpinnerHTML());
    if ($(summaryId)) $(summaryId).empty();
    try {
        const [userProfile, allJobs] = await Promise.all([Firestore.getProfile(userUid), Firestore.getJobs(userUid)]);
        $(detailsId).empty();
        if (!userProfile.homeLocation?.coords) {
            $(detailsId).html(`<p class='text-secondary text-center mt-3'><i class='bi bi-info-circle-fill me-2'></i>Set home address in Profile to view travel stats.</p>`);
            if (type === 'stats') updateStatsMap([], null);
            return;
        }
        const filter = $(`#${type}-travel-filter-select`).val();
        $(`#${type}-travel-start-date, #${type}-travel-end-date`).toggle(filter === 'custom');
        const filteredJobs = filterJobs(allJobs, filter, `${type}-travel`);
        let totalDistance = 0;
        const validJobs = filteredJobs.filter(j => j && j.coords && j.entryTime);
        if (type === 'stats') updateStatsMap(validJobs, userProfile);
        if (validJobs.length === 0) {
            $(detailsId).html("<p class='text-center text-secondary mt-3'>No travel data for this period.</p>");
            if ($(summaryId)) $(summaryId).empty();
            return;
        }
        
        // Use distance matrix service for accurate road distances
        if (distanceMatrixService && validJobs.length > 0) {
            const homeCoords = userProfile.homeLocation.coords;
            
            // Process jobs in batches to avoid hitting API limits
            const batchSize = 10; // Process 10 jobs at a time
            const results = [];
            
            for (let i = 0; i < validJobs.length; i += batchSize) {
                const batch = validJobs.slice(i, i + batchSize);
                
                // Create destinations array for this batch
                const destinations = batch.map(job => ({
                    lat: job.coords.lat,
                    lng: job.coords.lng
                }));
                
                try {
                    // Get road distances using Distance Matrix
                    const distanceMatrixResponse = await getDistanceMatrix(homeCoords, destinations);
                    
                    // Process results
                    for (let j = 0; j < batch.length; j++) {
                        const job = batch[j];
                        const distance = distanceMatrixResponse[j];
                        const roundTripDistance = distance * 2; // Round trip distance
                        
                        results.push({
                            ...job,
                            roadDistance: roundTripDistance
                        });
                        
                        totalDistance += roundTripDistance;
                        
                        // Add to UI
                        $(detailsId).append(`<div class="travel-card"><div class="d-flex justify-content-between align-items-center"><div><div class="card-place">${escape(job.place)}</div><div class="card-date small">${new Date(job.entryTime).toLocaleDateString()}</div></div><div class="text-end"><h5 class="mb-0 text-accent">${roundTripDistance.toFixed(1)} km</h5><small class="text-secondary">Round Trip (Road)</small></div></div></div>`);
                    }
                } catch (error) {
                    console.error("Error getting distance matrix:", error);
                    
                    // Fallback to straight-line distance if API fails
                    for (let j = 0; j < batch.length; j++) {
                        const job = batch[j];
                        const straightLineDistance = getDistanceKm(homeCoords, job.coords);
                        const roundTripDistance = straightLineDistance * 2;
                        
                        results.push({
                            ...job,
                            roadDistance: roundTripDistance
                        });
                        
                        totalDistance += roundTripDistance;
                        
                        // Add to UI with fallback note
                        $(detailsId).append(`<div class="travel-card"><div class="d-flex justify-content-between align-items-center"><div><div class="card-place">${escape(job.place)}</div><div class="card-date small">${new Date(job.entryTime).toLocaleDateString()}</div></div><div class="text-end"><h5 class="mb-0 text-accent">${roundTripDistance.toFixed(1)} km</h5><small class="text-secondary">Round Trip (Estimate)</small></div></div></div>`);
                    }
                }
            }
            
            if ($(summaryId)) {
                $(summaryId).html(`<div class="row text-center g-3 g-md-4"><div class="col-6"><div class="stat-box"><h4>${totalDistance.toFixed(1)} <small>km</small></h4><p>Total Distance</p></div></div><div class="col-6"><div class="stat-box"><h4>${validJobs.length}</h4><p>Total Trips</p></div></div></div>`);
            }
        } else {
            // Fallback to straight-line distance if service not available
            console.warn("Distance Matrix Service not available, using straight-line distance");
            
            const homeCoords = userProfile.homeLocation.coords;
            validJobs.forEach(job => {
                const roundTripDistance = getDistanceKm(homeCoords, job.coords) * 2;
                totalDistance += roundTripDistance;
                $(detailsId).append(`<div class="travel-card"><div class="d-flex justify-content-between align-items-center"><div><div class="card-place">${escape(job.place)}</div><div class="card-date small">${new Date(job.entryTime).toLocaleDateString()}</div></div><div class="text-end"><h5 class="mb-0 text-accent">${roundTripDistance.toFixed(1)} km</h5><small class="text-secondary">Round Trip (Estimate)</small></div></div></div>`);
            });
            
            if ($(summaryId)) {
                $(summaryId).html(`<div class="row text-center g-3 g-md-4"><div class="col-6"><div class="stat-box"><h4>${totalDistance.toFixed(1)} <small>km</small></h4><p>Total Distance</p></div></div><div class="col-6"><div class="stat-box"><h4>${validJobs.length}</h4><p>Total Trips</p></div></div></div>`);
            }
        }
    } catch (err) {
        console.error("Could not load travel statistics.", "error");
        $(detailsId).html("<p class='text-center text-danger'>Failed to load travel data.</p>");
    }
}

// Helper function to get distance matrix
async function getDistanceMatrix(origin, destinations) {
    return new Promise((resolve, reject) => {
        if (!distanceMatrixService) {
            reject(new Error("Distance Matrix Service not available"));
            return;
        }
        
        distanceMatrixService.getDistanceMatrix(
            {
                origins: [origin],
                destinations: destinations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
            },
            (response, status) => {
                if (status === 'OK') {
                    // Extract distances in kilometers
                    const distances = response.rows[0].elements.map(element => {
                        if (element.status === 'OK') {
                            // Convert meters to kilometers
                            return element.distance.value / 1000;
                        } else {
                            // Fallback to straight-line distance if route not found
                            const destIndex = response.rows[0].elements.indexOf(element);
                            const dest = destinations[destIndex];
                            return getDistanceKm(origin, dest);
                        }
                    });
                    resolve(distances);
                } else {
                    console.error('Distance Matrix request failed due to:', status);
                    reject(new Error(`Distance Matrix request failed: ${status}`));
                }
            }
        );
    });
}

async function updateStatsMap(jobs, profile) {
    if (!statsMap) return;
    statsMapMarkers.forEach(marker => marker.setMap(null));
    statsMapMarkers = [];
    const bounds = new google.maps.LatLngBounds();
    const {
        AdvancedMarkerElement,
        PinElement
    } = await google.maps.importLibrary("marker");
    if (profile && profile.homeLocation?.coords) {
        const homePos = profile.homeLocation.coords;
        const homePin = new PinElement({
            background: '#10B981',
            borderColor: '#fff',
            glyphColor: '#fff'
        });
        const homeMarker = new AdvancedMarkerElement({
            position: homePos,
            map: statsMap,
            title: 'Home',
            content: homePin.element
        });
        statsMapMarkers.push(homeMarker);
        bounds.extend(homePos);
    }
    jobs.forEach(job => {
        if (job.coords) {
            const jobPos = job.coords;
            const jobMarker = new AdvancedMarkerElement({
                position: jobPos,
                map: statsMap,
                title: job.place
            });
            statsMapMarkers.push(jobMarker);
            bounds.extend(jobPos);
        }
    });
    if (statsMapMarkers.length > 0 && !bounds.isEmpty()) {
        statsMap.fitBounds(bounds, 50);
        if (statsMap.getZoom() > 15) {
            statsMap.setZoom(15);
        }
        if (statsMapMarkers.length === 1) {
            statsMap.setCenter(bounds.getCenter());
            statsMap.setZoom(12);
        }
    } else {
        statsMap.setCenter({
            lat: 20.5937,
            lng: 78.9629
        });
        statsMap.setZoom(5);
    }
}

async function handleHelpRequest(e) {
    e.preventDefault();
    const message = $("#help-message").val();
    if (!message.trim()) return;
    const btn = $(e.target).find('button[type="submit"]');
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');
    try {
        const profile = await Firestore.getProfile(userUid);
        await Firestore.addIssue({
            userUid,
            userEmail,
            userName,
            userContact: profile.contact,
            message,
            timestamp: new Date().toISOString()
        });
        showToast('Issue submitted successfully!', 'success');
        $("#help-message").val('');
    } catch (err) {
        console.error('Could not send your message.', 'error');
        showToast('Failed to submit issue.', 'danger');
    } finally {
        btn.prop('disabled', false).text('Send Message');
    }
}

function openCamera(type, jobId = null) {
    $("#camera-modal").css("display", "flex");
    const video = $("#video")[0];
    const constraints = {
        video: {
            facingMode: usingFront ? 'user' : 'environment',
            width: {
                ideal: 1280
            },
            height: {
                ideal: 720
            }
        }
    };
    const startCam = () => {
        if (globalStream) {
            globalStream.getTracks().forEach(track => track.stop());
        }
        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            video.srcObject = stream;
            globalStream = stream;
        }).catch(err => {
            let message = "Could not access camera.";
            if (err.name === "NotAllowedError") message = "Camera access was denied.";
            else if (err.name === "NotFoundError") message = "No camera was found.";
            console.error(message, 'error');
            showToast(message, 'danger');
            $("#camera-modal").hide();
        });
    };
    startCam();
    $("#snap-btn").off().click(() => {
        const canvas = $("#canvas")[0];
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        if (usingFront) {
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
        }
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const photo = canvas.toDataURL('image/jpeg', 0.8);
        if (globalStream) globalStream.getTracks().forEach(track => track.stop());
        $("#camera-modal").hide();
        finishAttendance(type, photo, jobId);
    });
    $("#flip-btn").off().click(() => {
        usingFront = !usingFront;
        constraints.video.facingMode = usingFront ? 'user' : 'environment';
        startCam();
    });
    $("#cancel-btn").off().click(() => {
        if (globalStream) globalStream.getTracks().forEach(track => track.stop());
        $("#camera-modal").hide();
    });
}

 $(document).on('click', '.view-photo-btn', function(e) {
    e.preventDefault();
    const imgSrc = $(this).data('img-src');
    $('#fullscreen-image').attr('src', imgSrc);
    $('#image-viewer').css('display', 'flex').hide().fadeIn(200);
});

function getDistance(lat1, lon1, lat2, lon2) {
    if (lat1 === null || lon1 === null || !google?.maps?.geometry) return Infinity;
    return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(lat1, lon1), new google.maps.LatLng(lat2, lon2));
}

function getDistanceKm(coords1, coords2) {
    if (!coords1 || !coords2 || !google?.maps?.geometry) return 0;
    return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(coords1.lat, coords1.lng), new google.maps.LatLng(coords2.lat, coords2.lng)) / 1000;
}

function escape(t) {
    return t ? String(t).replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
    }[m])) : "";
}

function filterJobs(jobs, filter, type) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate = new Date(0);
    let endDate = new Date();

    const startStr = $(`#${type}-start-date`).val();
    const endStr = $(`#${type}-end-date`).val();

    switch (filter) {
        case 'yesterday':
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            return jobs.filter(j => j?.entryTime && new Date(j.entryTime) >= yesterday && new Date(j.entryTime) < today);
        case 'last7':
            const last7 = new Date(today);
            last7.setDate(today.getDate() - 6);
            return jobs.filter(j => j?.entryTime && new Date(j.entryTime) >= last7);
        case 'last30':
            const last30 = new Date(today);
            last30.setDate(today.getDate() - 29);
            return jobs.filter(j => j?.entryTime && new Date(j.entryTime) >= last30);
        case 'custom':
            if (!startStr || !endStr) return [];
            const sDate = new Date(startStr);
            sDate.setHours(0, 0, 0, 0);
            const eDate = new Date(endStr);
            eDate.setHours(23, 59, 59, 999);
            return jobs.filter(j => j?.entryTime && new Date(j.entryTime) >= sDate && new Date(j.entryTime) <= eDate);
        default:
            return jobs;
    }
}

function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return '';
    const start = new Date(startTime);
    const end = new Date(endTime);
    let diff = Math.abs(end.getTime() - start.getTime()) / 1000;
    const hours = Math.floor(diff / 3600);
    diff %= 3600;
    const minutes = Math.floor(diff / 60);
    return `${hours}h ${minutes}m`;
}

function toggleAdminSelectMode(forceOff = false) {
    isAdminSelectMode = forceOff ? false : !isAdminSelectMode;
    const btn = $('#admin-toggle-select-mode');
    const userCard = $('#admin-user-selection-card');
    if (isAdminSelectMode) {
        btn.html('<i class="bi bi-x-lg me-2"></i>Cancel').removeClass('btn-primary').addClass('btn-secondary');
        userCard.addClass('select-mode-active');
        $('#admin-user-details-wrapper').slideUp(200);
    } else {
        btn.html('<i class="bi bi-check2-square me-2"></i>Select').removeClass('btn-secondary').addClass('btn-primary');
        userCard.removeClass('select-mode-active');
        $('#admin-users-list .admin-user-checkbox').prop('checked', false);
        $('#admin-actions-bar').slideUp(200);
    }
}

function handleAdminUserRowClick(event) {
    const checkbox = $(this).find('.admin-user-checkbox');
    if ($(event.target).is('input[type="checkbox"]')) {} else if (isAdminSelectMode) {
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
    } else {
        handleAdminSingleUserView($(this).data('uid'));
    }
}

 $('#admin-users-list').on('change', '.admin-user-checkbox', toggleAdminActionsBar);

async function handleAdminSingleUserView(uid) {
    const profile = await Firestore.getProfile(uid);
    $('#admin-modal-records-list').html(getSpinnerHTML());
    adminUserDetailsModal.show();
    await setupAdminView(uid, profile);
}

function toggleAdminActionsBar() {
    const selectedCheckboxes = $('#admin-users-list .admin-user-checkbox:checked');
    const allCheckboxes = $('#admin-users-list .admin-user-checkbox');
    if (isAdminSelectMode && selectedCheckboxes.length > 0) {
        $('#admin-actions-bar').slideDown(200);
    } else {
        $('#admin-actions-bar').slideUp(200);
    }
    $('#admin-select-all-users').prop('checked', allCheckboxes.length > 0 && selectedCheckboxes.length === allCheckboxes.length);
}

async function handleSingleUserExport(uid, userName) {
    showToast('Preparing export for ' + userName, 'info');
    const [allJobs, profile] = await Promise.all([Firestore.getJobs(uid), Firestore.getProfile(uid)]);
    const jobs = filterJobs(allJobs, $('#admin-filter-select').val(), 'admin');
    const homeCoords = profile.homeLocation?.coords;
    const exportData = jobs.map(job => {
        let oneWayDist = homeCoords && job.coords ? getDistanceKm(homeCoords, job.coords) : 0;
        return {
            "Full Name": userName,
            "Email": profile.email,
            "Site Name": job.place || '',
            "Address": job.address || '',
            "Entry Time": job.entryTime ? new Date(job.entryTime).toLocaleString() : '',
            "Exit Time": job.exitTime ? new Date(job.exitTime).toLocaleString() : '',
            "Status": job.status || '',
            "Duration": job.exitTime ? calculateDuration(job.entryTime, job.exitTime) : 'Ongoing',
            "One-Way Distance": oneWayDist ? `${oneWayDist.toFixed(2)} km` : '',
            "Two-Way Distance": oneWayDist ? `${(oneWayDist * 2).toFixed(2)} km` : ''
        };
    });
    const worksheet = XLSX.utils.json_to_sheet(exportData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "User Report");
    XLSX.writeFile(workbook, `${userName.replace(/\s+/g, '_')}_Report.xlsx`);
}

async function handleMultiExport() {
    const selectedCheckboxes = $('#admin-users-list .admin-user-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        return showToast('Please select at least one user to export records for.', 'warning');
    }
    if (confirm(`Are you sure you want to export records in the selected time frame for ${selectedCheckboxes.length} user(s)?`)) {
        showToast("Exporting...", 'info');
        const allData = [];
        try {
            for (const checkbox of selectedCheckboxes) {
                const row = $(checkbox).closest('.admin-user-row');
                const [uid, userName, userEmail] = [row.data('uid'), row.data('name'), row.data('email')];
                const [profile, allJobs] = await Promise.all([Firestore.getProfile(uid), Firestore.getJobs(uid)]);
                const jobs = filterJobs(allJobs, $('#admin-filter-select').val(), 'admin');
                const homeCoords = profile.homeLocation?.coords;
                jobs.forEach(job => {
                    let oneWayDist = homeCoords && job.coords ? getDistanceKm(homeCoords, job.coords) : 0;
                    allData.push({
                        "Full Name": userName,
                        "Email": userEmail,
                        "Site Name": job.place || '',
                        "Address": job.address || '',
                        "Entry Time": job.entryTime ? new Date(job.entryTime).toLocaleString() : '',
                        "Exit Time": job.exitTime ? new Date(job.exitTime).toLocaleString() : '',
                        "Status": job.status || '',
                        "Duration": job.exitTime ? calculateDuration(job.entryTime, job.exitTime) : '',
                        "One-Way Distance": oneWayDist ? `${oneWayDist.toFixed(2)} km` : '',
                        "Two-Way Distance": oneWayDist ? `${(oneWayDist * 2).toFixed(2)} km` : ''
                    });
                });
            }
            if (allData.length === 0) {
                return showToast("No records to export for the selected users and time frame.", "warning");
            }
            const worksheet = XLSX.utils.json_to_sheet(allData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance Report");
            XLSX.writeFile(workbook, `Multi-User_Attendance_Report.xlsx`);
            showToast("Export successful!", 'success');
        } catch (err) {
            console.error('Failed to export records.', err);
            showToast('Failed to export records.', 'danger');
        }
    }
}

async function handleMultiDelete() {
    const selectedCheckboxes = $('#admin-users-list .admin-user-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        return showToast('Please select at least one user to delete records for.', 'warning');
    }
    if (confirm(`Are you sure you want to delete records in the selected time frame for ${selectedCheckboxes.length} user(s)? This cannot be undone.`)) {
        showToast("Deletion in progress...", 'info');
        let deleteCount = 0;
        try {
            for (const checkbox of selectedCheckboxes) {
                const uid = $(checkbox).closest('.admin-user-row').data('uid');
                const jobsToDelete = filterJobs(await Firestore.getJobs(uid), $('#admin-filter-select').val(), 'admin');
                const deletePromises = jobsToDelete.map(job => Firestore.deleteJob(job.id, uid));
                await Promise.all(deletePromises);
                deleteCount += jobsToDelete.length;
            }
            showToast(`${deleteCount} record(s) deleted successfully.`, 'success');
            toggleAdminSelectMode(true);
        } catch (err) {
            console.error('Failed to delete records.', 'error');
            showToast('Failed to delete records.', 'danger');
        }
    }
}

function yyyymmdd(date) {
    return date.toISOString().slice(0, 10);
}

async function showDayDetailModal(dateStr, uid) {
    const date = new Date(dateStr + 'T00:00:00');
    $('#modal-date-display').text(date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }));
    const [jobsSnapshot, dailyStatusSnapshot, globalEventsSnapshot] = await Promise.all([
        db.collection("attendance").doc(uid).collection("entries").get(),
        db.collection("daily_status").doc(uid).collection("entries").get(),
        db.collection("global_events").get() // Fetch global events
    ]);
    let eventsHtml = '';
    jobsSnapshot.forEach(doc => {
        const job = doc.data();
        if (job.entryTime && yyyymmdd(new Date(job.entryTime)) === dateStr) {
            eventsHtml += `<div class="list-group-item bg-transparent border-secondary"><i class="bi bi-geo-alt-fill text-success me-2"></i> Site Visit: ${escape(job.place)}</div>`;
        }
    });
    const dailyStatusDoc = dailyStatusSnapshot.docs.find(doc => doc.id === dateStr);
    if (dailyStatusDoc) {
        const status = dailyStatusDoc.data().status;
        if (status === 'office') eventsHtml += `<div class="list-group-item bg-transparent border-secondary"><i class="bi bi-building text-info me-2"></i> Office Work</div>`;
        else if (status === 'leave') eventsHtml += `<div class="list-group-item bg-transparent border-secondary"><i class="bi bi-calendar-x-fill text-danger me-2"></i> On Leave</div>`;
        else if (status === 'remote') eventsHtml += `<div class="list-group-item bg-transparent border-secondary"><i class="bi bi-house-door text-warning me-2"></i> Remote Job</div>`;
    }

    // Check for global holiday
    const globalHolidayDoc = globalEventsSnapshot.docs.find(doc => doc.id === dateStr);
    if (globalHolidayDoc && globalHolidayDoc.data().type === 'holiday') {
        eventsHtml += `<div class="list-group-item bg-transparent border-secondary" style="color: #9b59b6;"><i class="bi bi-calendar-star-fill me-2"></i> Holiday</div>`;
    }

    $('#modal-event-details').html(eventsHtml || `<p class="text-secondary p-3">No activity recorded.</p>`);
    $('#modal-mark-office-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, 'office', uid));
    $('#modal-mark-remote-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, 'remote', uid));
    $('#modal-mark-leave-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, 'leave', uid));
    $('#modal-mark-clear-btn').off('click').on('click', () => handleDailyStatusUpdate(dateStr, null, uid));
    dayDetailModal.show();
}

async function handleDailyStatusUpdate(dateString, status, uid) {
    try {
        if (status) {
            await Firestore.setDailyStatus(dateString, status, uid);
        } else {
            await Firestore.deleteDailyStatus(dateString, uid);
        }
        showToast('Attendance updated successfully.', 'success');
        if (fullCalendar) fullCalendar.refetchEvents();
        if (adminDetailCalendar) adminDetailCalendar.refetchEvents();
    } catch (err) {
        console.error('Failed to update attendance status.', 'error');
        showToast('Failed to update attendance status.', 'danger');
    } finally {
        dayDetailModal.hide();
    }
}

function initializeFullCalendar(uid = userUid, targetElId = 'dashboard-calendar', isReadOnly = false) {
    const calendarEl = document.getElementById(targetElId);
    if (!calendarEl) return;

    // Destroy existing instance if present
    let calendarInstance = isReadOnly ? adminDetailCalendar : fullCalendar;
    if (calendarInstance && typeof calendarInstance.destroy === 'function') {
        calendarInstance.destroy();
    }

    const isMobile = window.innerWidth < 768;

    calendarInstance = new FullCalendar.Calendar(calendarEl, {
        height: isMobile ? 450 : 550,
        initialView: 'dayGridMonth',

        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: isMobile ? '' : 'dayGridMonth'
        },

        dayHeaderFormat: isMobile ? { weekday: 'narrow' } : { weekday: 'short' },

        eventDisplay: 'block',

        events: async (fetchInfo, successCallback, failureCallback) => {
            try {
                // fetch attendance entries, daily status and global events in parallel
                const [jobsSnapshot, dailyStatusSnapshot, globalEventsSnapshot] = await Promise.all([
                    db.collection("attendance").doc(uid).collection("entries").get(),
                    db.collection("daily_status").doc(uid).collection("entries").get(),
                    db.collection("global_events").get() // Fetch global events
                ]);

                // Map: date string -> Set of types (e.g. 'site-visit', 'office', 'remote', 'leave', 'holiday')
                const eventMap = new Map();

                // Attendance (site visits)
                jobsSnapshot.forEach(doc => {
                    const job = doc.data();
                    if (job && job.entryTime) {
                        const dateStr = yyyymmdd(new Date(job.entryTime));
                        if (!eventMap.has(dateStr)) eventMap.set(dateStr, new Set());
                        eventMap.get(dateStr).add('site-visit');
                    }
                });

                // Daily status (office/remote/leave etc.)
                dailyStatusSnapshot.forEach(doc => {
                    const statusData = doc.data();
                    // if you store status as .status, use that; otherwise adjust accordingly
                    const status = statusData && statusData.status;
                    const dateStr = doc.id;
                    if (!eventMap.has(dateStr)) eventMap.set(dateStr, new Set());
                    if (status) eventMap.get(dateStr).add(status);
                });

                // Global events (holidays etc.)
                globalEventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    const dateStr = doc.id;
                    if (event && event.type === 'holiday') {
                        if (!eventMap.has(dateStr)) eventMap.set(dateStr, new Set());
                        eventMap.get(dateStr).add('holiday');
                    }
                });

                // Build FullCalendar events array with priority: holiday > site-visit > office/remote/leave
                const events = [];
                eventMap.forEach((types, date) => {
                    // Holiday gets its own event; allow adding additional events on same date as needed.
                    if (types.has('holiday')) {
                        events.push({
                            title: 'Holiday',
                            start: date,
                            allDay: true,
                            className: 'event-holiday'
                        });

                        // If site-visit also present, include it too
                        if (types.has('site-visit')) {
                            events.push({
                                title: 'Site Visit',
                                start: date,
                                allDay: true,
                                className: 'event-site-visit'
                            });
                        }
                        // (You can add other types alongside holiday if desired)
                        return;
                    }

                    if (types.has('site-visit')) {
                        events.push({
                            title: 'Site Visit',
                            start: date,
                            allDay: true,
                            className: 'event-site-visit'
                        });
                        // continue to add other statuses too (office/remote/leave) if present
                    }

                    if (types.has('office')) {
                        events.push({
                            title: 'Office',
                            start: date,
                            allDay: true,
                            className: 'event-office'
                        });
                    } else if (types.has('remote')) {
                        events.push({
                            title: 'Remote Job',
                            start: date,
                            allDay: true,
                            className: 'event-remote'
                        });
                    } else if (types.has('leave')) {
                        events.push({
                            title: 'Leave',
                            start: date,
                            allDay: true,
                            className: 'event-leave'
                        });
                    }
                });

                successCallback(events);
            } catch (error) {
                console.error("Error fetching calendar events:", error);
                if (typeof failureCallback === 'function') failureCallback(error);
            }
        },

        dateClick: (info) => {
            if (isReadOnly) {
                const userName = $('#admin-modal-title').text();
                showAdminSetStatusModal(info.dateStr, uid, userName);
            } else {
                showDayDetailModal(info.dateStr, uid);
            }
        },

        eventClick: (info) => {
            const startStr = info.event && info.event.startStr ? info.event.startStr : info.event.start.toISOString().slice(0, 10);
            if (isReadOnly) {
                const userName = $('#admin-modal-title').text();
                showAdminSetStatusModal(startStr, uid, userName);
            } else {
                showDayDetailModal(startStr, uid);
            }
        }
    });

    // save instance back to the correct variable
    if (isReadOnly) {
        adminDetailCalendar = calendarInstance;
    } else {
        fullCalendar = calendarInstance;
    }

    calendarInstance.render();
}

function showAdminSetStatusModal(dateStr, uid, userName) {
    const adminStatusModalEl = document.getElementById('adminSetStatusModal');
    // Get the existing modal instance or create a new one if it doesn't exist
    const adminStatusModal = bootstrap.Modal.getInstance(adminStatusModalEl) || new bootstrap.Modal(adminStatusModalEl);

    // Set modal title and hidden UID field
    $('#adminSetStatusModal .modal-title').text(`Set Status for ${userName}`);
    $('#admin-status-uid').val(uid);
    
    // Set the date to the one clicked on the calendar
    $('#admin-status-date').val(dateStr);

    // Clear any previously checked radio button
    $('input[name="admin-status"]').prop('checked', false);

    // Show the modal
    adminStatusModal.show();
}

function showContactModal(email, contact) {
    $('#modal-email-btn').attr('href', `mailto:${email}`);
    const callBtn = $('#modal-call-btn');
    if (contact && contact !== 'null') callBtn.attr('href', `tel:${contact}`).show();
    else callBtn.hide();
    contactModal.show();
}

async function getFilteredActivityData(uid, filter, type) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    let startDate = new Date(0);
    let endDate = new Date();

    const startStr = $(`#${type}-start-date`).val();
    const endStr = $(`#${type}-end-date`).val();

    switch (filter) {
        case 'yesterday':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 1);
            endDate = today;
            break;
        case 'last7':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 6);
            break;
        case 'last30':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 29);
            break;
        case 'custom':
            if (startStr) startDate = new Date(startStr);
            if (endStr) {
                endDate = new Date(endStr);
                endDate.setHours(23, 59, 59, 999);
            }
            break;
    }

    try {
        const [jobsSnapshot, dailyStatusSnapshot] = await Promise.all([
            db.collection("attendance").doc(uid).collection("entries")
            .where('entryTime', '>=', startDate.toISOString())
            .where('entryTime', '<=', endDate.toISOString())
            .get(),
            db.collection("daily_status").doc(uid).collection("entries")
            .where(firebase.firestore.FieldPath.documentId(), '>=', yyyymmdd(startDate))
            .where(firebase.firestore.FieldPath.documentId(), '<=', yyyymmdd(endDate))
            .get()
        ]);

        const activity = {
            site: new Set(),
            office: new Set(),
            leave: new Set()
        };

        jobsSnapshot.forEach(doc => {
            const job = doc.data();
            if (job.entryTime) activity.site.add(yyyymmdd(new Date(job.entryTime)));
        });

        dailyStatusSnapshot.forEach(doc => {
            const status = doc.data().status;
            const dateStr = doc.id;
            if (status === 'office') activity.office.add(dateStr);
            else if (status === 'leave') activity.leave.add(dateStr);
        });

        return activity;
    } catch (err) {
        console.error("Error fetching filtered activity data for chart:", err);
        return {
            site: new Set(),
            office: new Set(),
            leave: new Set()
        };
    }
}

async function renderUserActivityChart() {
    const ctx = document.getElementById('userActivityChart');
    const container = $("#activity-chart-container");
    const emptyState = $("#no-data-chart");
    const canvas = $('#userActivityChart');

    if (!ctx) return;

    const activity = await getFilteredActivityData(userUid, $('#stats-travel-filter-select').val(), 'stats-travel');

    const dataCounts = [activity.site.size, activity.office.size, activity.leave.size];
    const totalActivity = dataCounts.reduce((sum, count) => sum + count, 0);

    if (totalActivity === 0) {
        if (userActivityChart) userActivityChart.destroy();
        canvas.hide();
        emptyState.show();
        return;
    }

    canvas.show();
    emptyState.hide();

    let chartData;
    let options;

    const chartType = $('.chart-control-btn-no-line.active').data('chart-type') || 'doughnut';
    
    chartData = {
        labels: ['Site Visits', 'Office Days', 'On Leave'],
        datasets: [{
            label: 'Activity Count',
            data: dataCounts,
            backgroundColor: [
                getComputedStyle(document.documentElement).getPropertyValue('--success'),
                getComputedStyle(document.documentElement).getPropertyValue('--glow-color-2'),
                getComputedStyle(document.documentElement).getPropertyValue('--error')
            ],
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card-background'),
            hoverOffset: 4
        }]
    };
    
    options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
            legend: {
                display: true,
                position: 'bottom',
                labels: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                    font: {
                        family: 'Poppins, sans-serif'
                    }
                }
            },
            tooltip: {
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-background'),
                titleColor: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card-border'),
                borderWidth: 1,
                cornerRadius: 8,
                displayColors: true,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return `${label}: ${value} (${percentage}%)`;
                    }
                }
            }
        },
        animation: {
            animateScale: true,
            animateRotate: true
        }
    };

    if (chartType === 'line') {
        options.scales = {
            y: { 
                beginAtZero: true, 
                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } 
            },
            x: { 
                grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') } 
            }
        };
    }

    if (userActivityChart) userActivityChart.destroy();
    userActivityChart = new Chart(ctx, {
        type: chartType,
        data: chartData,
        options: options
    });
}

async function renderAdminSummaryStats() {
    const container = $("#admin-stats-container");
    container.html(getSpinnerHTML());

    const liveUsersRef = db.collection("live_locations");
    const attendanceRef = db.collection("attendance");
    const dailyStatusRef = db.collection("daily_status");
    const profilesRef = db.collection("profiles");

    const todayStr = yyyymmdd(new Date());

    container.html(`
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="admin-stat-value"><span id="admin-live-count">0</span></div>
                <div class="admin-stat-label">Live Employees</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="bi bi-geo-alt-fill"></i>
                </div>
                <div class="admin-stat-value"><span id="admin-site-visit-count">0</span></div>
                <div class="admin-stat-label">On-Site Today</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="bi bi-building"></i>
                </div>
                <div class="admin-stat-value"><span id="admin-office-count">0</span></div>
                <div class="admin-stat-label">In Office Today</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="admin-stat-value"><span id="admin-total-records">0</span></div>
                <div class="admin-stat-label">Total Records</div>
            </div>
        </div>
    `);

    const unsubscribeLive = liveUsersRef.onSnapshot(snap => {
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
        const activeCount = snap.docs.filter(doc => doc.data().timestamp >= fiveMinutesAgo).length;
        $('#admin-live-count').text(activeCount);
        applyAnimatedCardClass();
    });
    adminSummaryListeners.push(unsubscribeLive);

    const unsubscribeSite = profilesRef.onSnapshot(async profilesSnap => {
        let siteVisitCount = 0;
        for (const profileDoc of profilesSnap.docs) {
            const todayEntry = await attendanceRef.doc(profileDoc.id).collection('entries')
                .where('entryTime', '>=', new Date(todayStr).toISOString())
                .limit(1)
                .get();
            if (!todayEntry.empty) {
                siteVisitCount++;
            }
        }
        $('#admin-site-visit-count').text(siteVisitCount);
        applyAnimatedCardClass();
    });
    adminSummaryListeners.push(unsubscribeSite);

    const unsubscribeOffice = profilesRef.onSnapshot(async profilesSnap => {
        let officeCount = 0;
        for (const profileDoc of profilesSnap.docs) {
            const statusDoc = await dailyStatusRef.doc(profileDoc.id).collection('entries').doc(todayStr).get();
            if (statusDoc.exists && statusDoc.data().status === 'office') {
                officeCount++;
            }
        }
        $('#admin-office-count').text(officeCount);
        applyAnimatedCardClass();
    });
    adminSummaryListeners.push(unsubscribeOffice);

    const unsubscribeTotal = attendanceRef.onSnapshot(async snap => {
        let totalRecords = 0;
        for (const doc of snap.docs) {
            const userEntries = await attendanceRef.doc(doc.id).collection('entries').get();
            totalRecords += userEntries.size;
        }
        $('#admin-total-records').text(totalRecords);
        applyAnimatedCardClass();
    });
    adminSummaryListeners.push(unsubscribeTotal);
}

async function renderTopPerformingUsers() {
    const container = $('#top-performing-users-list');
    container.html(getSpinnerHTML());

    try {
        const usersSnapshot = await db.collection("profiles").get();
        const users = usersSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));

        const userPerformance = [];
        const currentYear = new Date().getFullYear();
        const startOfYear = new Date(currentYear, 0, 1);

        for (const user of users) {
            const jobsSnapshot = await db.collection("attendance").doc(user.uid).collection("entries")
                .where('entryTime', '>=', startOfYear.toISOString()).get();
            
            const jobs = jobsSnapshot.docs.map(doc => doc.data());
            const totalVisits = jobs.length;
            const completedVisits = jobs.filter(job => job.status === 'completed').length;
            
            const dailyStatusSnapshot = await db.collection("daily_status").doc(user.uid).collection("entries")
                .where(firebase.firestore.FieldPath.documentId(), '>=', yyyymmdd(startOfYear)).get();
            
            const officeDays = dailyStatusSnapshot.docs.filter(doc => doc.data().status === 'office').length;
            const totalWorkingDays = totalVisits + officeDays;
            
            userPerformance.push({
                ...user, // Pass the full user object
                totalWorkingDays,
                completedVisits,
                completionRate: totalVisits > 0 ? (completedVisits / totalVisits * 100) : 0
            });
        }

        userPerformance.sort((a, b) => b.totalWorkingDays - a.totalWorkingDays);
        const topEmployees = userPerformance.slice(0, 5);
        
        if (topEmployees.length === 0) {
            container.html(`<div class="empty-state"><i class="bi bi-trophy-fill empty-state-icon"></i><h5>No employee data yet</h5><p>Employee performance data will appear here</p></div>`);
            return;
        }
        
        container.html('<div class="top-performing-users-grid"></div>');
        
        topEmployees.forEach((employee, index) => {
            const rank = index + 1;
            const badgeClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
            
            // --- NEW, SIMPLIFIED AVATAR LOGIC ---
            let avatarHtml;
            if (employee.profilePhoto) {
                // If a profile photo URL exists in Firestore, use it.
                avatarHtml = `<img src="${employee.profilePhoto}" alt="${escape(employee.fullname)}">`;
            } else {
                // Otherwise, fall back to showing the user's initials.
                const initials = getInitials(employee.fullname || employee.email);
                avatarHtml = `<div class="profile-avatar-initials">${initials}</div>`;
                                    }
            // --- END NEW LOGIC ---

            const employeeCard = $(`
                <div class="top-performing-user-card fade-in-up" style="animation-delay: ${index * 0.1}s;">
                    <div class="top-performing-user-avatar">
                        ${avatarHtml}
                        <div class="top-performing-user-rank ${badgeClass}">${rank}</div>
                    </div>
                    <div class="top-performing-user-name" title="${escape(employee.fullname || '')}">${escape(employee.fullname || 'Unknown User')}</div>
                    <div class="top-performing-user-email" title="${escape(employee.email || '')}">${escape(employee.email || '')}</div>
                    <div class="top-performing-user-stats">
                        <div class="top-performing-user-stat-row">
                            <span class="top-performing-user-stat-label">Working Days:</span>
                            <span class="top-performing-user-stat-value">${employee.totalWorkingDays}</span>
                        </div>
                        <div class="top-performing-user-stat-row">
                            <span class="top-performing-user-stat-label">Completion:</span>
                            <span class="top-performing-user-stat-value">${employee.completionRate.toFixed(0)}%</span>
                        </div>
                    </div>
                    <div class="top-performing-user-progress">
                        <div class="progress-bar-custom">
                            <div class="progress-fill" style="width: ${employee.completionRate}%"></div>
                        </div>
                    </div>
                    <div class="top-performing-user-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="handleAdminSingleUserView('${employee.uid}')">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </div>
                </div>`);
            
            container.find('.top-performing-users-grid').append(employeeCard);
        });
    } catch (err) {
        console.error("Failed to load top employees data.", err);
        container.html('<p class="text-danger text-center">Failed to load top employees data.</p>');
    }
}

// Helper function to get initials from a name
function getInitials(name) {
    if (!name) return '?';
    // Splits name by space, takes the first letter of each part, joins them, and converts to uppercase.
    return name.split(' ').map(n => n[0]).join('').toUpperCase();
}

// Initialize admin analytics charts
async function initializeAdminAnalyticsCharts() {
    try {
        // --- Data Fetching and Processing (omitted for brevity, assume data is ready) ---
        const sevenMonthsAgo = new Date();
        sevenMonthsAgo.setMonth(sevenMonthsAgo.getMonth() - 7);
        
        const allProfilesSnapshot = await db.collection("profiles").get();
        const allUserIds = allProfilesSnapshot.docs.map(doc => doc.id);

        const monthlyAttendance = {};
        let totalDistance = 0;
        let totalCompleted = 0;
        let totalPending = 0;

        for (const userId of allUserIds) {
            const userProfile = await Firestore.getProfile(userId);
            const homeCoords = userProfile.homeLocation?.coords;

            const jobsSnapshot = await db.collection("attendance").doc(userId).collection("entries")
                .where('entryTime', '>=', sevenMonthsAgo.toISOString()).get();

            jobsSnapshot.forEach(doc => {
                const job = doc.data();
                if (!job.entryTime) return;

                const date = new Date(job.entryTime);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                monthlyAttendance[monthKey] = (monthlyAttendance[monthKey] || 0) + 1;

                if (job.status === 'completed') {
                    totalCompleted++;
                } else {
                    totalPending++;
                }

                if (homeCoords && job.coords) {
                    totalDistance += getDistanceKm(homeCoords, job.coords) * 2;
                }
            });
        }
        
        // --- Setup Chart Colors for Dark Theme ---
        const primaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
        const secondaryTextColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
        const cardBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--card-border').trim();
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--glow-color-2').trim();

        // --- Chart 1: Attendance Trends (Line Chart with Gradient and Light Text) ---
        const attendanceCtx = document.getElementById('attendance-trends-chart').getContext('2d');
        const last7Months = Array.from({ length: 7 }, (_, i) => {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        }).reverse();
        
        const attendanceData = last7Months.map(month => monthlyAttendance[month] || 0);

        const attendanceGradient = attendanceCtx.createLinearGradient(0, 0, 0, 200);
        attendanceGradient.addColorStop(0, 'rgba(67, 191, 255, 0.4)');
        attendanceGradient.addColorStop(1, 'rgba(76, 104, 255, 0.1)');

        // Destroy previous chart instance if it exists
        if (window.attendanceTrendsChart instanceof Chart) {
            window.attendanceTrendsChart.destroy();
        }
        window.attendanceTrendsChart = new Chart(attendanceCtx, {
            type: 'line',
            data: {
                labels: last7Months.map(m => new Date(m + '-02').toLocaleString('default', { month: 'short' })),
                datasets: [{
                    label: 'Total Visits',
                    data: attendanceData,
                    borderColor: accentColor, // Use accent color for line
                    backgroundColor: attendanceGradient,
                    pointBackgroundColor: accentColor,
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'var(--card-background)',
                        titleColor: primaryTextColor,
                        bodyColor: secondaryTextColor,
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        // Set grid line color to match border color for subtlety
                        grid: { color: cardBorderColor }, 
                        // Set tick color to secondary text color
                        ticks: { color: secondaryTextColor } 
                    },
                    x: { 
                        // Set grid line color to transparent or very faint for cleaner look
                        grid: { color: 'transparent' }, 
                        // Set tick color to secondary text color
                        ticks: { color: secondaryTextColor } 
                    }
                }
            }
        });
        
        // --- Chart 2: Productivity Metrics (Doughnut Chart with Light Text) ---
        const productivityCtx = document.getElementById('productivity-metrics-chart').getContext('2d');
        
        // Destroy previous chart instance if it exists
        if (window.productivityMetricsChart instanceof Chart) {
            window.productivityMetricsChart.destroy();
        }
        window.productivityMetricsChart = new Chart(productivityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Pending Exit'],
                datasets: [{
                    data: [totalCompleted, totalPending],
                    backgroundColor: [ 'rgba(39, 174, 96, 0.8)', 'rgba(243, 156, 18, 0.8)' ],
                    borderColor: 'var(--card-background)',
                    borderWidth: 4,
                    hoverOffset: 8,
                    hoverBackgroundColor: [ 'var(--success)', 'var(--warning)' ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            // Corrected to use secondary text color for visibility
                            color: secondaryTextColor, 
                            padding: 20,
                            font: { size: 14 }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'var(--card-background)',
                        titleColor: primaryTextColor,
                        bodyColor: secondaryTextColor,
                    }
                }
            }
        });

        // --- Chart 3: Travel Patterns (No chart, just a number display) ---
        const travelChartContainer = document.getElementById('travel-patterns-chart').parentElement;
        travelChartContainer.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center">
                <div style="font-size: 2.5rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    ${Math.round(totalDistance).toLocaleString()} km
                </div>
                <div style="color: var(--text-secondary);">Total Distance Traveled (Last 7 Months)</div>
            </div>
        `;

    } catch (error) {
        console.error("Failed to initialize admin analytics charts:", error);
    }
}

// Admin roles management functions
async function renderAdminRolesList() {
    const rolesList = $('#admin-roles-list');
    rolesList.empty();
    
    // Get user roles from Firestore or use default roles
    try {
        const rolesDoc = await db.collection("settings").doc("roles").get();
        if (rolesDoc.exists) {
            userRoles = rolesDoc.data().roles || userRoles;
        }
    } catch (err) {
        console.error("Error fetching roles:", err);
    }
    
    // Render roles
    userRoles.forEach(role => {
    const roleItem = $(`
        <div class="admin-role-item" data-role="${role}">
            <span class="admin-role-name">${role}</span>
            <div class="admin-role-actions">
                <button class="admin-role-action-btn" title="Edit Role">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="admin-role-action-btn" title="Delete Role">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `);
    rolesList.append(roleItem);
});
}

async function addNewRole(roleName) {
    if (!roleName.trim()) {
        showToast("Role name cannot be empty", "warning");
        return;
    }
    
    if (userRoles.includes(roleName)) {
        showToast("Role already exists", "warning");
        return;
    }
    
    try {
        // Add to local array
        userRoles.push(roleName);
        
        // Save to Firestore
        await db.collection("settings").doc("roles").set({
            roles: userRoles
        });
        
        // Re-render roles list
        renderAdminRolesList();
        
        showToast(`Role "${roleName}" added successfully`, "success");
    } catch (err) {
        console.error("Error adding role:", err);
        showToast("Failed to add role", "danger");
    }
}

async function deleteRole(roleName, roleItem) {
    try {
        // Remove from local array
        userRoles = userRoles.filter(role => role !== roleName);
        
        // Save to Firestore
        await db.collection("settings").doc("roles").set({
            roles: userRoles
        });
        
        // Remove from UI with animation
        gsap.to(roleItem, {
            opacity: 0,
            height: 0,
            margin: 0,
            padding: 0,
            duration: 0.3,
            onComplete: () => roleItem.remove()
        });
        
        showToast(`Role "${roleName}" deleted successfully`, "success");
    } catch (err) {
        console.error("Error deleting role:", err);
        showToast("Failed to delete role", "danger");
    }
}

async function editRole(oldRoleName, roleItem) {
    const newRoleName = prompt("Edit role name:", oldRoleName);
    
    if (!newRoleName || newRoleName.trim() === "") {
        return;
    }
    
    if (newRoleName === oldRoleName) {
        return;
    }
    
    if (userRoles.includes(newRoleName)) {
        showToast("Role already exists", "warning");
        return;
    }
    
    try {
        // Update local array
        const index = userRoles.indexOf(oldRoleName);
        if (index !== -1) {
            userRoles[index] = newRoleName;
        }
        
        // Save to Firestore
        await db.collection("settings").doc("roles").set({
            roles: userRoles
        });
        
        // Update UI
        roleItem.find('.admin-role-name').text(newRoleName);
        // Update the data-role attribute as well so it can be edited again
        roleItem.data('role', newRoleName);
        
        showToast(`Role renamed from "${oldRoleName}" to "${newRoleName}"`, "success");
    } catch (err) {
        console.error("Error editing role:", err);
        showToast("Failed to edit role", "danger");
    }
}

// Enhanced location search functionality (Mock - Correct as-is)
async function performLocationSearch(query) {
    const searchResults = document.getElementById('search-results');
    
    if (!query || query.length < 2) {
        searchResults.innerHTML = `
            <div class="text-center text-secondary p-4">
                <i class="bi bi-search fs-1 mb-3"></i>
                <p>Type at least 2 characters to search</p>
            </div>
        `;
        return;
    }

    try {
        // Simulate API call to Google Places
        // In a real implementation, you would use the Google Places API
        const mockResults = [
            {
                name: "Bureau Veritas Kolkata",
                address: "Salt Lake City, Kolkata, West Bengal",
                distance: "2.5 km"
            },
            {
                name: "Project Alpha Site",
                address: "Sector V, Salt Lake, Kolkata, West Bengal",
                distance: "5.8 km"
            },
            {
                name: "Tech Park",
                address: "Rajarhat, Kolkata, West Bengal",
                distance: "8.2 km"
            },
            {
                name: "Industrial Complex",
                address: "Howrah, Kolkata, West Bengal",
                distance: "12.4 km"
            }
        ];

        // Filter results based on query
        const filteredResults = mockResults.filter(result => 
            result.name.toLowerCase().includes(query.toLowerCase()) ||
            result.address.toLowerCase().includes(query.toLowerCase())
        );

        if (filteredResults.length === 0) {
            searchResults.innerHTML = `
                <div class="text-center text-secondary p-4">
                    <i class="bi bi-geo-alt fs-1 mb-3"></i>
                    <p>No locations found matching "${query}"</p>
                </div>
            `;
            return;
        }

        // Display results
        searchResults.innerHTML = '';
        filteredResults.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerHTML = `
                <div class="search-result-item-title">${result.name}</div>
                <div class="search-result-item-address">${result.address}</div>
                <div class="search-result-item-distance">${result.distance} away</div>
            `;
            
            resultItem.addEventListener('click', () => {
                // In a real implementation, you would use the Google Places API to get the place details
                selectedPlace = {
                    name: result.name,
                    formatted_address: result.address,
                    geometry: {
                        location: {
                            lat: 22.5746 + (Math.random() - 0.5) * 0.1,
                            lng: 88.4313 + (Math.random() - 0.5) * 0.1
                        }
                    }
                };
                
                // Close the modal
                document.getElementById('search-modal').style.display = 'none';
                
                // Update the map
                if (siteMarker) siteMarker.map = null;
                siteMarker = new AdvancedMarkerElement({
                    map,
                    position: selectedPlace.geometry.location.toJSON()
                });
                map.panTo(selectedPlace.geometry.location);
                map.setZoom(16);
                
                // Update the search input
                document.getElementById('site-search-input').value = result.name;
                
                showToast(`Selected: ${result.name}`, 'success');
            });
            
            searchResults.appendChild(resultItem);
        });
    } catch (error) {
        console.error('Error searching for locations:', error);
        searchResults.innerHTML = `
            <div class="text-center text-danger p-4">
                <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                <p>Error searching for locations</p>
            </div>
        `;
    }
}

// Initialize search modal functionality
$(document).ready(function() {
    // Search modal functionality
    $('.search-modal-close').on('click', function() {
        $('#search-modal').fadeOut(200);
    });
    
    $('#modal-search-input').on('input', function() {
        const query = $(this).val();
        performLocationSearch(query);
    });
    
    $('.search-clear').on('click', function() {
        $(this).siblings('.search-input').val('').focus();
    });
    
    // Set status button functionality
    $(document).on('click', '.set-status-btn', function() {
        const uid = $(this).data('uid');
        const userName = $(this).data('name');
        const today = new Date().toISOString().split('T')[0];
        showAdminSetStatusModal(today, uid, userName);
    });
    
    // Show admin home location modal
    window.showAdminHomeLocationModal = function(uid) {
        const modal = new bootstrap.Modal(document.getElementById('adminHomeLocationModal'));
        modal.show();
        
        // Initialize map if not already initialized
        if (!window.adminHomeMap) {
            setTimeout(() => {
                const mapDiv = document.getElementById('admin-home-map');
                if (mapDiv && google) {
                    window.adminHomeMap = new google.maps.Map(mapDiv, {
                        center: BUREAU_VERITAS_KOLKATA,
                        zoom: 12,
                        mapId: 'ADMIN_HOME_MAP',
                        backgroundColor: '#0b0c10',
                        gestureHandling: "greedy",
                        streetViewControl: false,
                        mapTypeControl: false,
                        disableDefaultUI: true
                    });
                }
            }, 500);
        }
    };
    
    // Delete admin issue function
    window.deleteAdminIssue = deleteAdminIssue;
    
    // Show contact modal function
    window.showContactModal = showContactModal;

    // --- CORRECTION STARTS HERE ---
    // Added event listeners for Role Management

    // Listener for the "Add Role" button
    $('#add-role-btn').on('click', function() {
        const newRoleInput = $('#new-role-input');
        const newRoleName = newRoleInput.val();
        addNewRole(newRoleName);
        newRoleInput.val(''); // Clear the input after adding
    });

    // Event listeners for "Edit" and "Delete" buttons (using event delegation)
    // We attach to the static parent '#admin-roles-list'
    $('#admin-roles-list').on('click', '.admin-role-action-btn', function() {
        const button = $(this);
        const roleItem = button.closest('.admin-role-item');
        const roleName = roleItem.data('role');
        
        if (button.attr('title') === 'Edit Role') {
            // Call your existing editRole function
            editRole(roleName, roleItem);
        } else if (button.attr('title') === 'Delete Role') {
            // Add confirmation before deleting
            if (confirm(`Are you sure you want to delete the role "${roleName}"?`)) {
                // Call your existing deleteRole function
                deleteRole(roleName, roleItem);
            }
        }
    });
    $('#admin').on('click', '.collapsible-header', function() {
        const section = $(this).closest('.collapsible-section');
        section.toggleClass('active');
        
        // This is a small fix to resize the map *after* the animation
        // in case the user opens the "Live Employee Map" section.
        if (section.hasClass('active')) {
            setTimeout(() => {
                if (adminLiveMap && $('#admin-live-map').is(':visible')) {
                    google.maps.event.trigger(adminLiveMap, 'resize');
                }
            }, 300); // 300ms matches your CSS transition
        }
    });

    /**
     * 2. Listener for tabs inside the admin user detail modal
     * This makes the "Records" and "Calendar" tabs switchable
     * inside the user popup.
     */
    $('#adminUserDetailsModal').on('click', '.admin-modal-tab', function() {
        if ($(this).hasClass('active')) {
            return; // Don't do anything if it's already active
        }

        const modal = $(this).closest('.modal-content');
        
        // 1. Remove 'active' from all tabs and content
        modal.find('.admin-modal-tab').removeClass('active');
        modal.find('.admin-modal-tab-content').removeClass('active');

        // 2. Add 'active' to the tab you clicked and its content
        $(this).addClass('active');
        const targetContentId = '#' + $(this).data('tab') + '-tab-content';
        $(targetContentId).addClass('active');

        // 3. If switching to the calendar, we must initialize it
        if ($(this).data('tab') === 'calendar') {
            const uid = $('#admin-modal-title').data('uid');
            if (uid) {
                // Initialize the calendar in read-only mode
                initializeFullCalendar(uid, 'admin-modal-calendar', true);
            }
        }
    });
    // --- CORRECTION ENDS HERE ---
    
});
        </script>
    </body>
    </html>
