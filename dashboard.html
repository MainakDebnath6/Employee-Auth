<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Dashboard â€“ Engineer Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <!-- Vanilla Calendar CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.css"/>
  
  <!-- jQuery and GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <!-- Vanilla Calendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro/build/vanilla-calendar.min.js"></script>
  
  <!-- Google Maps + Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA97qnWyZu_Id_BCQhWvwOhm6qxn0TPty8&libraries=places"></script>
  
  <style>
    /* Reset and base */
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(120deg, #191d25 0%, #222834 100%);
      color: #d1d4dc;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      user-select: none;
    }
    .container {
      max-width: 1140px;
      margin: 1.8rem auto 2rem;
      background: rgba(30, 34, 44, 0.85);
      border-radius: 22px;
      padding: 2rem 2.2rem 2.5rem 2.2rem;
      box-shadow: 0 24px 50px #0a2d641a, inset 0 0 42px #12253a;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      padding-bottom: 1.2rem;
      border-bottom: 1.2px solid #34405a66;
      flex-wrap: wrap;
      user-select: none;
    }
    .logo-small {
      width: 95px;
      filter: grayscale(85%) brightness(1.1);
      pointer-events: none;
      user-select: none;
    }
    #user-name {
      font-weight: 700;
      font-size: clamp(1rem, 2vw, 1.38rem);
      color: #acc3ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
      user-select: text;
    }
    #logout {
      background: #2b3246;
      color: #adb7d6;
      border-radius: 22px;
      min-width: 105px;
      height: 44px;
      border: none;
      font-weight: 700;
      font-size: 1.02rem;
      transition: background-color 0.3s ease;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 8px #223765 inset;
    }
    #logout:hover, #logout:focus {
      background: #465a8d;
      color: #e7f0ff;
      outline: none;
      box-shadow: 0 0 22px #5476dc inset;
    }

    .calendar-popup-toggle {
      text-align: center;
      margin-bottom: 1.6rem;
    }
    #open-calendar-btn {
      background: linear-gradient(120deg, #2e3c6f 0%, #5a78e0 100%);
      color: #dce6ff;
      border: none;
      border-radius: 26px;
      font-weight: 700;
      font-size: 1.15rem;
      padding: 0.52rem 2.1rem;
      cursor: pointer;
      box-shadow: 0 7px 20px #4d65d8c9;
      transition: background 0.33s ease, color 0.3s ease;
      user-select: none;
    }
    #open-calendar-btn:hover, #open-calendar-btn:focus {
      background: linear-gradient(120deg, #4d5bbe 0%, #7083e3 95%);
      outline-offset: 2px;
    }
    #calendar-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(11, 16, 32, 0.87);
      z-index: 10000;
      -webkit-tap-highlight-color: transparent;
    }
    #calendar-modal-window {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #252c48;
      padding: 1.7rem 1.4rem;
      border-radius: 20px;
      box-shadow: 0 24px 44px #08103fbb;
      max-width: 360px;
      max-height: 90vh;
      overflow-y: auto;
      color: #ccd5ff;
    }
    #close-calendar-btn {
      float: right;
      font-size: 1.75rem;
      color: #aabbee;
      background: transparent;
      border: none;
      cursor: pointer;
      font-weight: 700;
      margin-bottom: 10px;
      padding: 0;
      user-select: none;
      transition: color 0.2s ease;
    }
    #close-calendar-btn:hover, #close-calendar-btn:focus {
      color: #e7eaff;
      outline: none;
    }
    #my-calendar {
      width: 100%;
      border-radius: 14px;
    }
    .vanilla-calendar-day__btn.has-entry {
      background: #7a95ff !important;
      color: #fff !important;
      border-radius: 50% !important;
      box-shadow: 0 0 10px #5b78ffbb !important;
    }

    /* Attendance Cards Container */
    #attendance-cards {
      overflow-y: auto;
      max-height: 395px;
      padding-right: 6px;
      margin-bottom: 1.4rem;
      user-select: none;
      outline: none;
    }
    #attendance-cards::-webkit-scrollbar {
      width: 7px;
    }
    #attendance-cards::-webkit-scrollbar-thumb {
      background: #506aa5cc;
      border-radius: 5px;
    }
    #attendance-cards::-webkit-scrollbar-track {
      background: transparent;
    }

    /* Attendance Cards Styling */
    .attendance-card {
      background: linear-gradient(115deg, #2b3043 0%, #232838 100%);
      border-radius: 16px;
      margin-bottom: 0.8rem;
      box-shadow: 0 3px 14px #101721cc inset;
      cursor: pointer;
      color: #bbc4dc;
      transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.18s ease;
      overflow: hidden;
      user-select: none;
      outline-offset: 3px;
      outline: none;
      box-sizing: border-box;
      padding: 0.72rem 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 0.28rem;
      max-width: 100%;
    }
    .attendance-card:hover, .attendance-card:focus {
      background: linear-gradient(120deg, #3f4f9f, #2b3059);
      box-shadow: 0 0 18px #5b7fffaa inset;
      transform: scale(1.01);
      color: #e1e7ff;
      outline: none;
    }
    .attendance-card.expanded {
      padding: 1.1rem 1.5rem 1.5rem 1.5rem;
      box-shadow: 0 8px 30px #3f51eccc inset;
      background: linear-gradient(140deg,#3d4b81 12%,#506abfcc 80%);
      color: #e4eaff;
    }

    .card-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .card-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: nowrap;
      min-width: 0;
      flex-grow: 1;
    }
    .status-dot {
      width: 14px; height: 14px;
      border-radius: 50%;
      box-shadow: 0 0 7px #344159cc inset;
      flex-shrink: 0;
    }
    .status-dot.completed { background: #69e07b; }
    .status-dot.pending { background: #f1da65; }
    .card-place {
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: 0.03em;
      color: #aec4ff;
      user-select: text;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      flex-grow: 1;
    }
    .card-date {
      font-size: 0.92rem;
      opacity: 0.72;
      font-weight: 600;
      min-width: 104px;
      text-align: right;
      user-select: none;
      flex-shrink: 0;
    }
    .expand-arrow {
      font-size: 1.25rem;
      user-select: none;
      color: #789cffcc;
      margin-left: 10px;
      transition: transform 0.33s ease;
      flex-shrink: 0;
      align-self: center;
    }
    .attendance-card.expanded .expand-arrow {
      transform: rotate(90deg);
      color: #b1bffe;
    }
    .card-details {
      margin-top: 12px;
      display: none;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .attendance-card.expanded > .card-details {
      display: flex;
      user-select: none;
      animation: fadeInSlideUp 0.28s ease forwards;
    }
    @keyframes fadeInSlideUp {
      0% {opacity: 0; transform: translateY(5px);}
      100% {opacity: 1; transform: translateY(0);}
    }
    .photo-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 95px;
      user-select: none;
    }
    .photo-column img {
      width: 85px;
      height: 85px;
      border-radius: 14px;
      object-fit: cover;
      border: 2px solid #5678cdaa;
      box-shadow: 0 0 16px #4a68b5cc;
      background: #1b1f2c;
      pointer-events: none;
      user-select: none;
    }
    .photo-label {
      font-size: 0.84rem;
      font-weight: 700;
      color: #c3d0ffcc;
      user-select: none;
    }
    .time-details {
      flex: 1;
      font-size: 0.93rem;
      color: #bec7e6;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 7px;
      user-select: text;
      min-width: 0;
    }
    .time-details span {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    .time-label {
      font-weight: 700;
      width: 70px;
      color: #a3b1fcbb;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      flex-shrink: 0;
    }

    #map-wrapper {
      position: relative;
      width: 100%;
      height: 360px;
      margin: 0 auto 1.3rem auto;
      border-radius: 18px;
      box-shadow: 0 14px 40px #0e1a402e inset;
      border: 2px solid #38446c90;
      background: #1a2030;
      user-select: none;
    }
    #pac-input {
      position: absolute;
      top: 26px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 520px;
      padding: 0.7rem 1.4rem;
      border-radius: 12px;
      border: 1.7px solid #4673c5;
      background: #2c3d7e;
      color: #d9e2ff;
      font-size: 1.15rem;
      z-index: 10;
      outline-offset: 3px;
      transition: all 0.28s ease;
      user-select: text;
    }
    #pac-input::placeholder {
      color: #aac2ffbb;
    }
    #pac-input:focus {
      border-color: #85a7ff;
      box-shadow: 0 0 28px #95afffff inset;
      background: #2f42a8;
      color: #f0f4ff;
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      user-select: none;
    }

    .btn, #checkin-btn, #checkout-btn {
      border-radius: 24px;
      font-weight: 700;
      font-size: 1.12rem;
      padding: 0.58rem 2.4rem;
      margin: 0.28rem 0.18rem;
      background: linear-gradient(110deg, #3657aa, #5a7dd7);
      color: #e8ebff !important;
      border: none;
      box-shadow: 0 5px 15px #375cbdcc;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.22s ease;
      user-select: none;
      min-width: 140px;
    }
    .btn:hover, #checkin-btn:hover, #checkout-btn:hover {
      background: linear-gradient(110deg, #4d6fcf, #7b98ff);
      transform: scale(1.06);
      color: #f6f7ff !important;
    }
    .btn:focus, #checkin-btn:focus, #checkout-btn:focus {
      outline-offset: 3px;
      outline: 3px solid #aac8ffcc;
    }
    #action-alert {
      font-weight: 600;
      min-height: 34px;
      border-radius: 14px;
      background: #313c6e22;
      border: 2.4px solid #6779bfaa;
      color: #ccd2e9;
      box-shadow: 0 0 16px #5067bb55 inset;
      margin-top: 1.4rem;
      padding: 0.34rem 1.2rem;
      text-align: center;
      opacity: 0;
      transition: opacity 0.45s ease;
      user-select: none;
      max-width: 98vw;
      overflow-wrap: break-word;
      white-space: normal;
    }
    #action-alert.show {
      opacity: 1;
    }
    #camera-section {
      display: none;
      margin-top: 1.8rem;
      text-align: center;
      background: linear-gradient(130deg, #2e366bbb 75%, #3a4482ee 100%);
      border-radius: 24px;
      padding: 1.1rem 1.3rem 2.2rem 1.3rem;
      box-shadow: 0 8px 38px #11274aaa inset;
      user-select: none;
    }
    #video, #photo-preview {
      width: 96vw;
      max-width: 435px;
      max-height: 280px;
      object-fit: cover;
      border-radius: 24px;
      box-shadow: 0 1px 16px #3f5aabcc;
      margin-top: 18px;
      background: #191c3d;
      user-select: none;
      pointer-events: none;
    }
    #snap-btn, #flip-btn {
      border-radius: 28px;
      font-weight: 700;
      font-size: 1.07rem;
      border: none;
      padding: 0.6rem 2.4rem;
      cursor: pointer;
      margin-top: 22px;
      user-select: none;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 14px #3f5affcc;
      color: #f0f4ff;
      background: linear-gradient(120deg, #4164bf, #304995);
      letter-spacing: 0.04em;
    }
    #flip-btn {
      background: linear-gradient(120deg, #5b6e9d, #384e8c);
      margin-left: 16px;
      vertical-align: middle;
    }
    #snap-btn:hover, #flip-btn:hover,
    #snap-btn:focus, #flip-btn:focus {
      outline: none;
      background: linear-gradient(120deg, #4d65e2, #5ea0ff);
      box-shadow: 0 0 26px #5378f7dd;
    }
    footer {
      text-align: center;
      font-size: 0.9rem;
      color: #7180b5cc;
      padding: 1rem 1rem 1.4rem 1rem;
      border-top: 1.8px solid #293650cc;
      user-select: none;
      font-weight: 500;
      letter-spacing: 0.03em;
    }

    /* Responsive */
    @media (max-width: 720px) {
      .container {
        padding: 1.8rem 1.2rem 2rem 1.2rem;
      }
      header {
        gap: 12px;
        padding-bottom: 1rem;
      }
      .logo-small {
        width: 70px;
      }
      #user-name {
        font-size: 1.1rem;
      }
      #attendance-cards {
        max-height: 310px;
      }
      #map-wrapper {
        height: 280px;
      }
    }
    @media (max-width: 420px) {
      #pac-input {
        width: 90%;
        font-size: 1.05rem;
      }
      .btn, #checkin-btn, #checkout-btn {
        padding: 0.48rem 1.45rem;
        font-size: 1rem;
        min-width: 120px;
        margin: 0.2rem 0.3rem;
      }
      #user-name {
        font-size: 1rem;
      }
      .card-place {
        max-width: 160px;
      }
    }
  </style>
</head>
<body>

  <div class="container" role="main" aria-label="Engineer Attendance Dashboard">

    <header>
      <img src="./Bureau_Veritas.svg.png" alt="Bureau Veritas grey logo" class="logo-small" draggable="false" />
      <span id="user-name" aria-live="polite" aria-atomic="true" role="text">Welcome, User</span>
      <button id="logout" aria-label="Logout button" title="Logout">Logout</button>
    </header>

    <div class="calendar-popup-toggle">
      <button id="open-calendar-btn" class="btn" aria-haspopup="dialog" aria-controls="calendar-modal-window" aria-expanded="false" type="button">&#128197; Show Calendar</button>
    </div>
    <div id="calendar-modal-overlay" tabindex="-1" aria-modal="true" role="dialog" aria-label="Attendance calendar">
      <div id="calendar-modal-window">
        <button id="close-calendar-btn" aria-label="Close calendar" title="Close">&times;</button>
        <div id="my-calendar"></div>
      </div>
    </div>

    <section id="attendance-cards" aria-live="polite" aria-atomic="true" tabindex="0" aria-label="Attendance records list">
      <p style="text-align:center; color:#7a8bca99; margin-top: 0.7rem; user-select:none;">No attendance records found.</p>
    </section>

    <hr style="border-color: #3c4468; margin: 0 0 1.4rem 0;" />

    <section id="job-details" aria-label="Attendance site selection">
      <label for="pac-input" class="form-label fw-bold" style="color:#91a7ff; font-weight:700; font-size:1.06rem;">Search Site Address or Place</label>
      <div id="map-wrapper">
        <input id="pac-input" type="text" autocomplete="off" placeholder="Search site address or place" aria-label="Search site address or place" spellcheck="false" />
        <div id="map" role="region" aria-label="Google Map showing selected site"></div>
      </div>

      <div class="d-flex flex-wrap justify-content-center gap-3 mt-4">
        <button id="checkin-btn" class="btn" aria-label="Mark entry">Mark Entry</button>
        <button id="checkout-btn" class="btn" aria-label="Mark exit">Mark Exit</button>
      </div>

      <div id="action-alert" class="alert d-none" role="alert"></div>
    </section>

    <section id="camera-section" aria-live="polite" aria-label="Camera capture section">
      <video id="video" autoplay playsinline aria-label="Camera preview"></video>
      <div style="margin-top:12px;">
        <button id="flip-btn" aria-label="Flip Camera">&#x21bb; Flip Camera</button>
        <button id="snap-btn" aria-label="Capture Photo">Capture Photo</button>
      </div>
      <canvas id="canvas" style="display:none;"></canvas>
      <img id="photo-preview" alt="Captured photo preview" />
    </section>

  </div>

  <footer>Created by Mainak Debnath &amp; Arjak Ghosh</footer>

  <script>
    if (!sessionStorage.getItem("googleEmail")) {
      window.location.href = "login.html";
    }

    const userEmail = sessionStorage.getItem("googleEmail") || '';
    document.getElementById("user-name").textContent = `Welcome, ${sessionStorage.getItem("googleName") || "User"}`;

    document.getElementById("logout").addEventListener("click", () => {
      sessionStorage.clear();
      localStorage.removeItem("attendance_jobs__" + userEmail);
      window.location.href = "login.html";
    });

    function getJobs() {
      try {
        const data = localStorage.getItem("attendance_jobs__" + userEmail);
        if (!data) return [];
        return JSON.parse(data);
      } catch {
        return [];
      }
    }
    function setJobs(jobs) {
      localStorage.setItem("attendance_jobs__" + userEmail, JSON.stringify(jobs));
    }

    let jobs = getJobs();
    let selectedPlace = null, map, marker;
    let userLat = null, userLng = null, userLiveMarker = null, userAccuracyCircle = null, hasCenteredToUser = false;
    let selectedDateISO = null;
    let entryPhoto = "", exitPhoto = "", entryTime = "", exitTime = "";

    gsap.from("header", {duration: 1, y: -32, opacity: 0, ease: "power3.out"});
    gsap.from("#job-details", {duration: 1, delay: 0.35, y: 20, opacity: 0, ease: "power3.out"});

    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    function showAlert(msg, isError = false) {
      const alertBox = document.getElementById("action-alert");
      alertBox.classList.remove("d-none", "alert-info", "alert-danger");
      alertBox.classList.add(isError ? "alert-danger" : "alert-info");
      alertBox.textContent = msg;
      gsap.to(alertBox, {opacity: 1, duration: 0.5});
      alertBox.classList.add("show");
      clearTimeout(showAlert.timeout);
      showAlert.timeout = setTimeout(() => {
        gsap.to(alertBox, {opacity: 0, duration: 0.5, onComplete: () => alertBox.classList.add("d-none")});
      }, msg ? 4000 : 1300);
    }
    function jobDates() {
      return [...new Set(jobs.map(j => new Date(j.entryTime).toISOString().slice(0,10)))];
    }
    function renderAttendanceCards() {
      const container = document.getElementById("attendance-cards");

      // Filter records by selectedDateISO if set; else all jobs
      const filteredJobs = selectedDateISO
        ? jobs.filter(j => new Date(j.entryTime).toISOString().slice(0,10) === selectedDateISO)
        : jobs;

      if(filteredJobs.length === 0) {
        container.innerHTML = `<p style="color:#7a8bca99; text-align:center; margin-top: 0.7rem; user-select:none;">No attendance records found${selectedDateISO ? " for the selected date." : "."}</p>`;
        return;
      }

      container.innerHTML = filteredJobs.map((job, idx) => {
        const isCompleted = Boolean(job.exitPhoto);
        const statusDotClass = isCompleted ? "completed" : "pending";
        const entryDate = job.entryTime ? new Date(job.entryTime).toLocaleString() : "--";
        const exitDate = job.exitTime ? new Date(job.exitTime).toLocaleString() : "--";

        return `
          <article class="attendance-card" tabindex="0" aria-expanded="false" role="region" aria-label="Attendance entry at ${escapeHtml(job.place)}" data-index="${idx}">
            <div class="card-summary">
              <div class="card-left">
                <span class="status-dot ${statusDotClass}" aria-hidden="true"></span>
                <span class="card-place">${escapeHtml(job.place)}</span>
              </div>
              <span class="card-date">${entryDate.split(",")[0]}</span>
              <span class="expand-arrow" aria-hidden="true">&#9656;</span>
              <button class="btn btn-sm btn-danger delete-record-btn" style="min-width:64px; margin-left:12px;">Delete</button>
            </div>
            <div class="card-details" aria-hidden="true">
              <div class="photo-column" aria-label="Entry photo">
                <img src="${job.entryPhoto}" alt="Entry photo for ${escapeHtml(job.place)}" />
                <span class="photo-label">Entry</span>
              </div>
              ${isCompleted ? `
                <div class="photo-column" aria-label="Exit photo">
                  <img src="${job.exitPhoto}" alt="Exit photo for ${escapeHtml(job.place)}" />
                  <span class="photo-label">Exit</span>
                </div>` : ''}
              <div class="time-details">
                <div><span class="time-label">Entry:</span> <span>${entryDate}</span></div>
                ${isCompleted ? `<div><span class="time-label">Exit:</span> <span>${exitDate}</span></div>` : ''}
              </div>
            </div>
          </article>
        `;
      }).join("");

      attachExpandHandlers();
      attachDeleteHandlers();
    }

    function attachExpandHandlers() {
      $('.attendance-card').each(function() {
        const card = $(this);
        const summary = card.find('.card-summary');
        const details = card.find('.card-details');
        const arrow = card.find('.expand-arrow');

        function toggleExpand() {
          const expanded = card.hasClass('expanded');
          if(expanded){
            card.removeClass('expanded').attr('aria-expanded', 'false');
            details.attr('aria-hidden', 'true');
            arrow.html('&#9656;');
            card.css('transform', '');
          } else {
            $('.attendance-card.expanded').each(function(){
              $(this).removeClass('expanded').attr('aria-expanded', 'false').find('.card-details').attr('aria-hidden', 'true').end()
                .find('.expand-arrow').html('&#9656;').end().css('transform', '');
            });
            card.addClass('expanded').attr('aria-expanded', 'true');
            details.attr('aria-hidden', 'false');
            arrow.html('&#9662;');
            gsap.fromTo(card[0], { scale: 0.98 }, { scale: 1, duration: 0.4, ease: "elastic.out(1,0.8)" });
            card[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }
        summary.off('click').on('click', toggleExpand);
        card.off('keydown').on('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleExpand();
          }
        });
      });
    }

    function attachDeleteHandlers() {
      document.querySelectorAll('.delete-record-btn').forEach(button => {
        button.onclick = function(e) {
          e.stopPropagation();
          const card = this.closest('.attendance-card');
          const index = parseInt(card.getAttribute('data-index'), 10);
          if (confirm("Are you sure you want to delete this attendance record?")) {
            if (selectedDateISO) {
              // Find job in filtered and remove from original
              const filteredJobs = jobs.filter(j => new Date(j.entryTime).toISOString().slice(0,10) === selectedDateISO);
              const jobToDelete = filteredJobs[index];
              const jobIndex = jobs.indexOf(jobToDelete);
              if (jobIndex > -1) {
                jobs.splice(jobIndex, 1);
              }
            } else {
              jobs.splice(index, 1);
            }
            setJobs(jobs);
            renderAttendanceCards();
            updateCalendarHighlights();
          }
        };
      });
    }

    $('#open-calendar-btn').click(function(){
      $('#calendar-modal-overlay').fadeIn(150);
      gsap.fromTo('#calendar-modal-window', {scale: 0.85, opacity:0}, {scale: 1, opacity: 1, duration: 0.35, ease: "power2.out"});
      $(this).attr('aria-expanded', 'true');
    });
    $('#close-calendar-btn').click(closeCalendarModal);
    $('#calendar-modal-overlay').click(e=>{
      if(e.target === e.currentTarget) closeCalendarModal();
    });
    $(window).on('keydown', e=>{
      if(e.key === "Escape") closeCalendarModal();
    });
    function closeCalendarModal() {
      const btn = $('#open-calendar-btn');
      gsap.to('#calendar-modal-window', {scale: 0.9, opacity: 0, duration: 0.22, onComplete: () => {
        $('#calendar-modal-overlay').fadeOut(50);
        btn.attr('aria-expanded', 'false').focus();
      }});
    }

    function initCalendar(){
      window.myCalendar = new VanillaCalendar('#my-calendar', {
        settings: { lang: 'en', iso8601: true },
        selected: { dates: [] },
        datesFilter: jobDates().map(date => ({ date, selectable: true, class: 'has-entry' })),
        onSelect: (dates) => {
          selectedDateISO = dates[0];
          renderAttendanceCards();
          closeCalendarModal();
        },
        onReset: () => {
          selectedDateISO = null;
          renderAttendanceCards();
          closeCalendarModal();
        },
      });
      window.myCalendar.init();

      if(!document.querySelector('#vc-highlight-style')) {
        const style = document.createElement('style');
        style.id = 'vc-highlight-style';
        style.textContent = `.vanilla-calendar-day__btn.has-entry { background: #6b8fff !important; color:#fff !important; border-radius:50% !important; box-shadow: 0 0 12px #5b7fffcc !important;}`;
        document.head.appendChild(style);
      }
    }

    function showLiveUserOnMap(lat, lng, accuracy){
      userLat = lat; userLng = lng;
      if(!map) return;
      if(!userLiveMarker){
        userLiveMarker = new google.maps.Marker({
          map: map,
          position: { lat, lng },
          title: "Your Location",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 9,
            fillColor: "#5874f4",
            fillOpacity: 0.9,
            strokeColor: "#344fb7",
            strokeWeight: 2
          }
        });
      } else userLiveMarker.setPosition({lat, lng});
      if(!userAccuracyCircle){
        userAccuracyCircle = new google.maps.Circle({
          map: map,
          strokeColor: "#5874f4",
          strokeOpacity: 0.12,
          strokeWeight: 3,
          fillColor: "#5d7cfa",
          fillOpacity: 0.12,
          center: {lat, lng},
          radius: accuracy || 32
        });
      } else {
        userAccuracyCircle.setCenter({lat, lng});
        userAccuracyCircle.setRadius(accuracy || 32);
      }
      if(!hasCenteredToUser){
        map.setCenter({lat, lng});
        map.setZoom(Math.max(map.getZoom(), 16));
        hasCenteredToUser = true;
      }
    }

    function initMap(){
      const defaultCenter = { lat: 28.61, lng: 77.23 };
      const mapElement = document.getElementById('map');
      if (!mapElement) return;
      map = new google.maps.Map(mapElement, {
        center: defaultCenter,
        zoom: 12,
        fullscreenControl: true,
        streetViewControl: false
      });
      const input = document.getElementById('pac-input');
      const searchBox = new google.maps.places.SearchBox(input);
      map.addListener('bounds_changed', () => searchBox.setBounds(map.getBounds()));
      searchBox.addListener('places_changed', () => {
        const places = searchBox.getPlaces();
        if (!places || places.length === 0) {
          selectedPlace = null;
          if(marker) marker.setMap(null);
          marker = null;
          return;
        }
        selectedPlace = places[0];
        if(marker) marker.setMap(null);
        marker = new google.maps.Marker({
          map: map,
          position: selectedPlace.geometry.location,
          title: selectedPlace.name,
          animation: google.maps.Animation.DROP
        });
        map.panTo(selectedPlace.geometry.location);
        map.setZoom(Math.max(16, map.getZoom()));
        setTimeout(() => marker.setAnimation(null), 1200);
        showAlert('', false);
      });
      if(navigator.geolocation){
        navigator.geolocation.watchPosition(
          pos => showLiveUserOnMap(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
          () => showAlert("Enable location access for map features.", true),
          { enableHighAccuracy: true }
        );
      }
    }

    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2){
      const R = 6371e3;
      const toRad = d=>(d*Math.PI)/180;
      const dLat = toRad(lat2-lat1);
      const dLon= toRad(lon2-lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c= 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    let usingFrontCamera = false;
    let globalStream = null;
    function openCamera(type){
      $('#job-details').hide();
      $('#camera-section').show();
      $('#photo-preview').attr('src', '');
      function startCamera(){
        if(globalStream) globalStream.getTracks().forEach(t=>t.stop());
        const constraints = { video: { facingMode: usingFrontCamera ? 'user' : 'environment' } };
        navigator.mediaDevices.getUserMedia(constraints).then(stream => {
          globalStream = stream;
          const video = document.getElementById('video');
          video.srcObject = stream;
          video.play();
          gsap.fromTo("#video",{scale:1.03,opacity:0},{scale:1,opacity:1,duration:0.8,ease:"expo.out"});
          $('#snap-btn').off('click').on('click', () => {
            const canvas=document.getElementById('canvas');
            canvas.width=video.videoWidth;
            canvas.height=video.videoHeight;
            canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
            const imgData=canvas.toDataURL('image/png');
            $('#photo-preview').attr('src', imgData);
            stream.getTracks().forEach(t=>t.stop());
            gsap.fromTo('#photo-preview',{opacity:0,scale:0.95},{opacity:1,scale:1,duration:1,ease:'elastic.out(1,0.77)'});
            if(type==='entry') entryPhoto=imgData; else exitPhoto=imgData;
            setTimeout(()=>finishAttendance(type),700);
          });
        }).catch(()=> {
          showAlert("Camera access denied! Cannot capture photo.", true);
          $('#camera-section').hide();
          $('#job-details').show();
        });
      }
      startCamera();
      $('#flip-btn').off('click').on('click', () => {
        usingFrontCamera = !usingFrontCamera;
        startCamera();
      });
    }
    function finishAttendance(type){
      $('#camera-section').hide();
      $('#job-details').show();
      if(type==='entry'){
        entryTime = new Date().toLocaleString();
        jobs.unshift({
          place: selectedPlace?.name || "Unknown Place",
          entryTime,
          entryPhoto,
          exitTime: "",
          exitPhoto: "",
          status: "pending-exit"
        });
        setJobs(jobs);
        renderAttendanceCards();
        showAlert("Entry marked and photo captured.");
        updateCalendarHighlights();
        gsap.fromTo(".attendance-card",{scale:0.97},{scale:1,duration:0.7,ease:"elastic.out(1,0.75)"});
        entryPhoto = ""; entryTime = "";
        selectedPlace = null; $('#pac-input').val('');
        if(marker){marker.setMap(null); marker=null;}
      }
      else if(type==='exit'){
        exitTime = new Date().toLocaleString();
        for(let job of jobs){
          if(job.status==="pending-exit"){
            job.exitTime = exitTime;
            job.exitPhoto = exitPhoto;
            job.status = "completed";
            break;
          }
        }
        setJobs(jobs);
        renderAttendanceCards();
        showAlert("Exit marked and photo captured.");
        updateCalendarHighlights();
        gsap.fromTo(".attendance-card.expanded",{scale:1.01},{scale:1,duration:0.6,ease:"power3.out"});
        exitPhoto = ""; exitTime = "";
        selectedPlace = null; $('#pac-input').val('');
        if(marker){marker.setMap(null); marker=null;}
      }
    }
    $('#checkin-btn').click(() => {
      if(!selectedPlace){
        showAlert('Please select a place on the map.', true);
        return;
      }
      if(userLat === null || userLng === null){
        showAlert('Obtaining your locationâ€¦ please wait.', true);
        return;
      }
      let plat = selectedPlace.geometry.location.lat();
      let plng = selectedPlace.geometry.location.lng();
      let dist = getDistanceFromLatLonInMeters(userLat, userLng, plat, plng);
      if(dist <= 400) openCamera('entry');
      else showAlert(`Too far from selected site â€” ${Math.round(dist)}m away. Move closer to check in.`, true);
    });
    $('#checkout-btn').click(() => {
      if(!selectedPlace){
        showAlert('Please select a place on the map.', true);
        return;
      }
      if(!jobs.find(j => j.status === "pending-exit")){
        showAlert('You must mark entry before marking exit!', true);
        return;
      }
      if(userLat === null || userLng === null){
        showAlert('Obtaining your locationâ€¦ please wait.', true);
        return;
      }
      let plat = selectedPlace.geometry.location.lat();
      let plng = selectedPlace.geometry.location.lng();
      let dist = getDistanceFromLatLonInMeters(userLat, userLng, plat, plng);
      if(dist <= 400) openCamera('exit');
      else showAlert(`Too far from selected site â€” ${Math.round(dist)}m away. Move closer to check out.`, true);
    });
    window.onload = () => {
      initMap();
      renderAttendanceCards();
      initCalendar();
      updateCalendarHighlights();
    };
  </script>

</body>
</html>
